<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VistaGeomatics – Worksite Hazard Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --vista-blue: #165f7d;
      --vista-blue-light: #2a7fa3;
      --vista-blue-dark: #0b3045;
      --bg-body: #eef3f9;
      --bg-card: #ffffff;
      --border-soft: #d6e2f0;
      --text-main: #101827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top, #f4f8fc 0, #e4edf6 40%, #dde6f3 100%);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    .page-wrap {
      max-width: 1050px;
      margin: 0 auto;
    }

    .container {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 14px 30px rgba(5, 41, 66, 0.18), 0 0 0 1px rgba(5, 41, 66, 0.04);
      overflow: hidden;
      position: relative;
      margin-bottom: 18px;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(22,95,125,0.16), transparent 55%);
      opacity: 0.9;
    }

    .header-bar {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: linear-gradient(120deg, var(--vista-blue-light) 0%, var(--vista-blue) 40%, var(--vista-blue-dark) 100%);
      color: #fff;
    }

    .header-left h1 {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .header-left p {
      margin: 2px 0 0;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .header-logo {
      height: 60px;
      filter: drop-shadow(0 5px 14px rgba(0,0,0,0.35));
    }

    .page-title-bar {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 10px 20px 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.78), #f7faff);
    }

    .page-title-main {
      font-family: "Montserrat", sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--vista-blue-dark);
    }

    .page-title-sub {
      margin-top: 3px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .page-title-accent {
      width: 120px;
      height: 3px;
      margin: 8px auto 0;
      border-radius: 999px;
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      box-shadow: 0 0 8px rgba(46,167,224,0.65);
    }

    .page-body {
      position: relative;
      z-index: 1;
      padding: 10px 18px 14px;
      font-size: 0.8rem;
    }

    label {
      font-size: 0.78rem;
      font-weight: 600;
      display: block;
      margin-bottom: 2px;
      color: var(--text-main);
    }

    /* ===== INPUT/TEXT CLIPPING FIX (Safari/iPad + general) ===== */
    input[type="text"],
    input[type="date"],
    input[type="time"],
    textarea,
    .small-input {
      width: 100%;
      font-family: "Inter", sans-serif;
      font-size: 0.74rem;
      line-height: 1.25;
      color: var(--text-main);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      transition: 0.15s;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    .small-input {
      height: 34px;
      padding: 6px 8px;
      vertical-align: middle;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="date"],
    input[type="time"] {
      background-clip: padding-box;
    }

    textarea {
      padding: 6px 8px;
      min-height: 56px;
      resize: vertical;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--vista-blue-light);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(38,132,168,0.18);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .row > div {
      flex: 1;
      min-width: 150px;
    }

    .section-card {
      margin-top: 8px;
      padding: 8px 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, #fbfdff 0%, #f4f8fd 60%, #eff5fb 100%);
      box-shadow: 0 6px 16px rgba(5, 41, 66, 0.05);
      position: relative;
    }

    .section-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      border-radius: 12px 12px 0 0;
      background: linear-gradient(90deg, var(--vista-blue-light), var(--vista-blue-dark));
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 4px;
    }

    .section-title {
      font-weight: 600;
      font-size: 0.86rem;
      color: var(--vista-blue-dark);
      font-family: "Montserrat", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .section-note {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .inline-checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.76rem;
    }

    .inline-checkbox-group label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      margin-bottom: 0;
    }

    input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--vista-blue);
      margin: 0;
    }

    .small-text {
      font-size: 0.74rem;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    th, td {
      border: 1px solid var(--border-soft);
      padding: 3px 4px;
      vertical-align: top;
    }

    th {
      background: #e8f0fb;
      font-weight: 600;
      color: var(--vista-blue-dark);
    }

    td {
      background: #f9fbff;
    }

    .center { text-align: center; }

    .signature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .signature-box {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      padding: 6px;
      font-size: 0.78rem;
    }

    .signature-label {
      font-size: 0.74rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .signature-canvas {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      display: block;
      cursor: crosshair;
    }

    .signature-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .signature-actions button {
      padding: 3px 10px;
      font-size: 0.7rem;
      letter-spacing: 0.05em;
    }

    .signature-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .signature-row > div { flex: 1; }

    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      color: #fff;
      box-shadow: 0 8px 20px rgba(5, 41, 66, 0.35);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: var(--text-main);
      border: 1px solid #d6d7dd;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 9px 22px rgba(15, 23, 42, 0.18);
    }

    .control-text {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      padding: 6px 8px;
      line-height: 1.25;
      font-size: 0.74rem;
    }

    .risk-input,
    .risk-output {
      height: 32px !important;
      padding: 5px 6px !important;
      line-height: 1.2 !important;
      font-size: 0.74rem !important;
      text-align: center;
    }

    @media (max-width: 700px) {
      .header-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .page-title-main {
        font-size: 1.05rem;
        letter-spacing: 0.12em;
      }
    }
  </style>
</head>

<body>
<div class="page-wrap">
  <form id="hazardForm">
    <!-- PAGE 1 -->
    <div class="container" id="page1">
      <div class="header-bar">
        <div class="header-left">
          <h1>VISTAGEOMATICS</h1>
          <p>Worksite Hazard Assessment &amp; Tailgate Report</p>
        </div>
        <img src="vista-geomatics.png" alt="VistaGeomatics Logo" class="header-logo">
      </div>

      <div class="page-title-bar">
        <div class="page-title-main">Worksite Hazard Assessment</div>
        <div class="page-title-sub">Identify hazards and controls prior to commencing work.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <!-- General information -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">General Information</div>
          </div>
          <div class="row">
            <div>
              <label for="developed_by">Developed By</label>
              <input type="text" id="developed_by" name="developed_by">
            </div>
            <div>
              <label for="location">Location</label>
              <input type="text" id="location" name="location">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="date">Date</label>
              <input type="date" id="date" name="date">
            </div>
            <div>
              <label for="start_time">Start Time</label>
              <input type="time" id="start_time" name="start_time">
            </div>
            <div>
              <label for="completion_time">Form Completion Time</label>
              <input type="time" id="completion_time" name="completion_time">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="job_number">Job Number</label>
              <input type="text" id="job_number" name="job_number">
            </div>
            <div>
              <label for="description">Description of Work</label>
              <input type="text" id="description" name="description">
            </div>
          </div>
        </div>

        <!-- Tailgate meeting -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Tailgate Meeting Report</div>
            <div class="section-note">
              Complete daily prior to starting work and when procedures change or new hazards are present.
            </div>
          </div>
          <div style="margin-bottom:4px;">
            <label for="tailgate_minutes">Tailgate Minutes</label>
            <textarea id="tailgate_minutes" name="tailgate_minutes"></textarea>
          </div>

          <div class="row">
            <div style="flex:1;">
              <label>Site Sidewalk and Fencing Condition Report</label>
              <div class="inline-checkbox-group">
                <span>Did you drive on the sidewalk?</span>
                <label><input type="checkbox" name="sidewalk_yes"> Yes</label>
                <label><input type="checkbox" name="sidewalk_no"> No</label>
                <span>Fences Installed?</span>
                <label><input type="checkbox" name="fences_yes"> Yes</label>
                <label><input type="checkbox" name="fences_no"> No</label>
              </div>
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="sidewalk_comments">Comments</label>
            <textarea id="sidewalk_comments" name="sidewalk_comments"></textarea>
          </div>

          <div style="margin-top:4px;">
            <label>Pictures Taken:</label>
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="pic_site"> Site</label>
              <label><input type="checkbox" name="pic_sidewalk"> Sidewalk</label>
              <label><input type="checkbox" name="pic_fences"> Fences</label>
              <label><input type="checkbox" name="pic_hazards"> Hazards</label>
              <label>
                <input type="checkbox" name="pic_other"> Other (Describe):
                <input type="text" name="pic_other_desc" style="width:160px;">
              </label>
            </div>
          </div>
        </div>

        <!-- Working Alone -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Working Alone &amp; Check-in</div>
          </div>

          <div class="row">
            <div style="flex:1 1 35%;">
              <label>Working Alone</label>
              <div class="inline-checkbox-group">
                <label><input type="checkbox" name="working_alone_yes"> Yes</label>
                <label><input type="checkbox" name="working_alone_no"> No</label>
              </div>
            </div>
            <div style="flex:1 1 30%;">
              <label for="check_in_interval">Check-in Interval</label>
              <input type="text" id="check_in_interval" name="check_in_interval" placeholder="e.g., Hourly, Every 2 hours">
            </div>
            <div style="flex:1 1 30%;">
              <label for="communication_method">Communication Method</label>
              <input type="text" id="communication_method" name="communication_method" placeholder="e.g., Phone, Radio">
            </div>
          </div>

          <div class="row">
            <div style="flex:1 1 40%;">
              <label for="working_supervisor_name">Contact Procedures – Call Supervisor: Name</label>
              <input type="text" id="working_supervisor_name" name="working_supervisor_name">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_in_time">Check-in Time</label>
              <input type="time" id="check_in_time" name="check_in_time">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_out_time">Check-out Time</label>
              <input type="time" id="check_out_time" name="check_out_time">
            </div>
          </div>

          <div class="small-text" style="margin-top:4px;">
            <strong>Note:</strong> Check-in intervals are based on risk level –
            High risk: hourly, Medium risk: every 2 hours, Low risk: start and end of shift.
          </div>
        </div>

        <!-- Daily Equipment Inspection -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Daily Equipment Inspection</div>
            <div class="section-note">Check your vehicle, ATV, snowmobile, generator, trailer, and/or chainsaw and report any deficiencies.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Equipment</th>
              <th>Inspection Items</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>Vehicle</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="veh_tires"> Tires</label>
                  <label><input type="checkbox" name="veh_oil"> Oil</label>
                  <label><input type="checkbox" name="veh_fuel"> Fuel</label>
                  <label><input type="checkbox" name="veh_washer"> Washer fluid</label>
                  <label><input type="checkbox" name="veh_lights"> Lights</label>
                  <label><input type="checkbox" name="veh_tiedowns"> Tie-Down Straps</label>
                  <label>Other: <input type="text" name="veh_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>ATV / Snowmobile</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="atv_tires"> Tires/Track</label>
                  <label><input type="checkbox" name="atv_oil_fuel"> Oil/Fuel</label>
                  <label><input type="checkbox" name="atv_lights"> Lights</label>
                  <label><input type="checkbox" name="atv_brakes"> Brakes</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Generator</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="gen_oil"> Oil</label>
                  <label><input type="checkbox" name="gen_fuel"> Fuel</label>
                  <label><input type="checkbox" name="gen_cord"> Extension Cord</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Chainsaw (if used)</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="saw_oil"> Oil</label>
                  <label><input type="checkbox" name="saw_fuel"> Fuel</label>
                  <label><input type="checkbox" name="saw_chain"> Chain</label>
                  <label><input type="checkbox" name="saw_guard"> Guard</label>
                  <label>Other: <input type="text" name="saw_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Trailer</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="trl_tires"> Tires</label>
                  <label><input type="checkbox" name="trl_lights"> Lights</label>
                  <label><input type="checkbox" name="trl_chains"> Safety Chains</label>
                  <label><input type="checkbox" name="trl_deck"> Deck</label>
                  <label><input type="checkbox" name="trl_plate"> Licence Plate</label>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- PPE -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Personal Protective Equipment</div>
            <div class="section-note">Check off required PPE; report missing or worn items as needed.</div>
          </div>

          <div class="inline-checkbox-group">
            <label><input type="checkbox" name="ppe_hardhat"> Hardhat</label>
            <label><input type="checkbox" name="ppe_atv_helmet"> ATV Helmets</label>
            <label><input type="checkbox" name="ppe_signs"> Signs</label>
            <label><input type="checkbox" name="ppe_eye"> Eye Protection</label>
            <label><input type="checkbox" name="ppe_gloves"> Gloves</label>
            <label><input type="checkbox" name="ppe_csa_footwear"> CSA Approved Footwear</label>
            <label><input type="checkbox" name="ppe_winter"> Winter Clothing</label>
            <label><input type="checkbox" name="ppe_reflective"> Reflective Clothing</label>
            <label><input type="checkbox" name="ppe_frc"> Fire Retardant Coveralls</label>
            <label><input type="checkbox" name="ppe_hearing"> Hearing Protection</label>
            <label><input type="checkbox" name="ppe_chaps"> Chainsaw Pants/Chaps</label>
            <label><input type="checkbox" name="ppe_first_aid"> Personal First Aid Kit</label>
            <label><input type="checkbox" name="ppe_gas_monitor"> H2S, Methane, Oxygen, CO Monitor</label>
            <label>Other: <input type="text" name="ppe_other" style="width:160px;"></label>
          </div>
        </div>
      </div>
    </div>

    <!-- PAGE 2 -->
    <div class="container" id="page2">
      <div class="page-title-bar">
        <div class="page-title-main">Job Tasks, Hazards &amp; Controls</div>
        <div class="page-title-sub">Use F, S and P ratings to calculate risk for each task. Controls are auto-suggested from an embedded ruleset.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <div class="small-text" style="margin-bottom:4px;">
          Master Hazard Library (Google Drive):
          <a href="https://drive.google.com/REPLACE_WITH_YOUR_MASTER_HAZARD_LIST_URL" target="_blank" rel="noopener">
            Open master hazard list
          </a>
        </div>

        <!-- Common Occurring Hazards -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Common Occurring Hazards</div>
            <div class="section-note">Check all hazards that apply to today’s worksite. Unchecked rows will be removed from the PDF.</div>
          </div>

          <table id="commonHazardsTable">
            <thead>
            <tr>
              <th class="center">Applies</th>
              <th>Hazard</th>
              <th>Controls (from Worksite Hazard Assessment)</th>
            </tr>
            </thead>
            <tbody>
              <!-- (your rows unchanged) -->
              <!-- ... -->
            </tbody>
          </table>
        </div>

        <!-- Job Specific Hazards -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Job Specific Hazards</div>
            <div class="section-note">Hazard controls will auto-suggest from a simplified offline ruleset.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Job Tasks</th>
              <th>Hazards</th>
              <th class="center">F</th>
              <th class="center">S</th>
              <th class="center">P</th>
              <th class="center">R</th>
              <th>Control Plan / Barriers / Procedures</th>
            </tr>
            </thead>
            <tbody>
              <!-- (your 6 rows unchanged) -->
              <!-- ... -->
            </tbody>
          </table>
        </div>

        <!-- Risk Assessment Guide -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Risk Assessment Guide</div>
            <div class="section-note">Use these ratings when completing the Job Specific Hazards table.</div>
          </div>
          <!-- (unchanged) -->
        </div>

        <!-- Emergency Response -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Emergency Response Plan</div>
          </div>
          <!-- (unchanged) -->
        </div>

        <!-- Signatures -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Acknowledgement &amp; Sign-off</div>
          </div>

          <div class="signature-grid">
            <div class="signature-box">
              <div class="signature-label">Party Chief – Signature</div>
              <canvas id="pcSignature" class="signature-canvas"></canvas>
              <div class="signature-actions">
                <button type="button" class="btn-secondary" id="clearPcSig">Clear</button>
              </div>
              <div class="signature-row">
                <div>
                  <div class="signature-label">Name</div>
                  <input type="text" class="small-input" name="pc_name">
                </div>
                <div>
                  <div class="signature-label">Date</div>
                  <input type="text" class="small-input" name="pc_date" placeholder="YYYY-MM-DD">
                </div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Rodman – Signature</div>
              <canvas id="saSignature" class="signature-canvas"></canvas>
              <div class="signature-actions">
                <button type="button" class="btn-secondary" id="clearSaSig">Clear</button>
              </div>
              <div class="signature-row">
                <div>
                  <div class="signature-label">Name</div>
                  <input type="text" class="small-input" name="sa_name">
                </div>
                <div>
                  <div class="signature-label">Date</div>
                  <input type="text" class="small-input" name="sa_date" placeholder="YYYY-MM-DD">
                </div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Client Representative / Safety Coordinator / Additional Rodman – Signature</div>
              <canvas id="clientSignature" class="signature-canvas"></canvas>
              <div class="signature-actions">
                <button type="button" class="btn-secondary" id="clearClientSig">Clear</button>
              </div>
              <div class="signature-row">
                <div>
                  <div class="signature-label">Name</div>
                  <input type="text" class="small-input" name="client_name">
                </div>
                <div>
                  <div class="signature-label">Date</div>
                  <input type="text" class="small-input" name="client_date" placeholder="YYYY-MM-DD">
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:6px;">
            <label for="crew_contact">Crew Contact No.</label>
            <input type="text" id="crew_contact" name="crew_contact">
          </div>

          <div class="btn-row" id="buttonRow">
            <button type="reset" class="btn-secondary" id="resetBtn">Reset</button>
            <button type="button" class="btn-primary" id="downloadBtn">Download PDF</button>
            <button type="button" class="btn-secondary" id="shareBtn">Share PDF</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  const downloadBtn = document.getElementById('downloadBtn');
  const shareBtn    = document.getElementById('shareBtn');
  const buttonRow   = document.getElementById('buttonRow');

  // ============================================================================
  // FIX: Ensure Job Tasks / Hazards / F-S-P-R / Controls ALWAYS show in exported PDF
  // Works on iPads + PCs.
  //
  // Root cause: html2canvas often does NOT render live values for inputs/textareas
  // in a cloned DOM. Solution:
  //   1) Clone the form
  //   2) Copy ALL live values/checked states from the real form into the clone
  //   3) Copy signature canvas drawings into clone canvases
  //   4) Convert inputs/textareas in the clone into DIVs with the values (print-only)
  //   5) Then html2canvas captures the DIV text reliably.
  // ============================================================================

  function escapeText(str) {
    return (str || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function syncFormValues(srcRoot, dstRoot) {
    const srcFields = srcRoot.querySelectorAll('input, textarea, select');
    srcFields.forEach(src => {
      // Prefer name match, fall back to id
      let dst = null;
      const name = src.getAttribute('name');
      const id = src.getAttribute('id');

      if (name) dst = dstRoot.querySelector(`[name="${CSS.escape(name)}"]`);
      if (!dst && id) dst = dstRoot.querySelector(`#${CSS.escape(id)}`);
      if (!dst) return;

      const tag = src.tagName.toLowerCase();
      if (tag === 'textarea') {
        dst.value = src.value;
        // Also set innerHTML for some clone cases
        dst.textContent = src.value;
      } else if (tag === 'select') {
        dst.value = src.value;
      } else if (tag === 'input') {
        const type = (src.getAttribute('type') || 'text').toLowerCase();
        if (type === 'checkbox' || type === 'radio') {
          dst.checked = src.checked;
          if (src.checked) dst.setAttribute('checked', 'checked');
          else dst.removeAttribute('checked');
        } else {
          dst.value = src.value;
          dst.setAttribute('value', src.value);
        }
      }
    });
  }

  function syncCanvasDrawings(srcRoot, dstRoot) {
    const srcCanvases = srcRoot.querySelectorAll('canvas');
    srcCanvases.forEach(srcCanvas => {
      const id = srcCanvas.id;
      if (!id) return;
      const dstCanvas = dstRoot.querySelector(`#${CSS.escape(id)}`);
      if (!dstCanvas) return;

      // Match size then draw
      const w = srcCanvas.width;
      const h = srcCanvas.height;
      if (w && h) {
        dstCanvas.width = w;
        dstCanvas.height = h;
      }
      const dstCtx = dstCanvas.getContext('2d');
      dstCtx.clearRect(0, 0, dstCanvas.width, dstCanvas.height);
      dstCtx.drawImage(srcCanvas, 0, 0);
    });
  }

  function convertInteractiveElementsToPrint(rootEl) {
    // Convert text-like inputs + textareas to DIVs so html2canvas captures values
    const convertTextField = (el) => {
      const cs = window.getComputedStyle(el);
      const div = document.createElement('div');

      div.style.cssText = `
        width: ${cs.width};
        min-height: ${cs.height};
        padding: ${cs.padding};
        border: ${cs.border};
        border-radius: ${cs.borderRadius};
        background: ${cs.backgroundColor};
        font-family: ${cs.fontFamily};
        font-size: ${cs.fontSize};
        line-height: ${cs.lineHeight};
        color: ${cs.color};
        box-shadow: ${cs.boxShadow};
        white-space: pre-wrap;
        overflow-wrap: break-word;
      `;

      const val = (el.value ?? "").toString();
      div.innerHTML = escapeText(val);

      // Keep table cells tidy
      div.style.display = 'block';

      el.replaceWith(div);
    };

    const convertCheckbox = (el) => {
      const cs = window.getComputedStyle(el);
      const span = document.createElement('span');
      span.style.cssText = `
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: ${cs.width};
        height: ${cs.height};
        border: 1px solid rgba(15,23,42,0.35);
        border-radius: 3px;
        background: #fff;
        font-size: 12px;
        line-height: 1;
        color: #111827;
      `;
      span.textContent = el.checked ? '✓' : '';
      el.replaceWith(span);
    };

    // IMPORTANT: do conversions AFTER the clone is attached to DOM (so getComputedStyle works)
    const fields = rootEl.querySelectorAll('textarea, input, select');
    fields.forEach(el => {
      const tag = el.tagName.toLowerCase();
      if (tag === 'textarea') return convertTextField(el);

      if (tag === 'select') {
        // Convert select into text div using selected option
        const cs = window.getComputedStyle(el);
        const div = document.createElement('div');
        div.style.cssText = `
          width: ${cs.width};
          min-height: ${cs.height};
          padding: ${cs.padding};
          border: ${cs.border};
          border-radius: ${cs.borderRadius};
          background: ${cs.backgroundColor};
          font-family: ${cs.fontFamily};
          font-size: ${cs.fontSize};
          line-height: ${cs.lineHeight};
          color: ${cs.color};
          white-space: pre-wrap;
          overflow-wrap: break-word;
          display: block;
        `;
        const txt = el.options?.[el.selectedIndex]?.text || '';
        div.innerHTML = escapeText(txt);
        el.replaceWith(div);
        return;
      }

      if (tag === 'input') {
        const type = (el.getAttribute('type') || 'text').toLowerCase();
        if (type === 'checkbox' || type === 'radio') return convertCheckbox(el);
        return convertTextField(el);
      }
    });
  }

  // ======== PDF GENERATION (LEGAL SIZE, REMOVE UNCHECKED COMMON HAZARDS, NO BLANK SPACE, SHOW ALL INPUT VALUES) ========

  function createFilteredFormClone() {
    const form = document.getElementById('hazardForm');
    const clone = form.cloneNode(true);

    // 1) Copy live values/checked states from real form into clone
    syncFormValues(form, clone);

    // 2) Copy signature drawings into clone canvases
    syncCanvasDrawings(form, clone);

    // 3) Remove unchecked "Common Occurring Hazards" rows (based on synced checks)
    const commonTableBody = clone.querySelector('#commonHazardsTable tbody');
    if (commonTableBody) {
      Array.from(commonTableBody.rows).forEach(row => {
        const appliesCheckbox = row.querySelector('td:first-child input[type="checkbox"]');
        if (appliesCheckbox && !appliesCheckbox.checked) {
          commonTableBody.removeChild(row);
        }
      });

      commonTableBody.style.display = 'table-row-group';
      const tbl = commonTableBody.parentElement;
      tbl.style.height = 'auto';
      tbl.style.maxHeight = 'none';
      tbl.style.overflow = 'visible';
      void commonTableBody.offsetHeight;
    }

    // Remove buttons from clone
    const clonedButtonRow = clone.querySelector('#buttonRow');
    if (clonedButtonRow) clonedButtonRow.style.display = 'none';

    return clone;
  }

  async function generatePdf() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'legal');

    const clone = createFilteredFormClone();

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.style.width = '1050px';
    tempContainer.appendChild(clone);
    document.body.appendChild(tempContainer);

    // 4) Convert inputs/textareas to DIVs in the clone so html2canvas always captures values
    convertInteractiveElementsToPrint(tempContainer);

    const clonePage1 = clone.querySelector('#page1');
    const clonePage2 = clone.querySelector('#page2');

    async function addPage(div, addNew) {
      if (!div) return;
      if (addNew) pdf.addPage();

      const canvas = await html2canvas(div, {
        scale: 2,
        useCORS: true,
        scrollY: 0
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 8;

      let imgW = pageWidth - margin * 2;
      let imgH = canvas.height * (imgW / canvas.width);

      if (imgH > pageHeight - margin * 2) {
        imgH = pageHeight - margin * 2;
        imgW = canvas.width * (imgH / canvas.height);
      }

      const x = (pageWidth - imgW) / 2;
      const y = margin;

      pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH);
    }

    await addPage(clonePage1, false);
    await addPage(clonePage2, true);

    document.body.removeChild(tempContainer);
    return pdf;
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        pdf.save('WorksiteHazardAssessment.pdf');
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        const blob = pdf.output('blob');
        const file = new File([blob], 'WorksiteHazardAssessment.pdf', { type: 'application/pdf' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'Worksite Hazard Assessment',
            text: 'VistaGeomatics – Worksite Hazard Assessment PDF'
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'WorksiteHazardAssessment.pdf';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
      } catch (e) {
        console.error('Share failed:', e);
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }

  // ======== RISK CALC (R = F × S × P) ========

  function updateRiskForRow(row) {
    const fInput = document.querySelector('input[name="f_' + row + '"]');
    const sInput = document.querySelector('input[name="s_' + row + '"]');
    const pInput = document.querySelector('input[name="p_' + row + '"]');
    const rInput = document.querySelector('input[name="r_' + row + '"]');
    if (!fInput || !sInput || !pInput || !rInput) return;

    const f = parseInt(fInput.value, 10);
    const s = parseInt(sInput.value, 10);
    const p = parseInt(pInput.value, 10);

    if (Number.isInteger(f) && Number.isInteger(s) && Number.isInteger(p)) {
      rInput.value = f * s * p;
    } else {
      rInput.value = "";
    }
  }

  document.querySelectorAll('.risk-input').forEach(input => {
    input.addEventListener('input', () => {
      const row = input.getAttribute('data-row');
      if (row) updateRiskForRow(row);
    });
  });

  // ======== SIGNATURE PADS ========

  function initSignaturePad(canvasId, clearButtonId) {
    const canvas = document.getElementById(canvasId);
    const clearBtn = document.getElementById(clearButtonId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let drawing = false;
    let lastX = 0, lastY = 0;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width;
      tmp.height = canvas.height;
      tmp.getContext('2d').drawImage(canvas, 0, 0);

      canvas.width = rect.width;
      canvas.height = rect.height;

      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111827';

      // restore
      ctx.drawImage(tmp, 0, 0, canvas.width, canvas.height);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function startDraw(x, y) { drawing = true; lastX = x; lastY = y; }
    function drawLine(x, y) {
      if (!drawing) return;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x; lastY = y;
    }
    function endDraw() { drawing = false; }

    canvas.addEventListener('mousedown', e => {
      const rect = canvas.getBoundingClientRect();
      startDraw(e.clientX - rect.left, e.clientY - rect.top);
    });
    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      drawLine(e.clientX - rect.left, e.clientY - rect.top);
    });
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches[0];
      startDraw(touch.clientX - rect.left, touch.clientY - rect.top);
    }, { passive: false });

    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches[0];
      drawLine(touch.clientX - rect.left, touch.clientY - rect.top);
    }, { passive: false });

    canvas.addEventListener('touchend', e => {
      e.preventDefault();
      endDraw();
    }, { passive: false });

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
    }
  }

  initSignaturePad('pcSignature', 'clearPcSig');
  initSignaturePad('saSignature', 'clearSaSig');
  initSignaturePad('clientSignature', 'clearClientSig');

  const resetBtn = document.getElementById('resetBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      ['pcSignature','saSignature','clientSignature'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      });
      document.querySelectorAll('.risk-output').forEach(o => o.value = "");
    });
  }

  // ======== OFFLINE HAZARD RULE ENGINE – EXTENDED ========
  // (UNCHANGED from your code below)
  const DEFAULT_RULES = [
    /* your rules unchanged */
  ];

  const hazardRules = DEFAULT_RULES;

  function normalize(text) {
    return (text || '')
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function getSuggestionFromRules(hazardText) {
    const text = normalize(hazardText);
    if (!text) return '';

    let bestIndex = -1;
    let bestScore = 0;

    hazardRules.forEach((rule, index) => {
      const keywordsStr = rule.keywords || '';
      const keywords = keywordsStr.split(',').map(k => k.trim()).filter(Boolean);
      let score = 0;

      keywords.forEach(kw => {
        const normKw = normalize(kw);
        if (!normKw) return;

        if (text.includes(normKw)) {
          score += 4;
        } else {
          const parts = normKw.split(' ');
          parts.forEach(part => {
            if (part.length > 3 && text.includes(part)) score += 1;
          });
        }
      });

      if (score > bestScore) {
        bestScore = score;
        bestIndex = index;
      }
    });

    if (bestIndex >= 0 && bestScore > 0) return hazardRules[bestIndex].control || '';
    return '';
  }

  function initHazardAutoSuggest() {
    document.querySelectorAll('input[name^="hazard_"]').forEach(input => {
      input.addEventListener('blur', e => {
        const hazardText = e.target.value.trim();
        const parts = e.target.name.split('_');
        const row = parts[1];
        const controlField = document.querySelector(`textarea[name="control_${row}"]`);
        if (!controlField) return;

        if (!hazardText) {
          controlField.value = '';
          return;
        }

        if (controlField.value && controlField.value.length > 40) return;

        const suggestion = getSuggestionFromRules(hazardText);
        if (suggestion) controlField.value = suggestion;
      });

      input.addEventListener('input', e => {
        const value = e.target.value.trim();
        const parts = e.target.name.split('_');
        const row = parts[1];
        const controlField = document.querySelector(`textarea[name="control_${row}"]`);
        if (!controlField) return;

        if (!value) controlField.value = '';
      });
    });
  }

  initHazardAutoSuggest();
</script>
</body>
</html>
