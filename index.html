<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VistaGeomatics – Worksite Hazard Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --vista-blue: #165f7d;
      --vista-blue-light: #2a7fa3;
      --vista-blue-dark: #0b3045;
      --bg-body: #eef3f9;
      --bg-card: #ffffff;
      --border-soft: #d6e2f0;
      --text-main: #101827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top, #f4f8fc 0, #e4edf6 40%, #dde6f3 100%);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    .page-wrap { max-width: 1050px; margin: 0 auto; }

    .container {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 14px 30px rgba(5, 41, 66, 0.18), 0 0 0 1px rgba(5, 41, 66, 0.04);
      overflow: hidden;
      position: relative;
      margin-bottom: 18px;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(22,95,125,0.16), transparent 55%);
      opacity: 0.9;
    }

    .header-bar {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: linear-gradient(120deg, var(--vista-blue-light) 0%, var(--vista-blue) 40%, var(--vista-blue-dark) 100%);
      color: #fff;
    }

    .header-left h1 {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .header-left p { margin: 2px 0 0; font-size: 0.8rem; opacity: 0.9; }

    .header-logo { height: 60px; filter: drop-shadow(0 5px 14px rgba(0,0,0,0.35)); }

    .page-title-bar {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 10px 20px 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.78), #f7faff);
    }

    .page-title-main {
      font-family: "Montserrat", sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--vista-blue-dark);
    }

    .page-title-sub { margin-top: 3px; font-size: 0.78rem; color: var(--text-muted); }

    .page-title-accent {
      width: 120px;
      height: 3px;
      margin: 8px auto 0;
      border-radius: 999px;
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      box-shadow: 0 0 8px rgba(46,167,224,0.65);
    }

    .page-body { position: relative; z-index: 1; padding: 10px 18px 14px; font-size: 0.8rem; }

    label { font-size: 0.78rem; font-weight: 600; display: block; margin-bottom: 2px; color: var(--text-main); }

    input[type="text"], input[type="date"], input[type="time"], textarea, .small-input {
      width: 100%;
      font-family: "Inter", sans-serif;
      font-size: 0.74rem;
      line-height: 1.25;
      color: var(--text-main);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      transition: 0.15s;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="text"], input[type="date"], input[type="time"], .small-input {
      height: 34px;
      padding: 6px 8px;
      vertical-align: middle;
    }

    textarea { padding: 6px 8px; min-height: 56px; resize: vertical; }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--vista-blue-light);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(38,132,168,0.18);
    }

    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 4px; }
    .row > div { flex: 1; min-width: 150px; }

    .section-card {
      margin-top: 8px;
      padding: 8px 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, #fbfdff 0%, #f4f8fd 60%, #eff5fb 100%);
      box-shadow: 0 6px 16px rgba(5, 41, 66, 0.05);
      position: relative;
    }

    .section-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      border-radius: 12px 12px 0 0;
      background: linear-gradient(90deg, var(--vista-blue-light), var(--vista-blue-dark));
    }

    .section-header { display: flex; justify-content: space-between; align-items: baseline; gap: 6px; margin-bottom: 4px; }

    .section-title {
      font-weight: 600;
      font-size: 0.86rem;
      color: var(--vista-blue-dark);
      font-family: "Montserrat", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .section-note { font-size: 0.72rem; color: var(--text-muted); }

    .inline-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.76rem; align-items: center; }
    .inline-checkbox-group label { display: inline-flex; align-items: center; gap: 4px; font-weight: 500; margin-bottom: 0; }

    input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--vista-blue); margin: 0; }

    .small-text { font-size: 0.74rem; color: var(--text-muted); }

    table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 4px; }
    th, td { border: 1px solid var(--border-soft); padding: 3px 4px; vertical-align: top; }
    th { background: #e8f0fb; font-weight: 600; color: var(--vista-blue-dark); }
    td { background: #f9fbff; }
    .center { text-align: center; }

    .signature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; margin-top: 4px; }
    .signature-box { border-radius: 10px; border: 1px solid var(--border-soft); background: #f9fbff; padding: 6px; font-size: 0.78rem; }
    .signature-label { font-size: 0.74rem; font-weight: 600; color: var(--text-muted); margin-bottom: 2px; }

    .signature-canvas {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      display: block;
      cursor: crosshair;
    }

    .signature-actions { display: flex; justify-content: flex-end; margin-top: 4px; }
    .signature-actions button { padding: 3px 10px; font-size: 0.7rem; letter-spacing: 0.05em; }
    .signature-row { display: flex; gap: 6px; margin-top: 4px; }
    .signature-row > div { flex: 1; }

    .btn-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; margin-bottom: 4px; flex-wrap: wrap; }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      color: #fff;
      box-shadow: 0 8px 20px rgba(5, 41, 66, 0.35);
    }

    .btn-secondary { background: #f3f4f6; color: var(--text-main); border: 1px solid #d6d7dd; }

    button:hover { transform: translateY(-1px); box-shadow: 0 9px 22px rgba(15, 23, 42, 0.18); }

    .control-text {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      padding: 6px 8px;
      line-height: 1.25;
      font-size: 0.74rem;
      white-space: pre-wrap;
    }

    .risk-input, .risk-output {
      height: 32px !important;
      padding: 5px 6px !important;
      line-height: 1.2 !important;

      font-size: 0.74rem !important;
      text-align: center;
    }

    .version-stamp{
      position: fixed;
      right: 14px;
      bottom: 10px;
      z-index: 50;
      font-family: "Inter", sans-serif;
      font-size: 0.68rem;
      letter-spacing: 0.06em;
      color: rgba(16,24,39,0.75);
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(214,226,240,0.9);
      padding: 4px 10px;
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(5,41,66,0.08);
      backdrop-filter: blur(4px);
    }

    @media (max-width: 700px) {
      .header-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
      .page-title-main { font-size: 1.05rem; letter-spacing: 0.12em; }
    }
  </style>
</head>

<body>
<div class="page-wrap">
  <form id="hazardForm">
    <!-- PAGE 1 -->
    <div class="container" id="page1">
      <div class="header-bar">
        <div class="header-left">
          <h1>VISTAGEOMATICS</h1>
          <p>Worksite Hazard Assessment &amp; Tailgate Report</p>
        </div>
        <img src="vista-geomatics.png" alt="VistaGeomatics Logo" class="header-logo">
      </div>

      <div class="page-title-bar">
        <div class="page-title-main">Worksite Hazard Assessment</div>
        <div class="page-title-sub">Identify hazards and controls prior to commencing work.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">General Information</div>
          </div>
          <div class="row">
            <div>
              <label for="developed_by">Developed By</label>
              <input type="text" id="developed_by" name="developed_by">
            </div>
            <div>
              <label for="location">Location</label>
              <input type="text" id="location" name="location">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="date">Date</label>
              <input type="date" id="date" name="date">
            </div>
            <div>
              <label for="start_time">Start Time</label>
              <input type="time" id="start_time" name="start_time">
            </div>
            <div>
              <label for="completion_time">Form Completion Time</label>
              <input type="time" id="completion_time" name="completion_time">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="job_number">Job Number</label>
              <input type="text" id="job_number" name="job_number">
            </div>
            <div>
              <label for="description">Description of Work</label>
              <input type="text" id="description" name="description">
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Tailgate Meeting Report</div>
            <div class="section-note">Complete daily prior to starting work and when procedures change or new hazards are present.</div>
          </div>
          <div style="margin-bottom:4px;">
            <label for="tailgate_minutes">Tailgate Minutes</label>
            <textarea id="tailgate_minutes" name="tailgate_minutes"></textarea>
          </div>

          <div class="row">
            <div style="flex:1;">
              <label>Site Sidewalk and Fencing Condition Report</label>
              <div class="inline-checkbox-group">
                <span>Did you drive on the sidewalk?</span>
                <label><input type="checkbox" name="sidewalk_yes"> Yes</label>
                <label><input type="checkbox" name="sidewalk_no"> No</label>
                <span>Fences Installed?</span>
                <label><input type="checkbox" name="fences_yes"> Yes</label>
                <label><input type="checkbox" name="fences_no"> No</label>
              </div>
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="sidewalk_comments">Comments</label>
            <textarea id="sidewalk_comments" name="sidewalk_comments"></textarea>
          </div>

          <div style="margin-top:4px;">
            <label>Pictures Taken:</label>
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="pic_site"> Site</label>
              <label><input type="checkbox" name="pic_sidewalk"> Sidewalk</label>
              <label><input type="checkbox" name="pic_fences"> Fences</label>
              <label><input type="checkbox" name="pic_hazards"> Hazards</label>
              <label>
                <input type="checkbox" name="pic_other"> Other (Describe):
                <input type="text" name="pic_other_desc" style="width:160px;">
              </label>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Working Alone &amp; Check-in</div>
          </div>

          <div class="row">
            <div style="flex:1 1 35%;">
              <label>Working Alone</label>
              <div class="inline-checkbox-group">
                <label><input type="checkbox" name="working_alone_yes"> Yes</label>
                <label><input type="checkbox" name="working_alone_no"> No</label>
              </div>
            </div>
            <div style="flex:1 1 30%;">
              <label for="check_in_interval">Check-in Interval</label>
              <input type="text" id="check_in_interval" name="check_in_interval" placeholder="e.g., Hourly, Every 2 hours">
            </div>
            <div style="flex:1 1 30%;">
              <label for="communication_method">Communication Method</label>
              <input type="text" id="communication_method" name="communication_method" placeholder="e.g., Phone, Radio">
            </div>
          </div>

          <div class="row">
            <div style="flex:1 1 40%;">
              <label for="working_supervisor_name">Contact Procedures – Call Supervisor: Name</label>
              <input type="text" id="working_supervisor_name" name="working_supervisor_name">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_in_time">Check-in Time</label>
              <input type="time" id="check_in_time" name="check_in_time">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_out_time">Check-out Time</label>
              <input type="time" id="check_out_time" name="check_out_time">
            </div>
          </div>

          <div class="small-text" style="margin-top:4px;">
            <strong>Note:</strong> Check-in intervals are based on risk level,
            High risk: hourly, Medium risk: every 2 hours, Low risk: start and end of shift.
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Daily Equipment Inspection</div>
            <div class="section-note">Check your vehicle, ATV, snowmobile, generator, trailer, and/or chainsaw and report any deficiencies.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Equipment</th>
              <th>Inspection Items</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>Vehicle</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="veh_tires"> Tires</label>
                  <label><input type="checkbox" name="veh_oil"> Oil</label>
                  <label><input type="checkbox" name="veh_fuel"> Fuel</label>
                  <label><input type="checkbox" name="veh_washer"> Washer fluid</label>
                  <label><input type="checkbox" name="veh_lights"> Lights</label>
                  <label><input type="checkbox" name="veh_tiedowns"> Tie-Down Straps</label>
                  <label>Other: <input type="text" name="veh_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>ATV / Snowmobile</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="atv_tires"> Tires/Track</label>
                  <label><input type="checkbox" name="atv_oil_fuel"> Oil/Fuel</label>
                  <label><input type="checkbox" name="atv_lights"> Lights</label>
                  <label><input type="checkbox" name="atv_brakes"> Brakes</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Generator</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="gen_oil"> Oil</label>
                  <label><input type="checkbox" name="gen_fuel"> Fuel</label>
                  <label><input type="checkbox" name="gen_cord"> Extension Cord</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Chainsaw (if used)</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="saw_oil"> Oil</label>
                  <label><input type="checkbox" name="saw_fuel"> Fuel</label>
                  <label><input type="checkbox" name="saw_chain"> Chain</label>
                  <label><input type="checkbox" name="saw_guard"> Guard</label>
                  <label>Other: <input type="text" name="saw_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Trailer</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="trl_tires"> Tires</label>
                  <label><input type="checkbox" name="trl_lights"> Lights</label>
                  <label><input type="checkbox" name="trl_chains"> Safety Chains</label>
                  <label><input type="checkbox" name="trl_deck"> Deck</label>
                  <label><input type="checkbox" name="trl_plate"> Licence Plate</label>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Personal Protective Equipment</div>
            <div class="section-note">Check off required PPE; report missing or worn items as needed.</div>
          </div>

          <div class="inline-checkbox-group">
            <label><input type="checkbox" name="ppe_hardhat"> Hardhat</label>
            <label><input type="checkbox" name="ppe_atv_helmet"> ATV Helmets</label>
            <label><input type="checkbox" name="ppe_signs"> Signs</label>
            <label><input type="checkbox" name="ppe_eye"> Eye Protection</label>
            <label><input type="checkbox" name="ppe_gloves"> Gloves</label>
            <label><input type="checkbox" name="ppe_csa_footwear"> CSA Approved Footwear</label>
            <label><input type="checkbox" name="ppe_winter"> Winter Clothing</label>
            <label><input type="checkbox" name="ppe_reflective"> Reflective Clothing</label>
            <label><input type="checkbox" name="ppe_frc"> Fire Retardant Coveralls</label>
            <label><input type="checkbox" name="ppe_hearing"> Hearing Protection</label>
            <label><input type="checkbox" name="ppe_chaps"> Chainsaw Pants/Chaps</label>
            <label><input type="checkbox" name="ppe_first_aid"> Personal First Aid Kit</label>
            <label><input type="checkbox" name="ppe_gas_monitor"> H2S, Methane, Oxygen, CO Monitor</label>
            <label>Other: <input type="text" name="ppe_other" style="width:160px;"></label>
          </div>


        </div>
      </div>
    </div>

    <!-- PAGE 2 -->
    <div class="container" id="page2">
      <div class="page-title-bar">
        <div class="page-title-main">Job Tasks, Hazards &amp; Controls</div>
        <div class="page-title-sub">Controls and ratings auto-suggest from an embedded offline ruleset.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Common Occurring Hazards</div>
            <div class="section-note">Unchecked rows will be removed from the PDF.</div>
          </div>

          <table id="commonHazardsTable">
            <thead>
            <tr>
              <th class="center">Applies</th>
              <th>Hazard</th>
              <th>Controls (from Worksite Hazard Assessment)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td class="center"><input type="checkbox" name="haz_buried_overhead"></td>
              <td>Buried or Overhead Facilities</td>
              <td>Use caution near facilities. Maintain safe approach limits. Report damage immediately. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_hunting"></td>
              <td>Hunting Season</td>
              <td>Know season and areas, stay together, make noise. If hunters seen, advise presence. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_housekeeping"></td>
              <td>Site Housekeeping</td>
              <td>Keep areas clean and clear of obstructions. Remove trip hazards promptly. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_h2s"></td>
              <td>H2S Concerns</td>
              <td>Only work where trained. Use gas monitor, follow SWP, and use respiratory protection if required.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_open_excavation"></td>
              <td>Open Excavation</td>
              <td>Stay back from edges. Cross only at safe points. Never jump trenches. Wear hard hat and boots.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_fences"></td>
              <td>Construction Fences – Installed</td>
              <td>Use crossings, avoid fence bases, and adjust panels slowly. Keep clear in wind and when moving panels.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wild_animals"></td>
              <td>Wild Animals</td>
              <td>Stay alert, do not approach wildlife. Carry bear spray where applicable. Secure food and garbage.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_river"></td>
              <td>River: High/Low Spring Flood</td>
              <td>Keep distance from banks. Use safe crossing points or alternate routes. Stop if conditions worsen.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_traffic"></td>
              <td>On and Off Traffic or Construction</td>
              <td>Stay visible and alert. Use spotter and eye contact. Keep setups away from travel paths. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_icy"></td>
              <td>Icy Conditions</td>
              <td>Slow down and use slip-resistant footwear. Keep hands free. Reduce driving speed and increase distance.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_noise"></td>
              <td>Excessive Noise Levels</td>
              <td>Limit exposure, use hearing protection, and set clear communication methods. Stay aware of surroundings.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wildfire"></td>
              <td>Wild Fire Hazard – Fire Ban in Effect</td>
              <td>Follow fire-ban rules. Avoid ignition sources near dry grass. Keep extinguisher ready and inspected.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_farming"></td>
              <td>Farming Operations (cattle or other animals)</td>
              <td>Make presence known, keep distance from livestock, and avoid flagging in pastures. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_landowner"></td>
              <td>Land Owner / Home Owner – Made Contact</td>
              <td>Stay calm, listen respectfully, explain work, and leave if escalating. Report to supervisor and client.</td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Job Specific Hazards</div>
            <div class="section-note">Controls and ratings auto-suggest when you leave the hazard cell.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Job Tasks</th>
              <th>Hazards</th>
              <th class="center">F</th>
              <th class="center">S</th>
              <th class="center">P</th>
              <th class="center">R</th>
              <th>Control Plan / Barriers / Procedures</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td><input type="text" name="task_1" /></td>
              <td><input type="text" name="hazard_1" placeholder="e.g. dog, traffic, construction fencing, digging, generator" /></td>
              <td class="center"><input type="text" name="f_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_1" class="risk-output" data-row="1" style="width:40px;" readonly></td>
              <td><textarea name="control_1" class="control-text" placeholder="Controls auto-suggest when you leave the hazard cell."></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_2" /></td>
              <td><input type="text" name="hazard_2" /></td>
              <td class="center"><input type="text" name="f_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_2" class="risk-output" data-row="2" style="width:40px;" readonly></td>
              <td><textarea name="control_2" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_3" /></td>
              <td><input type="text" name="hazard_3" /></td>
              <td class="center"><input type="text" name="f_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_3" class="risk-output" data-row="3" style="width:40px;" readonly></td>
              <td><textarea name="control_3" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_4" /></td>
              <td><input type="text" name="hazard_4" /></td>
              <td class="center"><input type="text" name="f_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_4" class="risk-output" data-row="4" style="width:40px;" readonly></td>
              <td><textarea name="control_4" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_5" /></td>
              <td><input type="text" name="hazard_5" /></td>
              <td class="center"><input type="text" name="f_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_5" class="risk-output" data-row="5" style="width:40px;" readonly></td>
              <td><textarea name="control_5" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_6" /></td>
              <td><input type="text" name="hazard_6" /></td>
              <td class="center"><input type="text" name="f_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_6" class="risk-output" data-row="6" style="width:40px;" readonly></td>
              <td><textarea name="control_6" class="control-text"></textarea></td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Emergency Response Plan</div>
            <div class="section-note">Type facility name or acronym (e.g., FMC, SHC, CUCC) and select from list.</div>
          </div>

          <div class="row">
            <div>
              <label for="nearest_hospital">Nearest first aid facility or hospital</label>
              <input type="text" id="nearest_hospital" name="nearest_hospital" list="facilityList" placeholder="Start typing facility name or abbreviation">
              <datalist id="facilityList"></datalist>
            </div>
            <div>
              <label for="hospital_phone">Phone #</label>
              <input type="text" id="hospital_phone" name="hospital_phone">
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="emergency_procedures">Emergency Response Procedures</label>
            <textarea id="emergency_procedures" name="emergency_procedures"></textarea>
          </div>

          <div style="margin-top:4px;">
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="first_aid_available"> First Aid Kit Available</label>
              <label><input type="checkbox" name="fire_ext_available"> Fire Extinguisher Available</label>
              <label><input type="checkbox" name="effective_comm"> Effective Method of Communication Available</label>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Acknowledgement &amp; Sign-off</div>
          </div>

          <div class="signature-grid">
            <div class="signature-box">
              <div class="signature-label">Party Chief – Signature</div>
              <canvas id="pcSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearPcSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="pc_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="pc_date"></div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Rodman – Signature</div>
              <canvas id="saSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearSaSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="sa_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="sa_date"></div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Client Rep / Safety Coordinator / Additional Rodman – Signature</div>
              <canvas id="clientSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearClientSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="client_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="client_date"></div>
              </div>
            </div>
          </div>

          <div style="margin-top:6px;">
            <label for="crew_contact">Crew Contact No.</label>
            <input type="text" id="crew_contact" name="crew_contact">
          </div>

          <div class="btn-row" id="buttonRow">
            <button type="reset" class="btn-secondary" id="resetBtn">Reset</button>
            <button type="button" class="btn-secondary" id="nameBtn">Name File</button>
            <button type="button" class="btn-primary" id="downloadBtn">Download PDF</button>
            <button type="button" class="btn-secondary" id="shareBtn">Share PDF</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="version-stamp" id="versionStamp">v3.3</div>

<!-- OFFLINE NOTE:
     Put these files beside this HTML for offline use:
     ./jspdf.umd.min.js
     ./html2canvas.min.js
-->
<script src="./jspdf.umd.min.js"></script>
<script src="./html2canvas.min.js"></script>

<script>
  // ============================================================
  // BASIC UTIL
  // ============================================================
  const downloadBtn = document.getElementById('downloadBtn');
  const shareBtn    = document.getElementById('shareBtn');
  const nameBtn     = document.getElementById('nameBtn');
  const buttonRow   = document.getElementById('buttonRow');

  let userChosenFileName = "";

  function safeFilePart(s) {
    return (s || "")
      .toString()
      .trim()
      .replace(/[\\/:*?"<>|]+/g, "")
      .replace(/\s+/g, "_")
      .slice(0, 60);
  }

  function yyyyMmDd(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function getDefaultFileName() {
    const job = safeFilePart(document.getElementById("job_number")?.value);
    const dev = safeFilePart(document.getElementById("developed_by")?.value);
    const today = yyyyMmDd(new Date());
    const parts = [job || "Job", dev || "DevelopedBy", today];
    return parts.filter(Boolean).join("_") + ".pdf";
  }

  function getFinalFileName() {
    const base = (userChosenFileName || "").trim();
    if (base) {
      const cleaned = safeFilePart(base).replace(/\.pdf$/i, "");
      return (cleaned || "WorksiteHazardAssessment") + ".pdf";
    }
    return getDefaultFileName();
  }

  if (nameBtn) {
    nameBtn.addEventListener("click", () => {
      const suggested = getDefaultFileName().replace(/\.pdf$/i, "");
      const input = prompt("Name the PDF file (without .pdf):", userChosenFileName || suggested);
      if (input === null) return;
      userChosenFileName = input.trim();
    });
  }

  // ============================================================
  // RISK CALC (R = F × S × P)
  // ============================================================
  function updateRiskForRow(row) {
    const fInput = document.querySelector('input[name="f_' + row + '"]');
    const sInput = document.querySelector('input[name="s_' + row + '"]');
    const pInput = document.querySelector('input[name="p_' + row + '"]');
    const rInput = document.querySelector('input[name="r_' + row + '"]');
    if (!fInput || !sInput || !pInput || !rInput) return;

    const f = parseInt(fInput.value, 10);
    const s = parseInt(sInput.value, 10);
    const p = parseInt(pInput.value, 10);

    if (Number.isInteger(f) && Number.isInteger(s) && Number.isInteger(p)) rInput.value = f * s * p;
    else rInput.value = "";
  }

  document.querySelectorAll('.risk-input').forEach(input => {
    input.addEventListener('input', () => {
      const row = input.getAttribute('data-row');
      if (row) updateRiskForRow(row);
    });
  });

  // ============================================================
  // SIGNATURE PADS
  // ============================================================
  function initSignaturePad(canvasId, clearButtonId) {
    const canvas = document.getElementById(canvasId);
    const clearBtn = document.getElementById(clearButtonId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let drawing = false, lastX = 0, lastY = 0;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111827';
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      const isTouch = evt.touches && evt.touches[0];
      const clientX = isTouch ? evt.touches[0].clientX : evt.clientX;
      const clientY = isTouch ? evt.touches[0].clientY : evt.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(evt) { drawing = true; const p = getPos(evt); lastX = p.x; lastY = p.y; }
    function drawLine(evt) {
      if (!drawing) return;
      const p = getPos(evt);
      ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.stroke();
      lastX = p.x; lastY = p.y;
    }
    function endDraw() { drawing = false; }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', drawLine);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e); }, { passive: false });
    canvas.addEventListener('touchmove',  e => { e.preventDefault(); drawLine(e); }, { passive: false });
    canvas.addEventListener('touchend',   e => { e.preventDefault(); endDraw(); }, { passive: false });

    if (clearBtn) clearBtn.addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
  }

  initSignaturePad('pcSignature', 'clearPcSig');
  initSignaturePad('saSignature', 'clearSaSig');
  initSignaturePad('clientSignature', 'clearClientSig');

  const resetBtn = document.getElementById('resetBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      ['pcSignature','saSignature','clientSignature'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
      });
      document.querySelectorAll('.risk-output').forEach(o => o.value = "");
      userChosenFileName = "";
      clearEmergencyAutofill();
    });
  }

  // ============================================================
  // MEDICAL FACILITIES (FULL LIST)
  // ============================================================
  const MEDICAL_FACILITIES = [
    { name:"Foothills Medical Centre", abbr:"FMC", type:"Hospital", address:"1403 29 St NW, Calgary, AB, T2N 2T9" },
    { name:"Alberta Children's Hospital", abbr:"ACH", type:"Hospital", address:"28 Oki Dr NW, Calgary, AB, T3B 6A8" },
    { name:"Peter Lougheed Centre", abbr:"PLC", type:"Hospital", address:"3500 26 Ave NE, Calgary, AB, T1Y 6J4" },
    { name:"Rockyview General Hospital", abbr:"RGH", type:"Hospital", address:"7007 14 St SW, Calgary, AB, T2V 1P9" },
    { name:"South Health Campus", abbr:"SHC", type:"Hospital", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },
    { name:"Royal Alexandra Hospital", abbr:"RAH", type:"Hospital", address:"10240 Kingsway NW, Edmonton, AB, T5H 3V9" },
    { name:"University of Alberta Hospital", abbr:"UAH", type:"Hospital", address:"8440 112 St NW, Edmonton, AB, T6G 2B7" },
    { name:"Misericordia Community Hospital", abbr:"MCH", type:"Hospital", address:"16940 87 Ave NW, Edmonton, AB, T5R 4H5" },
    { name:"Grey Nuns Community Hospital", abbr:"GNH", type:"Hospital", address:"1100 Youville Dr W, Edmonton, AB, T6L 5X8" },
    { name:"Red Deer Regional Hospital Centre", abbr:"RDRHC", type:"Hospital", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Chinook Regional Hospital", abbr:"CRH", type:"Hospital", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Medicine Hat Regional Hospital", abbr:"MHRH", type:"Hospital", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Northern Lights Regional Health Centre", abbr:"NLRHC", type:"Hospital", address:"7 Hospital St, Fort McMurray, AB, T9H 1P2" },
    { name:"Grande Prairie Regional Hospital", abbr:"GPRH", type:"Hospital", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },
    { name:"Airdrie Community Health Centre", abbr:"ACHC", type:"Community Health Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"Drumheller Health Centre", abbr:"DHC", type:"Community Health Centre", address:"351 9 St NW, Drumheller, AB, T0J 0Y1" },
    { name:"Brooks Health Centre", abbr:"BHC", type:"Community Health Centre", address:"440 3 St E, Brooks, AB, T1R 0G8" },
    { name:"Strathmore District Health Services", abbr:"SDHS", type:"Community Health Centre", address:"200 Brent Blvd, Strathmore, AB, T1P 1J9" },
    { name:"Banff Mineral Springs Hospital", abbr:"BMSH", type:"Hospital", address:"305 Lynx St, Banff, AB, T1L 1C1" },
    { name:"Canmore General Hospital", abbr:"CGH", type:"Hospital", address:"1100 Hospital Pl, Canmore, AB, T1W 1N2" },
    { name:"Airdrie Urgent Care Centre", abbr:"AUCC", type:"Urgent Care Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"South Calgary Urgent Care Centre", abbr:"SCUC", type:"Urgent Care Centre", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },
    { name:"North Edmonton Urgent Care Centre", abbr:"NEDUCC", type:"Urgent Care Centre", address:"13403 97 St NW, Edmonton, AB, T5E 4L8" },
    { name:"West Edmonton Urgent Care Centre", abbr:"WEUCC", type:"Urgent Care Centre", address:"1815 102 St NW, Edmonton, AB, T6J 4S5" },
    { name:"Northeast Edmonton Urgent Care Centre", abbr:"NEEUCC", type:"Urgent Care Centre", address:"7911 137 Ave NW, Edmonton, AB, T5C 0K9" },
    { name:"Red Deer Urgent Care Centre", abbr:"RDUCC", type:"Urgent Care Centre", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Medicine Hat Urgent Care Centre", abbr:"MHUCC", type:"Urgent Care Centre", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Grande Prairie Urgent Care Centre", abbr:"GPUCC", type:"Urgent Care Centre", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },
    { name:"Lethbridge Urgent Care Centre", abbr:"LHUCC", type:"Urgent Care Centre", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Cochrane Urgent Care Centre", abbr:"CUCC", type:"Urgent Care Centre", address:"60 Grande Blvd, Cochrane, AB, T4C 0S4" }
  ];

  const facilityInput = document.getElementById("nearest_hospital");
  const facilityList  = document.getElementById("facilityList");
  const phoneInput    = document.getElementById("hospital_phone");
  const erTextarea    = document.getElementById("emergency_procedures");

  function normalizeFacilityKey(s) {
    return (s || "").toString().trim().toLowerCase().replace(/\s+/g, " ");
  }

  function fillFacilityDatalist() {
    if (!facilityList) return;
    facilityList.innerHTML = "";
    MEDICAL_FACILITIES.forEach(f => {
      const optName = document.createElement("option");
      optName.value = f.name;
      optName.label = `${f.abbr} – ${f.type}`;
      facilityList.appendChild(optName);

      const optAbbr = document.createElement("option");
      optAbbr.value = f.abbr;
      optAbbr.label = f.name;
      facilityList.appendChild(optAbbr);
    });
  }
  fillFacilityDatalist();

  function findFacility(query) {
    const q = normalizeFacilityKey(query);
    if (!q) return null;

    let f = MEDICAL_FACILITIES.find(x => normalizeFacilityKey(x.abbr) === q);
    if (f) return f;

    f = MEDICAL_FACILITIES.find(x => normalizeFacilityKey(x.name) === q);
    if (f) return f;

    if (q.length >= 3) {
      f = MEDICAL_FACILITIES.find(x => normalizeFacilityKey(x.name).startsWith(q));
      if (f) return f;
    }

    return null;
  }

  function setEmergencyAutofill(facility) {
    if (!facility) return;
    const current = normalizeFacilityKey(facilityInput.value);
    if (current === normalizeFacilityKey(facility.abbr)) facilityInput.value = facility.name;

    phoneInput.value = "911";
    erTextarea.value =
      `Ensure your safety and move to a secure area. Call 911 for emergencies and, if needed, go to ${facility.name}, ${facility.address} for medical attention. Report the incident to your supervisor as soon as it’s safe and complete an incident report.`;
  }

  function clearEmergencyAutofill() {
    if (phoneInput) phoneInput.value = "";
    if (erTextarea) erTextarea.value = "";
  }

  if (facilityInput) {
    const handler = () => {
      const val = (facilityInput.value || "").trim();
      if (!val) { clearEmergencyAutofill(); return; }
      const match = findFacility(val);
      if (match) setEmergencyAutofill(match);
    };

    facilityInput.addEventListener("input", handler);
    facilityInput.addEventListener("change", handler);
    facilityInput.addEventListener("blur", handler);

    facilityInput.addEventListener("input", () => {
      if (!facilityInput.value.trim()) clearEmergencyAutofill();
    });
  }

  // ============================================================
  // HAZARD LIBRARY (OFFLINE, SELF-CONTAINED)
  // - Each entry has: name, keywords (string or array), risk{F,S,P,R}, controls[2]
  // - Controls are clipped to keep export tidy
  // ============================================================

  const HAZARD_LIBRARY = [
    {
      name: "Employees not fit for duty",
      keywords: "employee,employees,fit,fits,duty,duties,fitness,drug,drugs,alcohol,fatigue,policy,impairment,employees not fit for duty",
      risk: { F: 1, S: 5, P: 1, R: 5 },
      controls: [
        "Follow Vista Geomatics drug and alcohol policy and Fatigue Management Program, report unfit-for-duty concerns immediately.",
        "Verify fitness before starting work, monitor for impairment, and use Stop Work Authority if anyone is unfit or unsafe."
      ]
    },
    {
       "name": "Unsuitable PPE",
    "keywords": "ppe,ppes,unsuitable,unsuitables,glasses,glass,hard hat,hard hats,boots,boot,steel toe,steel toes,vest,vests,hi vis,high visibility,CSA,CSAs,unsuitable PPE",
    "risk": { "F": 2, "S": 3, "P": 2, "R": 5 },
    "controls": [
      "Wear required CSA PPE, safety glasses, hard hat, 6 in steel-toe boots, and reflective survey vest or jacket before starting work.",
      "Inspect PPE for damage and fit, replace defective items, and confirm site-specific PPE requirements during the pre-job review."
    ]
  },
  {
    "name": "Overall Workplace Safety",
    "keywords": "safety,safeties,workplace,workplaces,rules,rule,site,sites,compliance,compliances,awareness,awarenesses,housekeeping,communication,communications,overall workplace safety",
    "risk": { "F": 2, "S": 3, "P": 2, "R": 5 },
    "controls": [
      "Communicate company and site rules, confirm worker awareness, and reinforce safe practices and compliance throughout the shift.",
      "Complete pre-job hazard review, maintain housekeeping, correct unsafe acts or conditions immediately, and stop work when controls fail."
    ]
  },
  {
    "name": "Unfamiliar with Task at Hand",
    "keywords": "unfamiliar,unfamiliars,task,tasks,procedure,procedures,training,trainings,competency,competencies,briefing,briefings,stop work,authority,unfamiliar with task at hand",
    "risk": { "F": 2, "S": 3, "P": 2, "R": 5 },
    "controls": [
      "Ensure workers understand the task procedures before starting, review steps, hazards, and required controls for the work.",
      "Confirm competency and supervision, ask questions when unsure, and use Stop Work Authority if the task cannot be done safely."
    ]
  },
  {
    "name": "Unfamiliar task/conditions",
    "keywords": "unfamiliar,unfamiliars,conditions,condition,scope,scopes,hazard assessment,hazard assessments,FLHA,FLHAs,reassess,reassesses,change,changes,supervisor,supervisors,unfamiliar task/conditions",
    "risk": { "F": 2, "S": 3, "P": 2, "R": 5 },
    "controls": [
      "Review scope of work and hazard assessment with all participants, and reassess whenever conditions change.",
      "If unsure, contact your supervisor before proceeding, confirm controls are effective, and stop work if hazards are not controlled."
    ]
  },
  {
    "name": "Incorrect or incomplete information supplied to permit dispatcher",
    "keywords": "permit,permits,dispatcher,dispatchers,information,infos,incomplete,incompletes,incorrect,incorrects,receiver,receivers,training,trainings,duties,duty,responsibilities,responsibility,permit dispatcher",
    "risk": { "F": 2, "S": 1, "P": 3, "R": 5 },
    "controls": [
      "Ensure the permit receiver is trained, provides complete and accurate information, and understands all duties and responsibilities.",
      "Verify permit details before dispatch, clarify uncertainties immediately, and document changes so the dispatcher has current info."
    ]
  },
  {
    "name": "Lack of Knowledge/Training",
    "keywords": "knowledge,knowledges,training,trainings,competent,competents,qualified,qualifieds,competency,competencies,orientation,orientations,coach,coaches,supervision,supervisions,lack of knowledge/training",
    "risk": { "F": 2, "S": 3, "P": 2, "R": 5 },
    "controls": [
      "Match training to the task and assign competent, qualified workers for the work being performed.",
      "Provide coaching and supervision as needed, verify understanding before work starts, and do not assign tasks beyond competency."
    ]
  },
  {
    "name": "Stress from factors such as lack of job control, bullying, not knowing their role etc.",
    "keywords": "stress,stresses,bullying,bullies,harassment,harassments,role,roles,job control,workload,workloads,mental health,wellbeing,report,reports,confidential,confidentially,work stress",
    "risk": { "F": 1, "S": 4, "P": 1, "R": 5 },
    "controls": [
      "Speak confidentially to your manager or supervisor (no-blame) if you feel unwell, unsafe, or stressed due to work factors.",
      "Clarify roles and expectations early, address bullying promptly, and access support resources through HR or HSE as needed."
    ]
  },
  {
    "name": "Violence on the workplace",
    "keywords": "violence,violences,workplace,workplaces,threat,threats,assault,assaults,aggressive,aggressions,911,help,helps,report,reports,HR,policy,policies,workplace violence",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 5 },
    "controls": [
      "Leave dangerous situations and call for help, call 911 for immediate threats, avoid escalation, and report all violence to HR or supervisor.",
      "Follow the workplace violence policy, use de-escalation where safe, and document and report threats, intimidation, or incidents."
    ]
  },
  {
    "name": "Harassment in the workplace",
    "keywords": "harassment,harassments,workplace,workplaces,bully,bullies,unwelcome,conduct,behaviour,behavior,report,reports,record,records,HR,HSE,supervisor,supervisors,harassment policy",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 5 },
    "controls": [
      "Tell the harasser the behaviour is unwelcome and must stop, document incidents, and report to HSE, supervisor, or President.",
      "Follow the harassment policy, keep records of dates and details, and seek support promptly so issues are addressed early."
    ]
  },
  {
    "name": "Mechanical Failure",
    "keywords": "mechanical,mechanicals,failure,failures,vehicle,vehicles,breakdown,breakdowns,inspection,inspections,pretrip,pre-trip,checklist,checklists,maintenance,maintenances,mechanical failure",
    "risk": { "F": 2, "S": 1, "P": 3, "R": 5 },
    "controls": [
      "Inspect vehicles daily, complete pre-trip checks, and complete the Monthly Vehicle Checklist as required.",
      "Report defects immediately, remove unsafe vehicles from service, and ensure repairs are completed before returning to operation."
    ]
  },
  {
    "name": "Collision with other vehicles or personnel",
    "keywords": "collision,collisions,vehicle,vehicles,pedestrian,pedestrians,spotter,spotters,confined,unfamiliar,defensive,driving,vigilance,right of way,parking,traffic,other vehicles or personnel",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 5 },
    "controls": [
      "Drive defensively, stay vigilant, yield to pedestrians, and use a spotter in confined or unfamiliar areas.",
      "Slow down in pedestrian zones, maintain safe separation, and stop operations if visibility or control is inadequate."
    ]
  },
  {
    "name": "Non-compliance with site traffic regulations",
    "keywords": "traffic,traffics,regulation,regulations,sign,signs,signage,ROW,intersection,intersections,right of way,heavy equipment,bus,buses,emergency vehicle,site rules,non-compliance traffic",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 5 },
    "controls": [
      "Follow posted signage and site traffic rules, yield right of way to heavy equipment, buses, and emergency vehicles on the ROW.",
      "Drive at safe speeds for conditions, confirm route rules during site orientation, and stop if unsure of traffic requirements."
    ]
  },
  {
    "name": "Icy or Slippery Road Conditions",
    "keywords": "icy,ice,slippery,slips,road,roads,winter,winters,4x4,traction,braking,stopping distance,following distance,speed,speeds,icy road conditions",
    "risk": { "F": 2, "S": 4, "P": 3, "R": 5 },
    "controls": [
      "Use 4x4 as needed, reduce speed for conditions, and increase stopping and following distance on icy or slippery roads.",
      "Avoid sudden inputs, plan braking early, and postpone travel if conditions are unsafe or outside driver and vehicle capability."
    ]
  },
  {
    "name": "Distracted Driving",
    "keywords": "distracted,distracts,driving,drive,phone,phones,cellular,cell,gps,device,devices,text,texts,call,calls,electronic,electronics,roadside, distracted driving",
    "risk": { "F": 1, "S": 5, "P": 1, "R": 5 },
    "controls": [
      "Do not use phones, GPS, or devices while driving, only operate electronics when stopped and safely pulled off the roadway.",
      "Set routes before driving, silence notifications, and pull over safely if a call, message, or navigation update is needed."
    ]
  },
  {
    "name": "Debris Falling From Other Vehicles",
    "keywords": "debris,debri,falling,falls,load,loads,material,materials,following distance,traffic,vehicle,vehicles,windshield,windshields,road hazard,road hazards, debris falling",
    "risk": { "F": 1, "S": 3, "P": 3, "R": 5 },
    "controls": [
      "Maintain safe following distance, at least three vehicle lengths, and stay alert for falling debris or unsecured loads ahead.",
      "Scan far ahead, avoid tailgating, and change lanes or slow down when approaching trucks or vehicles carrying loose materials."
    ]
  },
  {
    "name": "Soil Contamination from Leaks and Spills",
    "keywords": "spill,spills,leak,leaks,contamination,contaminations,soil,soils,fuel,fuels,oil,oils,hydraulic,hydraulics,report,reports,cleanup,containment,spill kit",
    "risk": { "F": 1, "S": 1, "P": 3, "R": 5 },
    "controls": [
      "Report spills immediately, inspect vehicles daily, repair deficiencies promptly, and carry a spill containment kit in each vehicle.",
      "Stop the source if safe, contain and clean up per procedure, and dispose of contaminated materials according to requirements."
    ]
  },
  {
    "name": "Rough or Uneven Terrain",
    "keywords": "rough,roughs,uneven,unevens,terrain,terrains,obstacle,obstacles,slope,slopes,steep,steeps,route,routes,scan,scans,offroad,off-road,rollover,rollovers",
    "risk": { "F": 3, "S": 3, "P": 2, "R": 5 },
    "controls": [
      "Scan the route for obstacles, drive at reduced speed, choose safer routes where possible, and avoid steep slopes.",
      "Use a spotter where needed, maintain control and clearance, and stop and reassess if terrain risks exceed safe limits."
    ]
  },
  {
    "name": "Driving at Night or in Reduced Visibility",
    "keywords": "night,nights,visibility,visibilities,fog,fogs,dark,darks,headlight,headlights,high beam,beacon,buggy whip,lights,mirrors,windows,following distance,speed reduction",
    "risk": { "F": 4, "S": 5, "P": 2, "R": 4 },
    "controls": [
      "Reduce speed, double following distance, use high beams when appropriate, and use beacon and buggy whip on site for visibility.",
      "Ensure lights, windows, and mirrors are clean and working, and stop driving if visibility becomes unsafe."
    ]
  },
  {
    "name": "Driver Distraction",
    "keywords": "distraction,distractions,driver,drivers,phone,phones,text,texts,email,emails,focus,focused,attention,attentions,pull over,park,parking,driver distraction",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 4 },
    "controls": [
      "Drive free of distractions, no calls, texts, or emails while moving, pull over and park safely if attention is compromised.",
      "Plan communications before travel, set device to do-not-disturb, and take breaks if fatigue or stress affects focus."
    ]
  },
  {
    "name": "Wildlife Encounter",
    "keywords": "wildlife,wildlifes,animal,animals,deer,deers,moose,mooses,bear,bears,ditch,ditches,tree line,tree lines,scan,scans,avoid,avoids,collision,collisions,wildlife encounter",
    "risk": { "F": 2, "S": 3, "P": 3, "R": 5 },
    "controls": [
      "Watch for wildlife while driving, scan ditches and treelines, and slow down where wildlife activity is likely.",
      "Avoid swerving into other lanes, brake smoothly, and report significant wildlife hazards per site or company procedures."
    ]
  },
  {
    "name": "Collision with Vehicles Personnel, or Structures,",
    "keywords": "collision,collisions,reversing,reverse,backing,backup,spotter,spotters,horn,horns,alarm,alarms,structure,structures,parking,turnaround,objects,object,vehicles personnel structures",
    "risk": { "F": 2, "S": 2, "P": 2, "R": 5 },
    "controls": [
      "When reversing, check behind, use a spotter when practicable, and sound horn twice if no site horn rules exist.",
      "Follow site backing procedures, maintain line of sight, and stop immediately if the spotter is lost or hazards appear."
    ]
  },
  {
    "name": "Muscle Strains and Injury",
    "keywords": "muscle,muscles,strain,strains,sprain,sprains,injury,injuries,lift,lifts,lifting,twist,twists,bend,bends,warm up,warm ups,stretch,stretches,material handling,back injury",
    "risk": { "F": 5, "S": 2, "P": 2, "R": 5 },
    "controls": [
      "Warm up and stretch before lifting, use proper lifting technique, avoid bending or twisting, and use help or aids for heavy loads.",
      "Plan lifts, keep loads close, use team lifts when needed, and take breaks to prevent overexertion and repetitive strain."
    ]
  },
  {
    "name": "Pinch and Crush Injuries to Hands and Feet",
    "keywords": "pinch,pinches,crush,crushes,hand,hands,finger,fingers,foot,feet,toolbox,toolboxes,drawer,drawers,tailgate,tailgates,door,doors,material,materials,lowering,loading",
    "risk": { "F": 5, "S": 2, "P": 2, "R": 5 },
    "controls": [
      "Open and close doors, drawers, and tailgates using handles, plan lifts, and keep hands and feet clear when lowering materials.",
      "Wear gloves and safety boots, use clear communication during moves, and never place hands or feet under suspended or moving items."
    ]
  },
  {
    "name": "Hazardous Materials",
    "keywords": "hazardous,hazardous materials,chemical,chemicals,SDS,SDSs,MSDS,MSDSs,consult,consults,exposure,exposures,storage,storages,handling,handlings,spill,spills",
    "risk": { "F": 2, "S": 3, "P": 1, "R": 5 },
    "controls": [
      "Consult the current SDS or MSDS before using any chemical or hazardous material, and follow the listed precautions.",
      "Use required PPE and ventilation, label and store products correctly, and report spills or exposures immediately."
    ]
  },
  {
    "name": "Walking on Uneven Ground – Slips, Trips and Falls",
    "keywords": "walking,walks,uneven,unevens,ground,grounds,slip,slips,trip,trips,fall,falls,slope,slopes,route,routes,footing,footings,walking aid,walking aids,slips trips falls",
    "risk": { "F": 5, "S": 2, "P": 3, "R": 4 },
    "controls": [
      "Take the safest route, avoid slopes where possible, scan for loose material, and use walking aids when needed.",
      "Keep three points of contact on steep or unstable areas, slow down, and stop work if footing cannot be made safe."
    ]
  },
  {
    "name": "Icy or Slippery Ground",
    "keywords": "icy,ice,slippery,slip,slips,ground,grounds,mud,muddy,traction,boot,boots,YakTrax,walking aid,walking aids,sand,ice melt,freeze,freezes",
    "risk": { "F": 3, "S": 2, "P": 3, "R": 5 },
    "controls": [
      "Wear high-traction boots, walk slowly on slippery surfaces, avoid icy areas where possible, and apply traction sand or ice melt when allowed.",
      "Use traction aids like YakTrax where permitted, use walking aids, and stop work if slip risk cannot be controlled."
    ]
  },
  {
    "name": "Traffic Collision with Vehicle and Mobile Equipment Traffic",
    "keywords": "traffic,traffics,collision,collisions,road,roads,vehicle,vehicles,mobile equipment,cones,signage,signs,high visibility,reflective,vest,vests,hard hat striping,work zone,work zones",
    "risk": { "F": 2, "S": 3, "P": 1, "R": 5 },
    "controls": [
      "Avoid working near roads when possible, wear high-visibility PPE, and set cones or signage to warn traffic.",
      "Establish a safe work zone, keep escape routes, face traffic when feasible, and stop work if controls are insufficient."
    ]
  },
  {
    "name": "Equipment Damage",
    "keywords": "equipment,equipments,damage,damages,traffic,traffics,pedestrian,pedestrians,unattended,cone,cones,flagging,barricade,barricades,demarcate,demarcation,total station,total stations,GPS,GNSS",
    "risk": { "F": 3, "S": 1, "P": 3, "R": 5 },
    "controls": [
      "Place equipment clear of vehicle and pedestrian traffic and do not leave it unattended unless the area is demarcated.",
      "Use cones, flagging, or barricades, secure tripods, and position gear to avoid drive paths, blind spots, and pinch points."
    ]
  },
  {
    "name": "Exposure to Hazardous Atmospheres",
    "keywords": "hazardous atmosphere,hazardous atmospheres,gas,gases,testing,tests,monitor,monitors,O2,oxygen,LEL,H2S,carbon monoxide,CO,air monitoring,personal monitor,FR PPE,H2S training",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 5 },
    "controls": [
      "If hazardous air is suspected, test before work and monitor O2, LEL, H2S, CO, and any identified chemicals.",
      "Wear a personal gas monitor and FR PPE when required, ensure H2S and gas awareness training, and stop work if limits are exceeded."
    ]
  },
  {
    "name": "Wildlife Encounters",
    "keywords": "wildlife,wildlifes,encounter,encounters,animal,animals,bear,bears,moose,mooses,report,reports,air horn,air horns,withdraw,withdraws,do not engage,site reporting,site procedures",
    "risk": { "F": 2, "S": 3, "P": 3, "R": 5 },
    "controls": [
      "Stay aware for wildlife, report sightings immediately per site procedure, do not engage, and withdraw slowly to a safe location.",
      "Use an air horn or yelling to deter animals when safe, keep groups together, and stop work until the area is safe."
    ]
  },
  {
    "name": "Fallout from Overhead Work",
    "keywords": "overhead,overheads,fallout,fallouts,dropped object,dropped objects,look up,communication,crew,crews,coordination,FLHA,exchange,exchanges,overhead work",
    "risk": { "F": 1, "S": 3, "P": 3, "R": 5 },
    "controls": [
      "Look up before entering the area, identify overhead hazards, and communicate with crews working above to coordinate work.",
      "Exchange FLHA information, establish exclusion zones if needed, and do not work under overhead activity without controls."
    ]
  },
  {
    "name": "Sharp Edges and Protruding Materials",
    "keywords": "sharp,sharps,edge,edges,protruding,protrusions,material,materials,caution tape,danger tape,cut,cuts,laceration,lacerations,glove,gloves,handle,handles,sharp edges",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 4 },
    "controls": [
      "Stay clear of sharp or protruding materials, mark off hazards with caution or danger tape, and plan work to avoid contact.",
      "If handling is required, wear leather gloves, maintain control of materials, and use proper tools to prevent cuts or punctures."
    ]
  },
  {
    "name": "Tripping and Falling",
    "keywords": "trip,trips,tripping,fall,falls,falling,snow,snows,hidden hazards,housekeeping,scan,scans,shovel,shovels,mark,marks,barricade,barricades,walkway,walkways",
    "risk": { "F": 5, "S": 3, "P": 3, "R": 4 },
    "controls": [
      "Scan for trip hazards, clear loose materials where possible, and mark off areas that cannot be made safe.",
      "In deep snow, shovel the work area first, use careful footing, and stop work if hazards remain hidden or uncontrolled."
    ]
  },
  {
    "name": "Wind-Blown or Flying Dust and Debris",
    "keywords": "wind,windy,dust,dusts,debris,flying,eye,eyes,eyewear,goggles,sealed glasses,silt,sand,particles,respiratory,visibility,wind-blown debris",
    "risk": { "F": 5, "S": 1, "P": 5, "R": 5 },
    "controls": [
      "Wear approved safety eyewear, use goggles or sealed glasses for fine particles, and stop work if dust or debris makes conditions unsafe.",
      "Position upwind when possible, protect eyes and face, and secure loose materials to reduce airborne debris and impact hazards."
    ]
  },
  {
    "name": "Darkness, Poor Visibility",
    "keywords": "darkness,darks,visibility,visibilities,poor visibility,lighting,light plant,headlights,helmet light,reflective,high visibility,PPE,striping,vest,vests,work light,work lights",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 4 },
    "controls": [
      "Wear high-visibility PPE with reflective striping and use added lighting such as light plants, headlights, or helmet lights as needed.",
      "Confirm adequate lighting for tasks, slow movements, and stop work if you cannot clearly see hazards, edges, or equipment."
    ]
  },
  {
    "name": "Lines of Fire",
    "keywords": "line of fire,lines of fire,between vehicles,behind vehicles,suspended load,suspended loads,load,loads,cable,cables,bight,bights,hand placement,tools,tool,crush,crushes,struck by",
    "risk": { "F": 5, "S": 3, "P": 3, "R": 4 },
    "controls": [
      "Stay out of lines of fire, do not stand behind or between vehicles, and never work under suspended or shifting loads.",
      "Keep clear of cable bights, watch hand placement on tools and materials, and maintain safe positioning and escape routes."
    ]
  },
  {
    "name": "Tool Failure",
    "keywords": "tool,tools,failure,failures,inspection,inspections,defect,defects,damaged,damage,maintenance,replace,replacement,lockout,tagout,lock-out,tag-out,quarterly inspection",
    "risk": { "F": 5, "S": 1, "P": 2, "R": 5 },
    "controls": [
      "Inspect tools before use, remove damaged tools from service immediately, and report for maintenance or replacement.",
      "Complete documented quarterly tool inspections, follow lock-out/tag-out where applicable, and only use tools as intended."
    ]
  },
  {
    "name": "Noise",
    "keywords": "noise,noises,hearing,ear,ears,earplug,earplugs,earmuff,earmuffs,decibel,decibels,80 dB,100 dB,double protection,hearing protection,auditory,auditorys",
    "risk": { "F": 5, "S": 3, "P": 3, "R": 4 },
    "controls": [
      "Wear hearing protection when noise exceeds 80 dB, and use double protection (plugs and muffs) at or above 100 dB.",
      "Limit exposure time, increase distance from noise sources, and report high-noise tasks so controls and PPE are confirmed."
    ]
  },
  {
    "name": "Hazardous Contact with Hydrovac Operations",
    "keywords": "hydrovac,hydrovacs,suction hose,suction hoses,aspiration,aspirations,noise,noises,eye,eyes,hearing,face shield,face shields,exclusion zone,exclusion zones,hydrovac operations",
    "risk": { "F": 3, "S": 5, "P": 1, "R": 5 },
    "controls": [
      "Wear hearing and eye protection, stay clear of the suction hose, and use face shields when close to hydrovac operations.",
      "Establish exclusion zones and communicate with the operator, never approach the nozzle without permission, and stop if control is lost."
    ]
  },
  {
    "name": "Fire and Heat Hazard Near Welding Operations",
    "keywords": "fire,fires,heat,hot,welding,weld,welds,arc flash,slag,sparks,shield,shields,FR PPE,leather gloves,burn,burns,ignite,ignition,welding operations",
    "risk": { "F": 3, "S": 3, "P": 1, "R": 5 },
    "controls": [
      "Use welding shields to block arc flash and slag, wear FR PPE near welding, and avoid looking at the arc.",
      "Watch for sparks and hot materials, wear leather gloves when handling, and keep combustibles clear of the welding area."
    ]
  },
  {
    "name": "Injuries resulting from the improper use of a chainsaw.",
    "keywords": "chainsaw,chainsaws,saw,saws,cut,cutting,kickback,kickbacks,PPE,authorization,authorized,spotter,spotters,communication,crew,crews,party chief,party chiefs,improper use chainsaw",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 5 },
    "controls": [
      "Only authorized personnel may operate chainsaws with supervisor approval, maintain communication, and ensure at least two workers are present.",
      "Confirm PPE and training, maintain situational awareness of people and equipment, and stop work if conditions create unsafe cutting risks."
    ]
  },
  {
    "name": "Muscle strains, pulls, and repetitive motion injuries.",
    "keywords": "muscle,muscles,strain,strains,pull,pulls,repetitive,repetition,overuse,injury,injuries,stretch,stretches,warm-up,warm-ups,break,breaks,ergonomic,ergonomics,physical limits",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 5 },
    "controls": [
      "Stretch and warm up before and during physical activity, take frequent breaks, and know your physical limits.",
      "Rotate tasks where possible, use proper body mechanics, and stop and report early discomfort before it becomes an injury."
    ]

  },
  {
    "name": "Injuries or property damage from lack of PPE.",
    "keywords": "PPE,ppes,lack,missing,glove,gloves,boot,boots,cutting pants,face shield,hardhat,hard hat,hearing protection,eye protection,injury,injuries,property damage,chainsaw PPE",
    "risk": { "F": 1, "S": 3, "P": 1, "R": 5 },
    "controls": [
      "Wear required PPE for chainsaw work, cutting pants, gloves, cutting boots, hard hat with face shield, hearing and eye protection.",
      "Inspect PPE before use, replace damaged items, and stop work if PPE is missing, unsuitable, or does not meet task requirements."
    ]
  },
  {
    "name": "Working around lines and facilities",
    "keywords": "lines,line,facility,facilities,substation,substations,limits of approach,LOA,escort,escorts,conductive,conductives,extendable,vertical,utilities,utility,electrical,electric,energized,working around lines",
    "risk": { "F": 3, "S": 5, "P": 2, "R": 4 },
    "controls": [
      "Stay alert, know limits of approach, never enter a substation without an escort, and avoid conductive or vertically extendable equipment.",
      "Confirm utility locations and site rules, maintain required clearances, and stop work immediately if limits of approach may be breached."
    ]
  },
  {
    "name": "Spoil Pile Collapse",
    "keywords": "spoil,spoil pile,spoil piles,collapse,collapses,excavation,excavations,trench,trenches,edge,edges,setback,setbacks,slope,slopes,45 degree,1.5 metres,soil,soils,fall in,fall-ins",
    "risk": { "F": 3, "S": 5, "P": 2, "R": 4 },
    "controls": [
      "Keep spoil piles at least 1.5 m from trench edges, slope to 45 degrees or step back, and keep debris out of the excavation.",
      "Inspect spoil placement regularly, control water and vibration sources, and stop work if soil stability or setbacks are not maintained."
    ]
  },
  {
    "name": "Trench Wall Collapse",
    "keywords": "trench,trenches,wall,walls,collapse,collapses,cave-in,cave-ins,shoring,shore,slope,sloping,45 degree,1:1,ladder,ladders,competent person,inspection,excavation,excavations",
    "risk": { "F": 3, "S": 5, "P": 2, "R": 4 },
    "controls": [
      "Inspect trench walls and base before entry, ensure stability, and for depths over 1.2 m use shoring or 1:1 sloping plus a ladder within 8 m.",
      "Keep people out until controls are in place, manage water and spoil setbacks, and have a competent person reassess after any change."
    ]
  },
  {
    "name": "Drowning",
    "keywords": "drown,drowning,water,waters,body of water,bodies of water,life jacket,life jackets,PFD,PFDs,spotter,spotters,shoreline,shorelines,fall in,falls in,rescue,rescues",
    "risk": { "F": 2, "S": 5, "P": 1, "R": 5 },
    "controls": [
      "Keep a safe distance from water, wear a life jacket when drowning hazard exists, and never work near water without a spotter.",
      "Plan access and rescue options, avoid unstable banks and ice, and stop work if conditions increase drowning risk."
    ]
  },
  {
    "name": "Wind Chill",
    "keywords": "wind,winds,wind chill,cold,colds,exposure,exposures,break,breaks,warm,warming,shelter,shelters,chart,charts,layer,layers,rotation,rotations,wind chill",
    "risk": { "F": 2, "S": 3, "P": 3, "R": 5 },
    "controls": [
      "Check wind chill chart, adjust duty times, take regular warm-up breaks, and seek shelter from wind when possible.",
      "Dress in layers, keep extremities covered, monitor symptoms, and stop work if cold stress cannot be managed safely."
    ]
  },
  {
    "name": "Frostbite",
    "keywords": "frostbite,frostbites,cold,colds,numb,numbness,tingle,tingling,pain,pains,discoloration,skin,skins,extremity,extremities,monitor,monitors,warm,warming,first aid",
    "risk": { "F": 2, "S": 3, "P": 2, "R": 5 },
    "controls": [
      "Monitor for early frostbite signs (tingling, numbness, pain, discoloration), stop work, and warm up in shelter if signs appear.",
      "Limit exposure, keep skin covered and dry, rotate tasks, and seek first aid or medical help if symptoms persist."
    ]
  },
  {
    "name": "Extreme Cold / Hypothermia",
    "keywords": "cold,colds,extreme cold,hypothermia,hypothermias,layer,layers,shiver,shivering,exposed skin,shelter,breaks,overexertion,sweat,sweating,stop work,client HSE,temperature,temperatures",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 5 },
    "controls": [
      "Dress in layers, limit exposed skin, warm up in shelter regularly, and avoid overexertion that causes sweating in cold conditions.",
      "Monitor for hypothermia symptoms, follow Client HSE stop-work triggers, and get help immediately if confusion or severe shivering occurs."
    ]
  },
  {
    "name": "Heat Stress",
    "keywords": "heat,hot,heat stress,overheat,overheating,dehydration,dehydrate,sweat,sweating,dizzy,dizziness,nausea,disorientation,rest,shade,water,fluids,cool,cooling,medical assistance",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 5 },
    "controls": [
      "Watch for heat stress signs (dizziness, heavy sweating, nausea, disorientation), stop work, cool down, drink fluids, and rest.",
      "Use shade and hydration breaks, pace work, and seek medical assistance if symptoms worsen or do not improve quickly."
    ]
  },
  {
    "name": "Sunburn",
    "keywords": "sunburn,sunburns,UV,ultraviolet,sun,suns,exposure,exposures,sunscreen,sunscreens,cover,covering,clothing,hat,hats,skin,skins,burn,burns,SPF",
    "risk": { "F": 2, "S": 2, "P": 2, "R": 5 },
    "controls": [
      "Cover exposed skin with light clothing and apply sunscreen to exposed areas before and during outdoor work.",
      "Reapply sunscreen as needed, use hats and shade where possible, and schedule breaks to reduce peak UV exposure."
    ]
  },
  {
    "name": "Injury from Thunderstorms / Lightning",
    "keywords": "thunderstorm,thunderstorms,lightning,storm,storms,flash bang ratio,flash,bang,open area,open areas,high ground,shelter,shelters,stop work,weather,weathers,injury,injuries",
    "risk": { "F": 2, "S": 5, "P": 1, "R": 5 },
    "controls": [
      "Avoid open or high areas during thunderstorms and use the Flash/Bang Ratio to assess storm distance.",
      "Stop work if Flash/Bang is 5 seconds or less or per Client HSE direction, and move to safe shelter immediately."
    ]
  },
  {
    "name": "Falling From Heights",
    "keywords": "fall,falls,falling,height,heights,scaffold,scaffolds,tag,tags,guardrail,guardrails,handrail,handrails,tie-off,tieoffs,fall arrest,harness,harnesses,lanyard,lanyards,training",
    "risk": { "F": 3, "S": 5, "P": 3, "R": 4 },
    "controls": [
      "Inspect scaffold tags before use, use only inspected scaffolds, and ensure handrails and guards are in place.",
      "Use 100% tie-off at 1.8 m or higher when rails are missing, and ensure workers are trained in fall arrest equipment."
    ]
  },
  {
    "name": "Dropping Tools",
    "keywords": "drop,drops,dropping,tool,tools,restraint,restraints,toe board,toe boards,scaffold,scaffolds,falling object,falling objects,struck by,below,barricade,barricades,lanyard,lanyards",
    "risk": { "F": 3, "S": 3, "P": 2, "R": 5 },
    "controls": [
      "Restrain tools and equipment when working at height and ensure toe boards are installed before work begins.",
      "Keep the area below clear or barricaded, use tool lanyards where required, and never store loose items near edges."
    ]
  },
  {
    "name": "Flying Debris",
    "keywords": "flying,debris,chip,chips,shard,shards,eye,eyes,eyewear,face shield,face shields,impact,impacts,grinding,cutting,hammering,worksite,worksites,flying debris",
    "risk": { "F": 5, "S": 3, "P": 3, "R": 4 },
    "controls": [
      "Wear approved safety eyewear and use a face shield when required to protect against flying debris.",
      "Set up exclusion zones, control tool direction, and stop work if debris cannot be contained or people are exposed."
    ]
  },
  {
      name: "Injury due to fall from ladder",
      keywords: "ladder,fall,three points of contact,inspection,setup,footing,training,swp,use of ladder",
      risk: { F: 2, S: 4, P: 3, R: 5 },
      controls: [
        "Follow Vista Geomatics SWP \"Use of Ladder\", inspect ladder condition, set on firm footing, and maintain three points of contact.",
        "Do not overreach, secure the ladder when needed, and stop use immediately if defects, instability, or unsafe access is identified."
      ]
    }
    // Add the rest of your hazards here in the exact same structure.
  ];

  function clipControl(text, max = 185) {
    const t = (text || "").replace(/\s+/g, " ").trim();
    if (t.length <= max) return t;
    return t.slice(0, max - 1).trimEnd() + "…";
  }

  function normalize(text) {
    return (text || "")
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function stemToken(tok) {
    let t = tok;
    if (t.length <= 3) return t;
    if (t.endsWith("ies") && t.length > 4) t = t.slice(0, -3) + "y";
    else if (t.endsWith("es") && t.length > 4) t = t.slice(0, -2);
    else if (t.endsWith("s") && t.length > 3) t = t.slice(0, -1);
    if (t.endsWith("ing") && t.length > 5) t = t.slice(0, -3);
    return t;
  }

  function tokens(text) {
    const n = normalize(text);
    if (!n) return [];
    return n.split(" ").map(stemToken).filter(Boolean);
  }

  function hashString(str) {
    let h = 2166136261;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }

  function getKeywordsArray(entry) {
    if (!entry || entry.keywords == null) return [];
    if (Array.isArray(entry.keywords)) return entry.keywords.map(s => String(s));
    return String(entry.keywords)
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);
  }

  function scoreEntry(entry, hazardNorm, hazardTokens) {
    let score = 0;
    const hs = new Set(hazardTokens);
    const kws = getKeywordsArray(entry);

    // Phrase match: if a multi-word keyword appears in hazard text
    kws.forEach(k => {
      const kn = normalize(k);
      if (!kn) return;
      if (kn.includes(" ") && hazardNorm.includes(kn)) score += 18;
    });

    // Token overlap between hazard tokens and keyword tokens
    kws.forEach(k => {
      tokens(k).forEach(t => { if (hs.has(t)) score += 2; });
    });

    // Small boost if hazard contains tokens from the hazard name
    tokens(entry.name).forEach(t => { if (hs.has(t)) score += 2; });

    return score;
  }

  function bestEntryForHazard(hazardText) {
    const hazardNorm = normalize(hazardText);
    if (!hazardNorm) return null;

    const htoks = tokens(hazardText);
    let best = null;
    let bestScore = 0;

    for (const entry of HAZARD_LIBRARY) {
      const s = scoreEntry(entry, hazardNorm, htoks);

      if (s > bestScore) { bestScore = s; best = entry; }
    }

    // minimum confidence to prevent wrong matches
    if (!best || bestScore < 8) return null;
    return best;
  }

  function clearRow(row) {
    const f = document.querySelector(`input[name="f_${row}"]`);
    const s = document.querySelector(`input[name="s_${row}"]`);
    const p = document.querySelector(`input[name="p_${row}"]`);
    const r = document.querySelector(`input[name="r_${row}"]`);
    const c = document.querySelector(`textarea[name="control_${row}"]`);
    if (f) f.value = "";
    if (s) s.value = "";
    if (p) p.value = "";
    if (r) r.value = "";
    if (c) c.value = "";
  }

  function applyEntryToRow(entry, row, hazardText) {
    const controlField = document.querySelector(`textarea[name="control_${row}"]`);
    const fField = document.querySelector(`input[name="f_${row}"]`);
    const sField = document.querySelector(`input[name="s_${row}"]`);
    const pField = document.querySelector(`input[name="p_${row}"]`);

    const idx = (hashString(`${row}|${hazardText}|${entry.name}`) % 2);
    const chosen = clipControl((entry.controls && entry.controls[idx]) || "");

    if (controlField) {
      if (!controlField.value || controlField.value.trim().length < 15) controlField.value = chosen;
    }

    const rt = entry.ratings || (entry.risk ? { f: entry.risk.F, s: entry.risk.S, p: entry.risk.P } : null);
    if (rt) {
      if (fField && !fField.value && rt.f) fField.value = String(rt.f);
      if (sField && !sField.value && rt.s) sField.value = String(rt.s);
      if (pField && !pField.value && rt.p) pField.value = String(rt.p);
    }
    updateRiskForRow(row);
  }

  function initHazardAutoSuggest() {
    document.querySelectorAll('input[name^="hazard_"]').forEach(input => {
      input.addEventListener('blur', e => {
        const hazardText = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];

        if (!hazardText) { clearRow(row); return; }

        const entry = bestEntryForHazard(hazardText);
        if (!entry) { updateRiskForRow(row); return; }

        applyEntryToRow(entry, row, hazardText);
      });

      input.addEventListener('input', e => {
        const value = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];
        if (!value) clearRow(row);
      });
    });
  }

  initHazardAutoSuggest();

  // ============================================================
  // PDF EXPORT (LEGAL, FIXES TEXTAREA RENDERING)
  // ============================================================
  function copyFormValuesToClone(original, clone) {
    const origFields = original.querySelectorAll("input, textarea, select");
    origFields.forEach(orig => {
      const name = orig.getAttribute("name");
      const id = orig.getAttribute("id");

      let sel = null;
      if (id) sel = clone.querySelector(`#${CSS.escape(id)}`);
      if (!sel && name) sel = clone.querySelector(`[name="${CSS.escape(name)}"]`);
      if (!sel) return;

      if (orig.tagName.toLowerCase() === "textarea") {
        sel.value = orig.value;
        sel.textContent = orig.value;
      } else if (orig.type === "checkbox") {
        sel.checked = orig.checked;
        if (orig.checked) sel.setAttribute("checked", "checked");
        else sel.removeAttribute("checked");
      } else {
        sel.value = orig.value;
        sel.setAttribute("value", orig.value);
      }
    });

    ["pcSignature","saSignature","clientSignature"].forEach(cid => {
      const origCanvas = document.getElementById(cid);
      const cloneCanvas = clone.querySelector(`#${CSS.escape(cid)}`);
      if (!origCanvas || !cloneCanvas) return;

      const rect = cloneCanvas.getBoundingClientRect();
      cloneCanvas.width = Math.floor((rect.width || 300));
      cloneCanvas.height = Math.floor((rect.height || 80));
      const cctx = cloneCanvas.getContext("2d");
      const img = new Image();
      img.onload = () => {
        cctx.clearRect(0,0,cloneCanvas.width, cloneCanvas.height);
        cctx.drawImage(img, 0, 0, cloneCanvas.width, cloneCanvas.height);
      };
      img.src = origCanvas.toDataURL("image/png");
    });
  }

  function expandTextareasForExport(cloneRoot) {
    cloneRoot.querySelectorAll("textarea").forEach(t => {
      t.style.height = "auto";
      t.style.minHeight = "0";
      t.style.maxHeight = "none";
      t.style.overflow = "visible";
      t.textContent = t.value || t.textContent || "";
      t.style.height = (t.scrollHeight + 2) + "px";
    });
  }

  function createFilteredFormClone() {
    const form = document.getElementById('hazardForm');
    const clone = form.cloneNode(true);

    copyFormValuesToClone(form, clone);

    const commonTableBody = clone.querySelector('#commonHazardsTable tbody');
    if (commonTableBody) {
      Array.from(commonTableBody.rows).forEach(row => {
        const appliesCheckbox = row.querySelector('td:first-child input[type="checkbox"]');
        if (appliesCheckbox && !appliesCheckbox.checked) row.remove();
      });
      if (commonTableBody.rows.length === 0) {
        const tbl = clone.querySelector("#commonHazardsTable");
        if (tbl) tbl.remove();
      }
    }

    const clonedButtonRow = clone.querySelector('#buttonRow');
    if (clonedButtonRow) clonedButtonRow.style.display = 'none';

    const dl = clone.querySelector("#facilityList");
    if (dl) dl.remove();

    const stamp = document.getElementById("versionStamp");
    if (stamp) clone.appendChild(stamp.cloneNode(true));

    expandTextareasForExport(clone);
    return clone;
  }

  async function generatePdf() {
    if (!window.jspdf || !window.html2canvas) {
      alert("Missing PDF libraries. Ensure jspdf.umd.min.js and html2canvas.min.js are in the same folder as this HTML.");
      throw new Error("Missing libraries");
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'legal');

    const clone = createFilteredFormClone();

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.style.width = '1050px';
    tempContainer.style.background = '#ffffff';
    tempContainer.appendChild(clone);
    document.body.appendChild(tempContainer);

    await new Promise(r => setTimeout(r, 180));

    const clonePage1 = clone.querySelector('#page1');
    const clonePage2 = clone.querySelector('#page2');

    async function addPage(div, addNew) {
      if (!div) return;
      if (addNew) pdf.addPage();

      expandTextareasForExport(clone);

      const canvas = await html2canvas(div, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
        windowWidth: 1050
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 8;

      let imgW = pageWidth - margin * 2;
      let imgH = canvas.height * (imgW / canvas.width);

      if (imgH > pageHeight - margin * 2) {
        imgH = pageHeight - margin * 2;
        imgW = canvas.width * (imgH / canvas.height);
      }

      const x = (pageWidth - imgW) / 2;
      const y = margin;
      pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH);
    }

    await addPage(clonePage1, false);
    await addPage(clonePage2, true);

    document.body.removeChild(tempContainer);
    return pdf;
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        pdf.save(getFinalFileName());
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        const blob = pdf.output('blob');
        const fileName = getFinalFileName();
        const file = new File([blob], fileName, { type: 'application/pdf' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'Worksite Hazard Assessment',
            text: 'VistaGeomatics – Worksite Hazard Assessment PDF'
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
      } catch (e) {
        console.error('Share failed:', e);
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }
</script>
</body>
</html>
