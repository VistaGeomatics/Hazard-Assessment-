<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VistaGeomatics – Worksite Hazard Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --vista-blue: #165f7d;
      --vista-blue-light: #2a7fa3;
      --vista-blue-dark: #0b3045;
      --bg-body: #eef3f9;
      --bg-card: #ffffff;
      --border-soft: #d6e2f0;
      --text-main: #101827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top, #f4f8fc 0, #e4edf6 40%, #dde6f3 100%);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    .page-wrap { max-width: 1050px; margin: 0 auto; }

    .container {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 14px 30px rgba(5, 41, 66, 0.18), 0 0 0 1px rgba(5, 41, 66, 0.04);
      overflow: hidden;
      position: relative;
      margin-bottom: 18px;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(22,95,125,0.16), transparent 55%);
      opacity: 0.9;
    }

    .header-bar {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: linear-gradient(120deg, var(--vista-blue-light) 0%, var(--vista-blue) 40%, var(--vista-blue-dark) 100%);
      color: #fff;
    }

    .header-left h1 {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .header-left p { margin: 2px 0 0; font-size: 0.8rem; opacity: 0.9; }

    .header-logo { height: 60px; filter: drop-shadow(0 5px 14px rgba(0,0,0,0.35)); }

    .page-title-bar {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 10px 20px 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.78), #f7faff);
    }

    .page-title-main {
      font-family: "Montserrat", sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--vista-blue-dark);
    }

    .page-title-sub { margin-top: 3px; font-size: 0.78rem; color: var(--text-muted); }

    .page-title-accent {
      width: 120px;
      height: 3px;
      margin: 8px auto 0;
      border-radius: 999px;
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      box-shadow: 0 0 8px rgba(46,167,224,0.65);
    }

    .page-body { position: relative; z-index: 1; padding: 10px 18px 14px; font-size: 0.8rem; }

    label { font-size: 0.78rem; font-weight: 600; display: block; margin-bottom: 2px; color: var(--text-main); }

    input[type="text"], input[type="date"], input[type="time"], textarea, .small-input {
      width: 100%;
      font-family: "Inter", sans-serif;
      font-size: 0.74rem;
      line-height: 1.25;
      color: var(--text-main);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      transition: 0.15s;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="text"], input[type="date"], input[type="time"], .small-input {
      height: 34px;
      padding: 6px 8px;
      vertical-align: middle;
    }

    textarea { padding: 6px 8px; min-height: 56px; resize: vertical; }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--vista-blue-light);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(38,132,168,0.18);
    }

    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 4px; }
    .row > div { flex: 1; min-width: 150px; }

    .section-card {
      margin-top: 8px;
      padding: 8px 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, #fbfdff 0%, #f4f8fd 60%, #eff5fb 100%);
      box-shadow: 0 6px 16px rgba(5, 41, 66, 0.05);
      position: relative;
    }

    .section-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      border-radius: 12px 12px 0 0;
      background: linear-gradient(90deg, var(--vista-blue-light), var(--vista-blue-dark));
    }

    .section-header { display: flex; justify-content: space-between; align-items: baseline; gap: 6px; margin-bottom: 4px; }

    .section-title {
      font-weight: 600;
      font-size: 0.86rem;
      color: var(--vista-blue-dark);
      font-family: "Montserrat", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .section-note { font-size: 0.72rem; color: var(--text-muted); }

    .inline-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.76rem; align-items: center; }
    .inline-checkbox-group label { display: inline-flex; align-items: center; gap: 4px; font-weight: 500; margin-bottom: 0; }

    input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--vista-blue); margin: 0; }

    .small-text { font-size: 0.74rem; color: var(--text-muted); }

    table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 4px; }
    th, td { border: 1px solid var(--border-soft); padding: 3px 4px; vertical-align: top; }
    th { background: #e8f0fb; font-weight: 600; color: var(--vista-blue-dark); }
    td { background: #f9fbff; }
    .center { text-align: center; }

    .signature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; margin-top: 4px; }
    .signature-box { border-radius: 10px; border: 1px solid var(--border-soft); background: #f9fbff; padding: 6px; font-size: 0.78rem; }
    .signature-label { font-size: 0.74rem; font-weight: 600; color: var(--text-muted); margin-bottom: 2px; }

    .signature-canvas {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      display: block;
      cursor: crosshair;
    }

    .signature-actions { display: flex; justify-content: flex-end; margin-top: 4px; }
    .signature-actions button { padding: 3px 10px; font-size: 0.7rem; letter-spacing: 0.05em; }
    .signature-row { display: flex; gap: 6px; margin-top: 4px; }
    .signature-row > div { flex: 1; }

    .btn-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; margin-bottom: 4px; flex-wrap: wrap; }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      color: #fff;
      box-shadow: 0 8px 20px rgba(5, 41, 66, 0.35);
    }

    .btn-secondary { background: #f3f4f6; color: var(--text-main); border: 1px solid #d6d7dd; }

    button:hover { transform: translateY(-1px); box-shadow: 0 9px 22px rgba(15, 23, 42, 0.18); }

    .control-text {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      padding: 6px 8px;
      line-height: 1.25;
      font-size: 0.74rem;
      white-space: pre-wrap;
    }

    .risk-input, .risk-output {
      height: 32px !important;
      padding: 5px 6px !important;
      line-height: 1.2 !important;

      font-size: 0.74rem !important;
      text-align: center;
    }

    .version-stamp{
      position: fixed;
      right: 14px;
      bottom: 10px;
      z-index: 50;
      font-family: "Inter", sans-serif;
      font-size: 0.68rem;
      letter-spacing: 0.06em;
      color: rgba(16,24,39,0.75);
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(214,226,240,0.9);
      padding: 4px 10px;
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(5,41,66,0.08);
      backdrop-filter: blur(4px);
    }

    @media (max-width: 700px) {
      .header-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
      .page-title-main { font-size: 1.05rem; letter-spacing: 0.12em; }
    }
  </style>
</head>

<body>
<div class="page-wrap">
  <form id="hazardForm">
    <!-- PAGE 1 -->
    <div class="container" id="page1">
      <div class="header-bar">
        <div class="header-left">
          <h1>VISTAGEOMATICS</h1>
          <p>Worksite Hazard Assessment &amp; Tailgate Report</p>
        </div>
        <img src="vista-geomatics.png" alt="VistaGeomatics Logo" class="header-logo">
      </div>

      <div class="page-title-bar">
        <div class="page-title-main">Worksite Hazard Assessment</div>
        <div class="page-title-sub">Identify hazards and controls prior to commencing work.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">General Information</div>
          </div>
          <div class="row">
            <div>
              <label for="developed_by">Developed By</label>
              <input type="text" id="developed_by" name="developed_by">
            </div>
            <div>
              <label for="location">Location</label>
              <input type="text" id="location" name="location">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="date">Date</label>
              <input type="date" id="date" name="date">
            </div>
            <div>
              <label for="start_time">Start Time</label>
              <input type="time" id="start_time" name="start_time">
            </div>
            <div>
              <label for="completion_time">Form Completion Time</label>
              <input type="time" id="completion_time" name="completion_time">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="job_number">Job Number</label>
              <input type="text" id="job_number" name="job_number">
            </div>
            <div>
              <label for="description">Description of Work</label>
              <input type="text" id="description" name="description">
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Tailgate Meeting Report</div>
            <div class="section-note">Complete daily prior to starting work and when procedures change or new hazards are present.</div>
          </div>
          <div style="margin-bottom:4px;">
            <label for="tailgate_minutes">Tailgate Minutes</label>
            <textarea id="tailgate_minutes" name="tailgate_minutes"></textarea>
          </div>

          <div class="row">
            <div style="flex:1;">
              <label>Site Sidewalk and Fencing Condition Report</label>
              <div class="inline-checkbox-group">
                <span>Did you drive on the sidewalk?</span>
                <label><input type="checkbox" name="sidewalk_yes"> Yes</label>
                <label><input type="checkbox" name="sidewalk_no"> No</label>
                <span>Fences Installed?</span>
                <label><input type="checkbox" name="fences_yes"> Yes</label>
                <label><input type="checkbox" name="fences_no"> No</label>
              </div>
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="sidewalk_comments">Comments</label>
            <textarea id="sidewalk_comments" name="sidewalk_comments"></textarea>
          </div>

          <div style="margin-top:4px;">
            <label>Pictures Taken:</label>
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="pic_site"> Site</label>
              <label><input type="checkbox" name="pic_sidewalk"> Sidewalk</label>
              <label><input type="checkbox" name="pic_fences"> Fences</label>
              <label><input type="checkbox" name="pic_hazards"> Hazards</label>
              <label>
                <input type="checkbox" name="pic_other"> Other (Describe):
                <input type="text" name="pic_other_desc" style="width:160px;">
              </label>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Working Alone &amp; Check-in</div>
          </div>

          <div class="row">
            <div style="flex:1 1 35%;">
              <label>Working Alone</label>
              <div class="inline-checkbox-group">
                <label><input type="checkbox" name="working_alone_yes"> Yes</label>
                <label><input type="checkbox" name="working_alone_no"> No</label>
              </div>
            </div>
            <div style="flex:1 1 30%;">
              <label for="check_in_interval">Check-in Interval</label>
              <input type="text" id="check_in_interval" name="check_in_interval" placeholder="e.g., Hourly, Every 2 hours">
            </div>
            <div style="flex:1 1 30%;">
              <label for="communication_method">Communication Method</label>
              <input type="text" id="communication_method" name="communication_method" placeholder="e.g., Phone, Radio">
            </div>
          </div>

          <div class="row">
            <div style="flex:1 1 40%;">
              <label for="working_supervisor_name">Contact Procedures – Call Supervisor: Name</label>
              <input type="text" id="working_supervisor_name" name="working_supervisor_name">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_in_time">Check-in Time</label>
              <input type="time" id="check_in_time" name="check_in_time">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_out_time">Check-out Time</label>
              <input type="time" id="check_out_time" name="check_out_time">
            </div>
          </div>

          <div class="small-text" style="margin-top:4px;">
            <strong>Note:</strong> Check-in intervals are based on risk level,
            High risk: hourly, Medium risk: every 2 hours, Low risk: start and end of shift.
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Daily Equipment Inspection</div>
            <div class="section-note">Check your vehicle, ATV, snowmobile, generator, trailer, and/or chainsaw and report any deficiencies.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Equipment</th>
              <th>Inspection Items</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>Vehicle</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="veh_tires"> Tires</label>
                  <label><input type="checkbox" name="veh_oil"> Oil</label>
                  <label><input type="checkbox" name="veh_fuel"> Fuel</label>
                  <label><input type="checkbox" name="veh_washer"> Washer fluid</label>
                  <label><input type="checkbox" name="veh_lights"> Lights</label>
                  <label><input type="checkbox" name="veh_tiedowns"> Tie-Down Straps</label>
                  <label>Other: <input type="text" name="veh_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>ATV / Snowmobile</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="atv_tires"> Tires/Track</label>
                  <label><input type="checkbox" name="atv_oil_fuel"> Oil/Fuel</label>
                  <label><input type="checkbox" name="atv_lights"> Lights</label>
                  <label><input type="checkbox" name="atv_brakes"> Brakes</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Generator</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="gen_oil"> Oil</label>
                  <label><input type="checkbox" name="gen_fuel"> Fuel</label>
                  <label><input type="checkbox" name="gen_cord"> Extension Cord</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Chainsaw (if used)</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="saw_oil"> Oil</label>
                  <label><input type="checkbox" name="saw_fuel"> Fuel</label>
                  <label><input type="checkbox" name="saw_chain"> Chain</label>
                  <label><input type="checkbox" name="saw_guard"> Guard</label>
                  <label>Other: <input type="text" name="saw_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Trailer</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="trl_tires"> Tires</label>
                  <label><input type="checkbox" name="trl_lights"> Lights</label>
                  <label><input type="checkbox" name="trl_chains"> Safety Chains</label>
                  <label><input type="checkbox" name="trl_deck"> Deck</label>
                  <label><input type="checkbox" name="trl_plate"> Licence Plate</label>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Personal Protective Equipment</div>
            <div class="section-note">Check off required PPE; report missing or worn items as needed.</div>
          </div>

          <div class="inline-checkbox-group">
            <label><input type="checkbox" name="ppe_hardhat"> Hardhat</label>
            <label><input type="checkbox" name="ppe_atv_helmet"> ATV Helmets</label>
            <label><input type="checkbox" name="ppe_signs"> Signs</label>
            <label><input type="checkbox" name="ppe_eye"> Eye Protection</label>
            <label><input type="checkbox" name="ppe_gloves"> Gloves</label>
            <label><input type="checkbox" name="ppe_csa_footwear"> CSA Approved Footwear</label>
            <label><input type="checkbox" name="ppe_winter"> Winter Clothing</label>
            <label><input type="checkbox" name="ppe_reflective"> Reflective Clothing</label>
            <label><input type="checkbox" name="ppe_frc"> Fire Retardant Coveralls</label>
            <label><input type="checkbox" name="ppe_hearing"> Hearing Protection</label>
            <label><input type="checkbox" name="ppe_chaps"> Chainsaw Pants/Chaps</label>
            <label><input type="checkbox" name="ppe_first_aid"> Personal First Aid Kit</label>
            <label><input type="checkbox" name="ppe_gas_monitor"> H2S, Methane, Oxygen, CO Monitor</label>
            <label>Other: <input type="text" name="ppe_other" style="width:160px;"></label>
          </div>


        </div>
      </div>
    </div>

    <!-- PAGE 2 -->
    <div class="container" id="page2">
      <div class="page-title-bar">
        <div class="page-title-main">Job Tasks, Hazards &amp; Controls</div>
        <div class="page-title-sub">Controls and ratings auto-suggest from an embedded offline ruleset.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Common Occurring Hazards</div>
            <div class="section-note">Unchecked rows will be removed from the PDF.</div>
          </div>

          <table id="commonHazardsTable">
            <thead>
            <tr>
              <th class="center">Applies</th>
              <th>Hazard</th>
              <th>Controls (from Worksite Hazard Assessment)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td class="center"><input type="checkbox" name="haz_buried_overhead"></td>
              <td>Buried or Overhead Facilities</td>
              <td>Use caution near facilities. Maintain safe approach limits. Report damage immediately. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_hunting"></td>
              <td>Hunting Season</td>
              <td>Know season and areas, stay together, make noise. If hunters seen, advise presence. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_housekeeping"></td>
              <td>Site Housekeeping</td>
              <td>Keep areas clean and clear of obstructions. Remove trip hazards promptly. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_h2s"></td>
              <td>H2S Concerns</td>
              <td>Only work where trained. Use gas monitor, follow SWP, and use respiratory protection if required.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_open_excavation"></td>
              <td>Open Excavation</td>
              <td>Stay back from edges. Cross only at safe points. Never jump trenches. Wear hard hat and boots.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_fences"></td>
              <td>Construction Fences – Installed</td>
              <td>Use crossings, avoid fence bases, and adjust panels slowly. Keep clear in wind and when moving panels.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wild_animals"></td>
              <td>Wild Animals</td>
              <td>Stay alert, do not approach wildlife. Carry bear spray where applicable. Secure food and garbage.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_river"></td>
              <td>River: High/Low Spring Flood</td>
              <td>Keep distance from banks. Use safe crossing points or alternate routes. Stop if conditions worsen.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_traffic"></td>
              <td>On and Off Traffic or Construction</td>
              <td>Stay visible and alert. Use spotter and eye contact. Keep setups away from travel paths. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_icy"></td>
              <td>Icy Conditions</td>
              <td>Slow down and use slip-resistant footwear. Keep hands free. Reduce driving speed and increase distance.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_noise"></td>
              <td>Excessive Noise Levels</td>
              <td>Limit exposure, use hearing protection, and set clear communication methods. Stay aware of surroundings.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wildfire"></td>
              <td>Wild Fire Hazard – Fire Ban in Effect</td>
              <td>Follow fire-ban rules. Avoid ignition sources near dry grass. Keep extinguisher ready and inspected.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_farming"></td>
              <td>Farming Operations (cattle or other animals)</td>
              <td>Make presence known, keep distance from livestock, and avoid flagging in pastures. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_landowner"></td>
              <td>Land Owner / Home Owner – Made Contact</td>
              <td>Stay calm, listen respectfully, explain work, and leave if escalating. Report to supervisor and client.</td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Job Specific Hazards</div>
            <div class="section-note">Controls and ratings auto-suggest when you leave the hazard cell.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Job Tasks</th>
              <th>Hazards</th>
              <th class="center">F</th>
              <th class="center">S</th>
              <th class="center">P</th>
              <th class="center">R</th>
              <th>Control Plan / Barriers / Procedures</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td><input type="text" name="task_1" /></td>
              <td><input type="text" name="hazard_1" placeholder="e.g. dog, traffic, construction fencing, digging, generator" /></td>
              <td class="center"><input type="text" name="f_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_1" class="risk-output" data-row="1" style="width:40px;" readonly></td>
              <td><textarea name="control_1" class="control-text" placeholder="Controls auto-suggest when you leave the hazard cell."></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_2" /></td>
              <td><input type="text" name="hazard_2" /></td>
              <td class="center"><input type="text" name="f_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_2" class="risk-output" data-row="2" style="width:40px;" readonly></td>
              <td><textarea name="control_2" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_3" /></td>
              <td><input type="text" name="hazard_3" /></td>
              <td class="center"><input type="text" name="f_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_3" class="risk-output" data-row="3" style="width:40px;" readonly></td>
              <td><textarea name="control_3" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_4" /></td>
              <td><input type="text" name="hazard_4" /></td>
              <td class="center"><input type="text" name="f_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_4" class="risk-output" data-row="4" style="width:40px;" readonly></td>
              <td><textarea name="control_4" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_5" /></td>
              <td><input type="text" name="hazard_5" /></td>
              <td class="center"><input type="text" name="f_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_5" class="risk-output" data-row="5" style="width:40px;" readonly></td>
              <td><textarea name="control_5" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_6" /></td>
              <td><input type="text" name="hazard_6" /></td>
              <td class="center"><input type="text" name="f_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_6" class="risk-output" data-row="6" style="width:40px;" readonly></td>
              <td><textarea name="control_6" class="control-text"></textarea></td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Emergency Response Plan</div>
            <div class="section-note">Type facility name or acronym (e.g., FMC, SHC, CUCC) and select from list.</div>
          </div>

          <div class="row">
            <div>
              <label for="nearest_hospital">Nearest first aid facility or hospital</label>
              <input type="text" id="nearest_hospital" name="nearest_hospital" list="facilityList" placeholder="Start typing facility name or abbreviation">
              <datalist id="facilityList"></datalist>
            </div>
            <div>
              <label for="hospital_phone">Phone #</label>
              <input type="text" id="hospital_phone" name="hospital_phone">
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="emergency_procedures">Emergency Response Procedures</label>
            <textarea id="emergency_procedures" name="emergency_procedures"></textarea>
          </div>

          <div style="margin-top:4px;">
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="first_aid_available"> First Aid Kit Available</label>
              <label><input type="checkbox" name="fire_ext_available"> Fire Extinguisher Available</label>
              <label><input type="checkbox" name="effective_comm"> Effective Method of Communication Available</label>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Acknowledgement &amp; Sign-off</div>
          </div>

          <div class="signature-grid">
            <div class="signature-box">
              <div class="signature-label">Party Chief – Signature</div>
              <canvas id="pcSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearPcSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="pc_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="pc_date"></div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Rodman – Signature</div>
              <canvas id="saSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearSaSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="sa_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="sa_date"></div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Client Rep / Safety Coordinator / Additional Rodman – Signature</div>
              <canvas id="clientSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearClientSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="client_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="client_date"></div>
              </div>
            </div>
          </div>

          <div style="margin-top:6px;">
            <label for="crew_contact">Crew Contact No.</label>
            <input type="text" id="crew_contact" name="crew_contact">
          </div>

          <div class="btn-row" id="buttonRow">
            <button type="reset" class="btn-secondary" id="resetBtn">Reset</button>
            <button type="button" class="btn-secondary" id="nameBtn">Name File</button>
            <button type="button" class="btn-primary" id="downloadBtn">Download PDF</button>
            <button type="button" class="btn-secondary" id="shareBtn">Share PDF</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="version-stamp" id="versionStamp">v3.8</div>

<!-- OFFLINE NOTE:
     Put these files beside this HTML for offline use:
     ./jspdf.umd.min.js
     ./html2canvas.min.js
-->
<script src="./jspdf.umd.min.js"
        onerror="console.error('FAILED to load jspdf.umd.min.js (check path / filename case / location)')"></script>

<script src="./html2canvas.min.js"
        onerror="console.error('FAILED to load html2canvas.min.js (check path / filename case / location)')"></script>


<script>
  // ============================================================
  // BASIC UTIL
  // ============================================================
  const downloadBtn = document.getElementById('downloadBtn');
  const shareBtn    = document.getElementById('shareBtn');
  const nameBtn     = document.getElementById('nameBtn');
  const buttonRow   = document.getElementById('buttonRow');

  let userChosenFileName = "";

  function safeFilePart(s) {
    return (s || "")
      .toString()
      .trim()
      .replace(/[\\/:*?"<>|]+/g, "")
      .replace(/\s+/g, "_")
      .slice(0, 60);
  }

  function yyyyMmDd(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function getDefaultFileName() {
    const job = safeFilePart(document.getElementById("job_number")?.value);
    const dev = safeFilePart(document.getElementById("developed_by")?.value);
    const today = yyyyMmDd(new Date());
    const parts = [job || "Job", dev || "DevelopedBy", today];
    return parts.filter(Boolean).join("_") + ".pdf";
  }

  function getFinalFileName() {
    const base = (userChosenFileName || "").trim();
    if (base) {
      const cleaned = safeFilePart(base).replace(/\.pdf$/i, "");
      return (cleaned || "WorksiteHazardAssessment") + ".pdf";
    }
    return getDefaultFileName();
  }

  if (nameBtn) {
    nameBtn.addEventListener("click", () => {
      const suggested = getDefaultFileName().replace(/\.pdf$/i, "");
      const input = prompt("Name the PDF file (without .pdf):", userChosenFileName || suggested);
      if (input === null) return;
      userChosenFileName = input.trim();
    });
  }

  // ============================================================
  // RISK CALC (R = F × S × P)
  // ============================================================
  function updateRiskForRow(row) {
    const fInput = document.querySelector('input[name="f_' + row + '"]');
    const sInput = document.querySelector('input[name="s_' + row + '"]');
    const pInput = document.querySelector('input[name="p_' + row + '"]');
    const rInput = document.querySelector('input[name="r_' + row + '"]');
    if (!fInput || !sInput || !pInput || !rInput) return;

    const f = parseInt(fInput.value, 10);
    const s = parseInt(sInput.value, 10);
    const p = parseInt(pInput.value, 10);

    if (Number.isInteger(f) && Number.isInteger(s) && Number.isInteger(p)) rInput.value = f * s * p;
    else rInput.value = "";
  }

  document.querySelectorAll('.risk-input').forEach(input => {
    input.addEventListener('input', () => {
      const row = input.getAttribute('data-row');
      if (row) updateRiskForRow(row);
    });
  });

  // ============================================================
  // SIGNATURE PADS
  // ============================================================
  function initSignaturePad(canvasId, clearButtonId) {
    const canvas = document.getElementById(canvasId);
    const clearBtn = document.getElementById(clearButtonId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let drawing = false, lastX = 0, lastY = 0;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111827';
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      const isTouch = evt.touches && evt.touches[0];
      const clientX = isTouch ? evt.touches[0].clientX : evt.clientX;
      const clientY = isTouch ? evt.touches[0].clientY : evt.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(evt) { drawing = true; const p = getPos(evt); lastX = p.x; lastY = p.y; }
    function drawLine(evt) {
      if (!drawing) return;
      const p = getPos(evt);
      ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.stroke();
      lastX = p.x; lastY = p.y;
    }
    function endDraw() { drawing = false; }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', drawLine);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e); }, { passive: false });
    canvas.addEventListener('touchmove',  e => { e.preventDefault(); drawLine(e); }, { passive: false });
    canvas.addEventListener('touchend',   e => { e.preventDefault(); endDraw(); }, { passive: false });

    if (clearBtn) clearBtn.addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
  }

  initSignaturePad('pcSignature', 'clearPcSig');
  initSignaturePad('saSignature', 'clearSaSig');
  initSignaturePad('clientSignature', 'clearClientSig');

  const resetBtn = document.getElementById('resetBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      ['pcSignature','saSignature','clientSignature'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
      });
      document.querySelectorAll('.risk-output').forEach(o => o.value = "");
      userChosenFileName = "";
      clearEmergencyAutofill();
    });
  }

  // ============================================================
  // MEDICAL FACILITIES (FULL LIST)
  // ============================================================
  const MEDICAL_FACILITIES = [
    { name:"Foothills Medical Centre", abbr:"FMC", type:"Hospital", address:"1403 29 St NW, Calgary, AB, T2N 2T9" },
    { name:"Alberta Children's Hospital", abbr:"ACH", type:"Hospital", address:"28 Oki Dr NW, Calgary, AB, T3B 6A8" },
    { name:"Peter Lougheed Centre", abbr:"PLC", type:"Hospital", address:"3500 26 Ave NE, Calgary, AB, T1Y 6J4" },
    { name:"Rockyview General Hospital", abbr:"RGH", type:"Hospital", address:"7007 14 St SW, Calgary, AB, T2V 1P9" },
    { name:"South Health Campus", abbr:"SHC", type:"Hospital", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },
    { name:"Royal Alexandra Hospital", abbr:"RAH", type:"Hospital", address:"10240 Kingsway NW, Edmonton, AB, T5H 3V9" },
    { name:"University of Alberta Hospital", abbr:"UAH", type:"Hospital", address:"8440 112 St NW, Edmonton, AB, T6G 2B7" },
    { name:"Misericordia Community Hospital", abbr:"MCH", type:"Hospital", address:"16940 87 Ave NW, Edmonton, AB, T5R 4H5" },
    { name:"Grey Nuns Community Hospital", abbr:"GNH", type:"Hospital", address:"1100 Youville Dr W, Edmonton, AB, T6L 5X8" },
    { name:"Red Deer Regional Hospital Centre", abbr:"RDRHC", type:"Hospital", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Chinook Regional Hospital", abbr:"CRH", type:"Hospital", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Medicine Hat Regional Hospital", abbr:"MHRH", type:"Hospital", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Northern Lights Regional Health Centre", abbr:"NLRHC", type:"Hospital", address:"7 Hospital St, Fort McMurray, AB, T9H 1P2" },
    { name:"Grande Prairie Regional Hospital", abbr:"GPRH", type:"Hospital", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },
    { name:"Airdrie Community Health Centre", abbr:"ACHC", type:"Community Health Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"Drumheller Health Centre", abbr:"DHC", type:"Community Health Centre", address:"351 9 St NW, Drumheller, AB, T0J 0Y1" },
    { name:"Brooks Health Centre", abbr:"BHC", type:"Community Health Centre", address:"440 3 St E, Brooks, AB, T1R 0G8" },
    { name:"Strathmore District Health Services", abbr:"SDHS", type:"Community Health Centre", address:"200 Brent Blvd, Strathmore, AB, T1P 1J9" },
    { name:"Banff Mineral Springs Hospital", abbr:"BMSH", type:"Hospital", address:"305 Lynx St, Banff, AB, T1L 1C1" },
    { name:"Canmore General Hospital", abbr:"CGH", type:"Hospital", address:"1100 Hospital Pl, Canmore, AB, T1W 1N2" },
    { name:"Airdrie Urgent Care Centre", abbr:"AUCC", type:"Urgent Care Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"South Calgary Urgent Care Centre", abbr:"SCUC", type:"Urgent Care Centre", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },
    { name:"North Edmonton Urgent Care Centre", abbr:"NEDUCC", type:"Urgent Care Centre", address:"13403 97 St NW, Edmonton, AB, T5E 4L8" },
    { name:"West Edmonton Urgent Care Centre", abbr:"WEUCC", type:"Urgent Care Centre", address:"1815 102 St NW, Edmonton, AB, T6J 4S5" },
    { name:"Northeast Edmonton Urgent Care Centre", abbr:"NEEUCC", type:"Urgent Care Centre", address:"7911 137 Ave NW, Edmonton, AB, T5C 0K9" },
    { name:"Red Deer Urgent Care Centre", abbr:"RDUCC", type:"Urgent Care Centre", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Medicine Hat Urgent Care Centre", abbr:"MHUCC", type:"Urgent Care Centre", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Grande Prairie Urgent Care Centre", abbr:"GPUCC", type:"Urgent Care Centre", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },
    { name:"Lethbridge Urgent Care Centre", abbr:"LHUCC", type:"Urgent Care Centre", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Cochrane Urgent Care Centre", abbr:"CUCC", type:"Urgent Care Centre", address:"60 Grande Blvd, Cochrane, AB, T4C 0S4" }
  ];

  const facilityInput = document.getElementById("nearest_hospital");
  const facilityList  = document.getElementById("facilityList");
  const phoneInput    = document.getElementById("hospital_phone");
  const erTextarea    = document.getElementById("emergency_procedures");

  function normalizeFacilityKey(s) {
    return (s || "").toString().trim().toLowerCase().replace(/\s+/g, " ");
  }

  function fillFacilityDatalist() {
    if (!facilityList) return;
    facilityList.innerHTML = "";
    MEDICAL_FACILITIES.forEach(f => {
      const optName = document.createElement("option");
      optName.value = f.name;
      optName.label = `${f.abbr} – ${f.type}`;
      facilityList.appendChild(optName);

      const optAbbr = document.createElement("option");
      optAbbr.value = f.abbr;
      optAbbr.label = f.name;
      facilityList.appendChild(optAbbr);
    });
  }
  fillFacilityDatalist();

  function findFacility(query) {
    const q = normalizeFacilityKey(query);
    if (!q) return null;

    let f = MEDICAL_FACILITIES.find(x => normalizeFacilityKey(x.abbr) === q);
    if (f) return f;

    f = MEDICAL_FACILITIES.find(x => normalizeFacilityKey(x.name) === q);
    if (f) return f;

    if (q.length >= 3) {
      f = MEDICAL_FACILITIES.find(x => normalizeFacilityKey(x.name).startsWith(q));
      if (f) return f;
    }

    return null;
  }

  function setEmergencyAutofill(facility) {
    if (!facility) return;
    const current = normalizeFacilityKey(facilityInput.value);
    if (current === normalizeFacilityKey(facility.abbr)) facilityInput.value = facility.name;

    phoneInput.value = "911";
    erTextarea.value =
      `Ensure your safety and move to a secure area. Call 911 for emergencies and, if needed, go to ${facility.name}, ${facility.address} for medical attention. Report the incident to your supervisor as soon as it’s safe and complete an incident report.`;
  }

  function clearEmergencyAutofill() {
    if (phoneInput) phoneInput.value = "";
    if (erTextarea) erTextarea.value = "";
  }

  if (facilityInput) {
    const handler = () => {
      const val = (facilityInput.value || "").trim();
      if (!val) { clearEmergencyAutofill(); return; }
      const match = findFacility(val);
      if (match) setEmergencyAutofill(match);
    };

    facilityInput.addEventListener("input", handler);
    facilityInput.addEventListener("change", handler);
    facilityInput.addEventListener("blur", handler);

    facilityInput.addEventListener("input", () => {
      if (!facilityInput.value.trim()) clearEmergencyAutofill();
    });
  }

  // ============================================================
  // HAZARD LIBRARY (OFFLINE, SELF-CONTAINED)
  // - Each entry has: name, keywords (string or array), risk{F,S,P,R}, controls[2]
  // - Controls are clipped to keep export tidy
  // ============================================================

  const HAZARD_LIBRARY = [
    {
     "name": "Vehicle and driving exposure (commuting, moving between sites)",
    "keywords": "H01_commute_collision,H01_site_to_site_driving,H01_fleet_travel,H01_winter_road_risk,H01_intersection_incident,H01_highway_merge,H01_backing_in_parking,H01_distracted_commute",
    "risk": { "F": 4, "S": 5, "P": 3, "R": 60 },
    "controls": [
      "Plan the trip: check road reports, weather, route and time. Build in delays, drive to conditions, and pull over if visibility or traction is poor.",
      "No phone use while driving, seatbelts always. Do a pre trip walk around and break plan to manage fatigue, distractions, and rushing."
    ]
  },
  {
    "name": "Working near moving equipment (excavators, loaders, graders, trucks)",
    "keywords": "H02_heavy_equipment_zone,H02_swing_radius_control,H02_spotter_required,H02_equipment_blindside,H02_backing_alarm_area,H02_haul_route_crossing,H02_exclusion_perimeter,H02_operator_eye_contact",
    "risk": { "F": 4, "S": 4, "P": 3, "R": 48 },
    "controls": [
      "Set an exclusion zone and stay out of swing radius and travel paths. Make eye contact with the operator and get a clear acknowledgement before entry.",
      "Wear high vis, use a spotter and agreed hand signals when needed. Never assume you are seen, stop work if equipment patterns change."
    ]
  },
  {
    "name": "Slips, trips, falls (uneven ground, cords, debris, curbs, ice)",
    "keywords": "H03_stf_uneven_grade,H03_ice_patch_trip,H03_curb_edge_fall,H03_debris_littered_path,H03_cord_tripline,H03_mud_slick_surface,H03_gravel_rollankle,H03_hidden_hole_step",
    "risk": { "F": 5, "S": 3, "P": 3, "R": 45 },
    "controls": [
      "Do a short walk through before setup, identify ice, holes and debris. Keep cords and gear out of walkways, and choose stable routes even if longer.",
      "Use footwear with traction and add cleats when needed. Slow down on uneven ground, keep hands free, and keep three points of contact on slopes."
    ]
  },
  {
    "name": "Heat exposure (warm weather, dehydration, heat exhaustion, heat stroke)",
    "keywords": "H04_warm_weather_load,H04_hot_temp_workplan,H04_heat_exhaustion_signs,H04_heat_stroke_emergency,H04_dehydration_risk,H04_electrolyte_replacement,H04_shade_break_cycle,H04_cooling_strategy",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Use a warm weather plan: drink water often, add electrolytes, schedule shaded breaks, and slow the pace during peak heat, especially in full sun.",
      "Buddy check for headache, dizziness and confusion. Stop work, cool down, and seek urgent help if heat stroke is suspected, do not push through symptoms."
    ]
  },
  {
    "name": "Cold exposure (cold weather, snow, wind chill, frostbite, hypothermia)",
    "keywords": "H05_cold_weather_conditions,H05_snow_ice_exposure,H05_windchill_factor,H05_frostbite_warning,H05_hypothermia_risk,H05_layering_plan,H05_warmup_breaks,H05_keep_dry_protocol",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Use a cold weather plan: layer clothing, keep spare dry items, protect hands and feet, and take warm up breaks. Avoid sweat buildup then cooling off.",
      "Watch for numb skin, shivering and confusion. Get to heat, change wet clothing, and stop work if symptoms develop or conditions make safe work unlikely."
    ]
  },
  {
    "name": "Thunder and lightning exposure (open areas, metal equipment, high points)",
    "keywords": "H06_thunderstorm_cell,H06_lightning_strike_risk,H06_open_field_exposure,H06_metal_tripod_concern,H06_gnss_pole_conductor,H06_ridge_line_highpoint,H06_shelter_protocol,H06_storm_standdown",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "At first thunder, stop work and move to a hard top vehicle or building. Stay there until the storm passes and conditions are stable to resume work.",
      "Avoid high points, isolated trees and open fields. Lower metal poles and tripods, and increase spacing between crew members while moving to shelter."
    ]
  },
  {
    "name": "Poor visibility (darkness, fog, snow, dust, glare)",
    "keywords": "H07_low_light_work,H07_fog_bank_visibility,H07_whiteout_condition,H07_blowing_dust_plume,H07_sun_glare_angle,H07_headlamp_dependency,H07_reflective_apparel,H07_vehicle_be_seen",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Increase visibility: wear reflective high vis, use headlamps and area lighting, and park vehicles to shield the work area without creating blind spots.",
      "Slow the work, add spotters or traffic controls, and stop work if you cannot maintain safe sightlines or if drivers cannot clearly see your setup."
    ]
  },
  {
    "name": "Fatigue (long days, early starts, repetitive driving)",
    "keywords": "H08_drowsy_operator,H08_long_shift_load,H08_early_start_cycle,H08_microsleep_risk,H08_extended_drive_time,H08_cognitive_lapse,H08_break_schedule,H08_shift_rotation",
    "risk": { "F": 4, "S": 4, "P": 3, "R": 48 },
    "controls": [
      "Set a break plan for long days and long drives, rotate tasks and drivers, and pace the day so decisions are not made while rushed or exhausted.",
      "Use fit for duty checks and Stop Work Authority. If anyone is drowsy, stop, rest and reset, do not rely on caffeine to manage fatigue."
    ]
  },
  {
    "name": "Manual handling and ergonomic strain (tripods, rods, batteries, cases)",
    "keywords": "H09_tripod_carry_strain,H09_rod_transport_overuse,H09_battery_case_lift,H09_twist_reach_posture,H09_repetitive_setups,H09_long_walk_load,H09_shoulder_overhead,H09_two_person_lift",
    "risk": { "F": 5, "S": 3, "P": 3, "R": 45 },
    "controls": [
      "Plan the carry: stage gear closer, split loads and use team lifts for heavy cases. Keep loads close to the body and avoid twisting while lifting.",
      "Change posture often and alternate tasks. Adjust tripod height to reduce bending, and take short micro breaks to prevent shoulder and back strain."
    ]
  },
  {
    "name": "Hand and power tools (hammers, picks, drills, saws when used)",
    "keywords": "H10_hammering_flying_chip,H10_drill_bit_break,H10_grinder_spark_zone,H10_kickback_event,H10_tool_vibration,H10_cutting_edge_contact,H10_handtool_slip,H10_guarding_required",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Inspect tools before use, use the right tool for the job, and keep guards on. Keep others clear of the strike zone and maintain stable footing.",
      "Wear eye and hand protection, and hearing protection when required. Stop if tools bind, kick back or feel unsafe, and correct the setup first."
    ]
  },
  {
    "name": "Pinch points and sharp edges (equipment cases, stakes, rebar, fencing)",
    "keywords": "H11_pinch_case_lid,H11_rebar_end_puncture,H11_stake_splinter_cut,H11_barbedwire_snag,H11_crush_finger_point,H11_sharp_fence_edge,H11_cut_resistant_glove,H11_safe_hand_placement",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 36 },
    "controls": [
      "Keep hands clear when closing cases, adjusting clamps and setting tripods. Wear gloves suited to the task and carry stakes with points controlled.",
      "Avoid climbing fences and keep distance from barbed wire. Flag or cap exposed rebar when possible and report sharp hazards that cannot be removed."
    ]
  },
  {
    "name": "Noise (construction zones, traffic, equipment)",
    "keywords": "H12_backup_alarm_noise,H12_traffic_roar_exposure,H12_jackhammer_proximity,H12_compactor_vibration_sound,H12_hearing_damage_risk,H12_tinnitus_prevention,H12_noise_zone_posting,H12_hearing_protection_use",
    "risk": { "F": 4, "S": 2, "P": 3, "R": 24 },
    "controls": [
      "Use hearing protection when exposed to loud equipment or traffic, and limit time in high noise areas by rotating tasks and increasing distance.",
      "Coordinate with the site to avoid the loudest operations when possible, and choose setup locations that reduce continuous noise exposure."
    ]
  },
  {
    "name": "Dust and airborne particulates (construction dust, road dust, silica risk)",
    "keywords": "H13_respirable_dust_load,H13_silica_exposure_path,H13_dust_cloud,H13_construction_particulate,H13_grinding_cutting_dust,H13_smoke_like_haze,H13_respirator_selection,H13_air_monitor_awareness",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Increase distance from dust generating tasks, position upwind when possible, and coordinate timing so you are not working beside cutting or grinding.",
      "Use respiratory protection when conditions warrant and keep hands and face clean. Do not eat or drink until you have washed or sanitized properly."
    ]
  },
  {
    "name": "Eye injuries (flying debris, brush, windblown dust)",
    "keywords": "H14_windblown_grit_eye,H14_branch_whip_strike,H14_flying_debris_contact,H14_stake_chip_splash,H14_eye_irritant_dust,H14_goggle_requirement,H14_eye_wash_access,H14_face_shield_task",
    "risk": { "F": 3, "S": 2, "P": 3, "R": 18 },
    "controls": [
      "Wear safety glasses or goggles in windy or dusty conditions and when working in brush. Keep your face out of the line of fire when hammering stakes.",
      "Carry eyewash supplies and flush immediately if debris enters the eye. Stop work until vision is clear and irritation is resolved."
    ]
  },
  {
    "name": "Sun/UV exposure (snow glare, summer UV)",
    "keywords": "H15_uv_index_peak,H15_snow_glare_reflect,H15_sunburn_risk_cycle,H15_spf_reapply_plan,H15_brim_hat_use,H15_sunglasses_polarized,H15_skin_cover_choice,H15_uv_shift_control",
    "risk": { "F": 4, "S": 2, "P": 3, "R": 24 },
    "controls": [
      "Use sunscreen, brimmed hat and UV rated eyewear. Cover exposed skin and reapply sunscreen during the day, especially with wind and reflection.",
      "Plan shaded breaks and hydration, and watch for sun illness signs. Adjust duties if glare or UV makes safe work difficult."
    ]
  },
  {
    "name": "Communication failures (poor cell service, radio issues, missed check-ins)",
    "keywords": "H16_dead_zone_contact,H16_radio_dropout,H16_missed_checkin_timer,H16_no_signal_escalation,H16_sat_messenger_option,H16_emergency_call_plan,H16_contact_tree,H16_location_share_method",
    "risk": { "F": 3, "S": 4, "P": 2, "R": 24 },
    "controls": [
      "Use a check in and check out plan with set times, who to contact and what steps to follow if a check in is missed or delayed.",
      "Carry the right communication tools for the area and keep devices charged. Share work location, access routes and nearest help point before starting."
    ]
  },
  {
    "name": "Working alone / limited supervision (lone worker risk)",
    "keywords": "H17_lone_worker_status,H17_isolated_tasking,H17_no_spotter_present,H17_delayed_firstaid,H17_buddy_system_trigger,H17_solo_site_entry,H17_lonework_protocol,H17_emergency_self_rescue",
    "risk": { "F": 3, "S": 4, "P": 2, "R": 24 },
    "controls": [
      "Follow lone worker rules with scheduled check ins and clear limits on higher risk tasks. Keep the vehicle accessible as shelter and for quick exit.",
      "When conditions change, stop and reassess. If risk increases, request a second worker or spotter and do not continue alone in an unsafe situation."
    ]
  },
  {
    "name": "General public exposure (pedestrians, bystanders, curious onlookers)",
    "keywords": "H18_bystander_intrusion,H18_public_proximity_zone,H18_kids_nearby_awareness,H18_crowd_flow_conflict,H18_public_touch_equipment,H18_unplanned_interactions,H18_site_signage,H18_barrier_setup",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 36 },
    "controls": [
      "Create a small work boundary using cones, flags or signage and place tripods and rods so the public cannot easily walk through the setup.",
      "Pause work if people enter the hazard zone, communicate calmly and reposition if needed. Treat children and pets as unpredictable hazards."
    ]
  },
  {
    "name": "Landowners / homeowners interactions (access permission, conflict, dogs, private property hazards)",
    "keywords": "H19_landowner_permission,H19_homeowner_access_issue,H19_private_property_entry,H19_gate_lock_encounter,H19_resident_complaint,H19_right_of_entry,H19_property_dispute,H19_yard_hazard_unknown",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Confirm permission or right of entry before entering private property, carry ID, and explain the work briefly and professionally if approached.",
      "If conflict develops, disengage and move to a safe place, contact your supervisor and document details. Do not argue or continue if unsafe."
    ]
  },
  {
    "name": "Mental stress, time pressure, difficult interactions",
    "keywords": "H20_deadline_pressure,H20_rushed_decisions,H20_verbal_abuse_stressor,H20_confrontation_stress,H20_cognitive_overload,H20_focus_loss,H20_break_reset,H20_support_chain",
    "risk": { "F": 4, "S": 2, "P": 3, "R": 24 },
    "controls": [
      "Set realistic targets and slow down when rushed. Use short resets to reduce mistakes, and speak up early if timelines force unsafe decisions.",
      "Use the support chain when interactions become hostile, leave the area if needed, and report concerns so follow up can be handled properly."
    ]
  },

  {
    "name": "Traffic exposure (high-speed roads, intersections, turning vehicles)",
    "keywords": "H21_intersection_turning_risk,H21_highspeed_corridor,H21_lane_closure_setup,H21_shoulder_workflow,H21_cone_taper_layout,H21_flagging_need,H21_buffer_vehicle_use,H21_escape_route_plan",
    "risk": { "F": 4, "S": 5, "P": 3, "R": 60 },
    "controls": [
      "Set traffic controls for the location: cones, signage and safe vehicle placement. Work facing traffic when possible and keep an escape route open.",
      "Increase separation from live lanes and avoid standing in traffic. Stop work if the setup cannot be maintained or drivers behave unpredictably."
    ]
  },
  {
    "name": "Distracted drivers (phones, construction confusion)",
    "keywords": "H22_texting_driver,H22_rubberneck_slowdown,H22_unexpected_lane_change,H22_confused_detour_route,H22_aggressive_merge,H22_sudden_stop_event,H22_phone_glow_night,H22_driver_inattention",
    "risk": { "F": 4, "S": 5, "P": 3, "R": 60 },
    "controls": [
      "Assume drivers do not see you. Add buffer space, stand back from the edge, and place cones early enough to warn distracted drivers.",
      "Use a spotter to watch traffic when needed and pause work during high risk moments such as merges, turning movements and congestion surges."
    ]
  },
  {
    "name": "Working near cyclists, e-scooters, pedestrians (active transportation)",
    "keywords": "H23_cycle_lane_conflict,H23_escooter_fast_pass,H23_sidewalk_user_flow,H23_pathway_crossing,H23_schoolzone_active,H23_jogger_surprise,H23_stroller_space,H23_trail_intersection",
    "risk": { "F": 4, "S": 4, "P": 3, "R": 48 },
    "controls": [
      "Keep equipment out of travel paths and set a visible boundary. Leave clear passage space and do not stretch tapes or rods across active routes.",
      "Use a spotter when activity is high and reposition or pause work as users pass. Be extra cautious in school zones and parks."
    ]
  },
  {
    "name": "Backing and blind spots (delivery trucks, equipment, alleys)",
    "keywords": "H24_alley_backing_zone,H24_delivery_truck_blind,H24_tight_access_point,H24_backover_nearmiss,H24_mirror_gap_risk,H24_reverse_alarm_limit,H24_spotter_hand_signals,H24_loading_dock_area",
    "risk": { "F": 4, "S": 4, "P": 3, "R": 48 },
    "controls": [
      "Identify backing routes and never stand behind vehicles. Choose a safe position before setup and keep it even if it adds walking time.",
      "Use clear communication with drivers and a spotter in tight spaces. Move out early if any vehicle starts to reverse toward your work area."
    ]
  },
  {
    "name": "Parkades and confined areas (low clearance, poor lighting, exhaust/CO potential)",
    "keywords": "H25_parkade_lowclear,H25_confined_ramp_turn,H25_poor_lighting_zone,H25_exhaust_buildup,H25_CO_alarm_need,H25_ventilation_limit,H25_echo_noise_confusion,H25_tight_ped_mix",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Confirm clearance and traffic flow before entry, use extra lighting and slow movements. Keep escape routes clear and avoid working in blind corners.",
      "Limit exposure to exhaust by avoiding idling and leaving the area if air feels stale or symptoms appear. Move outside to fresh air and report concerns."
    ]
  },
  {
    "name": "Utilities and excavations (open holes, trench edges, vaults, manholes)",
    "keywords": "H26_open_hole_edge,H26_trench_collapse_margin,H26_vault_lid_shift,H26_manhole_adjacent,H26_underground_services,H26_locate_marks_present,H26_excavation_perimeter,H26_fall_protection_need",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Stay back from trench edges and open holes, use barriers and do not enter excavations unless authorized with proper controls and oversight.",
      "Coordinate with the prime contractor, respect locate markings, and do not disturb ground until locates and excavation safety requirements are confirmed."
    ]
  },
  {
    "name": "Struck-by hazards from construction activity (falling materials, swing radius)",
    "keywords": "H27_overhead_work_zone,H27_dropped_object_risk,H27_suspended_load_path,H27_crane_lift_area,H27_material_stack_fall,H27_tool_drop_exposure,H27_hardhat_mandatory,H27_exclusion_under_load",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Stay out of drop zones and never work under suspended loads. Follow barricades and signage and wear hard hat where required by the site.",
      "Plan your setup away from overhead tasks and coordinate timing with crews. If lifting or overhead work starts nearby, move and reassess."
    ]
  },
  {
    "name": "Public conflict / harassment (angry residents, businesses, trespass disputes)",
    "keywords": "H28_aggressive_resident,H28_business_owner_conflict,H28_trespass_accusation,H28_threatening_language,H28_deescalation_required,H28_safe_withdrawal,H28_supervisor_call,H28_incident_documentation",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Use calm, respectful language and brief explanations. Do not argue, and disengage early if the person becomes angry or confrontational.",
      "Move to a safe location, contact your supervisor, and document what happened. Request support before returning to the area if needed."
    ]
  },
  {
    "name": "Dogs in yards / residential areas",
    "keywords": "H29_dog_bite_risk,H29_offleash_encounter,H29_yard_gate_entry,H29_barking_warning,H29_animal_charge,H29_owner_not_present,H29_safe_retreat,H29_dog_deterrent_plan",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Look and listen for dogs before entering yards, do not enter if a dog is loose. Ask the homeowner to secure pets before work begins.",
      "Keep distance and an exit path, avoid sudden movements. If threatened, retreat to the vehicle and wait or relocate the work."
    ]
  },
  {
    "name": "Needlestick / sharps exposure (alleys, parks, encampment areas)",
    "keywords": "H30_syringe_on_ground,H30_sharps_in_grass,H30_encampment_debris,H30_alley_cleanup_risk,H30_puncture_injury,H30_tongs_pickup_only,H30_sharps_container_use,H30_report_exposure",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 16 },
    "controls": [
      "Do not pick up sharps by hand. Use tongs and a sharps container, or leave them in place and report or cordon off the area as per procedure.",
      "Scan the ground before kneeling or reaching, wear proper gloves and footwear, and follow exposure response steps immediately if a puncture occurs."
    ]
  },
  {
    "name": "Biohazards (human waste, contaminated surfaces, discarded PPE)",
    "keywords": "H31_human_waste_contact,H31_bloodborne_risk,H31_contaminated_surface,H31_discarded_PPE_litter,H31_infection_pathway,H31_hand_hygiene_critical,H31_disinfect_after_work,H31_glove_use_required",
    "risk": { "F": 2, "S": 3, "P": 2, "R": 12 },
    "controls": [
      "Avoid contact and keep distance from contaminated areas. Use gloves, wash or sanitize hands often, and disinfect tools and equipment after exposure risk.",
      "Do not eat or drink in contaminated zones. If contamination is significant, relocate the work and report conditions for cleanup or follow up."
    ]
  },
  {
    "name": "Overhead hazards (powerlines, scaffolding, cranes)",
    "keywords": "H32_overhead_powerline_clear,H32_service_drop_low,H32_scaffold_overhang,H32_crane_boom_sweep,H32_overhead_obstruction,H32_electrocution_clearance,H32_look_up_check,H32_no_raise_pole_near",
    "risk": { "F": 3, "S": 5, "P": 2, "R": 30 },
    "controls": [
      "Look up before raising poles or tripods and keep safe clearance from overhead powerlines and structures. Treat all lines as energized.",
      "If clearance is uncertain, stop and reposition the setup. Contact the site supervisor or utility owner before continuing near overhead hazards."
    ]
  },
  {
    "name": "Rail/LRT/industrial spur exposure (where applicable)",
    "keywords": "H33_rail_rightofway,H33_crossing_signal_zone,H33_track_trip_hazard,H33_train_approach_risk,H33_lrt_platform_edge,H33_industrial_spur_access,H33_no_trespass_rule,H33_hearing_train_warning",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Only access rail areas with authorization and required controls. Stay off tracks and out of the right of way unless you have approved access.",
      "Stay alert for approaching rail equipment, obey signals, and keep a safe distance from moving trains. Do not assume operators can stop quickly."
    ]
  },
  {
    "name": "Property hazards (barbed wire, broken glass, hidden holes, sprinkler boxes)",
    "keywords": "H34_broken_glass_yard,H34_sprinkler_box_trip,H34_hidden_landscape_hole,H34_fenceline_barbedwire,H34_nails_scrap_metal,H34_culvert_edge_drop,H34_sharp_debris_path,H34_private_yard_obstacles",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 36 },
    "controls": [
      "Scan the ground and choose safe routes, avoid shortcuts through debris. Wear appropriate footwear and gloves when working near fences and scrap.",
      "If hazards are extensive, re route the work and notify the team. Flag hazards that cannot be removed and keep the crew aware during the task."
    ]
  },

  {
    "name": "Highway driving and shoulder work (high speeds, narrow shoulders)",
    "keywords": "H35_narrow_shoulder_exposure,H35_highspeed_passby,H35_semi_windblast,H35_gravel_shoulder_slide,H35_pullout_positioning,H35_rumble_strip_edge,H35_roadside_escape,H35_conspicuity_highway",
    "risk": { "F": 4, "S": 5, "P": 3, "R": 60 },
    "controls": [
      "Park and set up to maximize separation from traffic, keep equipment off the live lane, and always maintain an escape route and situational awareness.",
      "Use warning devices and high vis, avoid shoulder work during poor visibility or peak traffic. Move the work if the shoulder is too narrow to be safe."
    ]
  },
  {
    "name": "Wildlife encounters (moose, deer, bears, cougars, coyotes)",
    "keywords": "H36_moose_encounter,H36_bear_presence,H36_cougar_sign,H36_coyote_pack,H36_wildlife_tracks,H36_dawn_dusk_risk,H36_bear_spray_ready,H36_back_away_protocol",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Stay alert for tracks, scat and fresh signs, make noise in brush and keep deterrents accessible where appropriate for the area and season.",
      "If wildlife is seen, do not approach. Retreat to the vehicle, regroup the crew and change the plan, including delaying work or relocating."
    ]
  },
  {
    "name": "Livestock and farm hazards (bulls, aggressive animals, electric fences)",
    "keywords": "H37_bull_in_pasture,H37_electric_fence_contact,H37_herd_behavior,H37_gate_handling,H37_trample_risk,H37_ranch_access,H37_animal_aggression,H37_farmyard_movement",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 16 },
    "controls": [
      "Coordinate with the landowner before entering pastures, confirm where animals are located and use gates properly, never climb electric fences.",
      "Keep distance and avoid separating animals. If animals approach or become agitated, retreat to a safe area and reassess access and route."
    ]
  },
  {
    "name": "Remote work risks (delayed emergency response, no cell service)",
    "keywords": "H38_remote_response_delay,H38_no_service_area,H38_long_distance_help,H38_solo_remote_task,H38_satellite_checkin,H38_emergency_coordinates,H38_vehicle_as_shelter,H38_trip_plan_required",
    "risk": { "F": 3, "S": 4, "P": 2, "R": 24 },
    "controls": [
      "Share route, access points, expected return time and exact coordinates. Use scheduled check ins and clear escalation steps if contact is missed.",
      "Carry comms and emergency gear for the area and season. If conditions change or you lose reliable contact, stop and relocate to safer ground."
    ]
  },
  {
    "name": "Terrain hazards (steep slopes, loose rock, muskeg, coulees, riverbanks)",
    "keywords": "H39_steep_slope_slide,H39_loose_rock_roll,H39_muskeg_sink,H39_coulee_edge,H39_erosion_bank,H39_washout_crossing,H39_ankle_roll_zone,H39_unstable_ground_probe",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 36 },
    "controls": [
      "Assess footing before stepping and avoid edges, loose rock and unstable banks. Choose safer routes and do not rush across questionable terrain.",
      "Work in pairs in higher risk terrain, keep spacing between workers and stop if ground becomes unstable or weather makes the route unsafe."
    ]
  },
  {
    "name": "Water hazards (creeks, irrigation canals, ice, fast flow)",
    "keywords": "H40_irrigation_canal_edge,H40_fast_flow_crossing,H40_slippery_bank,H40_thin_ice_breakthrough,H40_cold_water_immersion,H40_wader_risk,H40_drowning_hazard,H40_no_crossing_rule",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Avoid unnecessary crossings and keep back from canal and creek edges. Do not travel on unknown ice and do not jump banks or culverts.",
      "Use a buddy approach near water and plan alternate access points. If you must work near water, keep the vehicle accessible and maintain communication."
    ]
  },
  {
    "name": "ATVs/UTVs/snowmobiles (if used: rollover, ejection, visibility)",
    "keywords": "H41_ATV_rollover,H41_UTV_ejection,H41_snowmobile_whiteout,H41_trail_obstacle,H41_helmet_required,H41_speed_control,H41_recovery_strap_use,H41_machine_visibility_flag",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 16 },
    "controls": [
      "Use only trained and authorized operators, wear required PPE and keep speeds low for terrain. Do not carry unsecured loads that shift.",
      "Ride with a buddy where possible, use visibility flags and avoid steep slopes and water edges. Stop if visibility or traction becomes poor."
    ]
  },
  {
    "name": "Getting stuck / stranded (mud, snow, poor roads)",
    "keywords": "H42_vehicle_stuck_mud,H42_snow_drift_strand,H42_poor_road_access,H42_breakdown_no_help,H42_winch_recovery,H42_tow_plan,H42_winter_kit_ready,H42_fuel_range_check",
    "risk": { "F": 3, "S": 4, "P": 2, "R": 24 },
    "controls": [
      "Check access before travel, avoid questionable roads and carry recovery gear and seasonal emergency supplies suited to the area and distance.",
      "Keep fuel topped up and maintain the vehicle. Share location and return time and turn around early if roads deteriorate or you lose safe access."
    ]
  },
  {
    "name": "Wildfire smoke and poor air quality",
    "keywords": "H43_smoke_haze_exposure,H43_AQHI_alert,H43_respiratory_irritation,H43_visibility_smoke,H43_ash_fall,H43_mask_fit_smoke,H43_limit_exertion,H43_relocate_work_area",
    "risk": { "F": 2, "S": 3, "P": 3, "R": 18 },
    "controls": [
      "Monitor AQHI and visibility, reduce exertion and add breaks when smoke is present. Keep windows closed and use clean air spaces when available.",
      "Use respiratory protection when appropriate and relocate or stop work if breathing becomes difficult or visibility affects traffic and equipment safety."
    ]
  },
  {
    "name": "Hunting areas / firearms presence (seasonal, mistaken identity risk)",
    "keywords": "H44_hunting_season_zone,H44_blaze_orange_need,H44_crown_land_activity,H44_gunshot_nearby,H44_mistaken_identity,H44_high_vis_contrast,H44_avoid_active_area,H44_notify_landowner_hunt",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Plan with seasonal awareness and avoid known active hunting areas. Wear high visibility clothing suitable for the environment and keep the crew together.",
      "If hunters are present or gunfire is heard nearby, leave the area and notify supervision or the landowner. Do not continue work in an active zone."
    ]
  },
  {
    "name": "Agricultural equipment and chemicals (sprayers, combines, pesticides/fertilizers)",
    "keywords": "H45_combine_movement,H45_sprayer_drift,H45_pesticide_exposure,H45_fertilizer_contact,H45_PTO_entanglement,H45_farmyard_traffic,H45_chemical_label_check,H45_avoid_active_spraying",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 16 },
    "controls": [
      "Stay clear of moving farm machinery and keep out of travel paths. Coordinate with operators and landowners before entering active work zones or yards.",
      "Avoid areas being sprayed and position upwind. If you suspect exposure, leave the area, wash up and follow SDS guidance and reporting steps."
    ]
  },
  {
    "name": "Insects and bites (ticks, mosquitoes, wasps), allergic reactions",
    "keywords": "H46_tick_check_protocol,H46_wasp_nest_proximity,H46_mosquito_swarm,H46_bee_sting_anaphylaxis,H46_bug_repellent_use,H46_long_grass_exposure,H46_epipen_access,H46_bite_reporting",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Use repellent and protective clothing, avoid known nests and reduce time in heavy insect areas. Do tick checks after work in brush or long grass.",
      "Know allergy risks and have a response plan. Use first aid promptly and seek urgent medical help for breathing issues, swelling or severe reactions."
    ]
  },
  {
    "name": "Overhead powerlines in open areas (long spans, line-of-sight issues)",
    "keywords": "H47_transmission_span_sag,H47_poleline_over_field,H47_wire_visibility_issue,H47_clearance_estimation,H47_raise_pole_hazard,H47_open_area_lines,H47_stop_before_lift,H47_reposition_away_line",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Identify overhead lines early and confirm safe clearance before raising GNSS poles or tripods. Treat all wires as energized and keep wide spacing.",
      "If you cannot confirm clearance, do not lift. Reposition the setup and contact the utility or site contact before continuing near overhead lines."
    ]
  },
  {
    name: "Oilfield/industrial sites (H2S potential, industrial traffic, restricted areas)",
      keywords: "H48_H2S_potential,H48_lease_traffic,H48_industrial_gate_access,H48_muster_point_known,H48_site_orientation_required,H48_PPE_site_rules,H48_restricted_area_entry,H48_stop_work_if_alarm",
      risk: { F: 2, S: 5, P: 2, R: 20 },
      controls: [
        "Complete site sign in and orientation, follow PPE and access rules and know alarms and muster points. Do not enter restricted areas without approval.",
        "Drive slowly on lease roads and expect industrial traffic. Stop work and leave if alarms sound, unsafe conditions develop or H2S controls are required."
      ]
    },

    {
      name: "Construction fencing and temporary panels (unstable panels, heavy lifts, wind)",
      keywords: "H49_temp_fence_panels,H49_unstable_fence_section,H49_windblown_fencing,H49_panel_tip_over,H49_fence_setup_area,H49_zip_tie_securement,H49_no_parking_near_fence,H49_panel_carry_lift",
      risk: { F: 3, S: 4, P: 3, R: 36 },
      controls: [
        "Treat temp fencing as unstable, especially in wind. Do not set up equipment or park beside leaning or unsecured panels, keep a safe buffer zone.",
        "If access requires moving panels, use team lifts and control the panel at all times. Carry zip ties and re secure panels before leaving the area."
      ]
    }
  ];
  function clipControl(text, max = 185) {
    const t = (text || "").replace(/\s+/g, " ").trim();
    if (t.length <= max) return t;
    return t.slice(0, max - 1).trimEnd() + "…";
  }

  function normalize(text) {
    return (text || "")
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function stemToken(tok) {
    let t = tok;
    if (t.length <= 3) return t;
    if (t.endsWith("ies") && t.length > 4) t = t.slice(0, -3) + "y";
    else if (t.endsWith("es") && t.length > 4) t = t.slice(0, -2);
    else if (t.endsWith("s") && t.length > 3) t = t.slice(0, -1);
    if (t.endsWith("ing") && t.length > 5) t = t.slice(0, -3);
    return t;
  }

  function tokens(text) {
    const n = normalize(text);
    if (!n) return [];
    return n.split(" ").map(stemToken).filter(Boolean);
  }

  function hashString(str) {
    let h = 2166136261;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }

  function getKeywordsArray(entry) {
    if (!entry || entry.keywords == null) return [];
    if (Array.isArray(entry.keywords)) return entry.keywords.map(s => String(s));
    return String(entry.keywords)
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);
  }

  function scoreEntry(entry, hazardNorm, hazardTokens) {
  let score = 0;
  const hs = new Set(hazardTokens);
  const kws = getKeywordsArray(entry);

  let matchedTokens = 0;

  for (const k of kws) {
    const kn = normalize(k);
    if (!kn) continue;

    if (hazardNorm === kn) {
      score += 30;
      matchedTokens += 2;
      continue;
    }

    if (kn.includes(" ") && hazardNorm.includes(kn)) {
      score += 18;
      matchedTokens += 2;
      continue;
    }

    const ktoks = tokens(k);
    for (const t of ktoks) {
      if (hs.has(t)) {
        matchedTokens++;
        score += (ktoks.length === 1 ? 8 : 2);
      }
    }
  }

  for (const t of tokens(entry.name)) {
    if (hs.has(t)) {
      matchedTokens++;
      score += 2;
    }
  }

  if (matchedTokens >= 2) score += 4;
  if (matchedTokens >= 3) score += 6;

  return score;
}

function bestEntryForHazard(hazardText) {
  const hazardNorm = normalize(hazardText);
  if (!hazardNorm) return null;

  const htoks = tokens(hazardText);
  let best = null;
  let bestScore = 0;

  for (const entry of HAZARD_LIBRARY) {
    const s = scoreEntry(entry, hazardNorm, htoks);
    if (s > bestScore) { bestScore = s; best = entry; }
  }

  if (!best || bestScore < 8) return null;
  return best;
}

  function clearRow(row) {
    const f = document.querySelector(`input[name="f_${row}"]`);
    const s = document.querySelector(`input[name="s_${row}"]`);
    const p = document.querySelector(`input[name="p_${row}"]`);
    const r = document.querySelector(`input[name="r_${row}"]`);
    const c = document.querySelector(`textarea[name="control_${row}"]`);
    if (f) f.value = "";
    if (s) s.value = "";
    if (p) p.value = "";
    if (r) r.value = "";
    if (c) c.value = "";
  }

  function applyEntryToRow(entry, row, hazardText) {
    const controlField = document.querySelector(`textarea[name="control_${row}"]`);
    const fField = document.querySelector(`input[name="f_${row}"]`);
    const sField = document.querySelector(`input[name="s_${row}"]`);
    const pField = document.querySelector(`input[name="p_${row}"]`);

    const idx = (hashString(`${row}|${hazardText}|${entry.name}`) % 2);
    const chosen = clipControl((entry.controls && entry.controls[idx]) || "");

    if (controlField) {
      if (!controlField.value || controlField.value.trim().length < 15) controlField.value = chosen;
    }

    const rt = entry.ratings || (entry.risk ? { f: entry.risk.F, s: entry.risk.S, p: entry.risk.P } : null);
    if (rt) {
      if (fField && !fField.value && rt.f) fField.value = String(rt.f);
      if (sField && !sField.value && rt.s) sField.value = String(rt.s);
      if (pField && !pField.value && rt.p) pField.value = String(rt.p);
    }
    updateRiskForRow(row);
  }

  function initHazardAutoSuggest() {
    document.querySelectorAll('input[name^="hazard_"]').forEach(input => {
      input.addEventListener('blur', e => {
        const hazardText = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];

        if (!hazardText) { clearRow(row); return; }

        const entry = bestEntryForHazard(hazardText);
        if (!entry) { updateRiskForRow(row); return; }

        applyEntryToRow(entry, row, hazardText);
      });

      input.addEventListener('input', e => {
        const value = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];
        if (!value) clearRow(row);
      });
    });
  }

  initHazardAutoSuggest();

  // ============================================================
  // PDF EXPORT (LEGAL, FIXES TEXTAREA RENDERING)
  // ============================================================
  function copyFormValuesToClone(original, clone) {
    const origFields = original.querySelectorAll("input, textarea, select");
    origFields.forEach(orig => {
      const name = orig.getAttribute("name");
      const id = orig.getAttribute("id");

      let sel = null;
      if (id) sel = clone.querySelector(`#${CSS.escape(id)}`);
      if (!sel && name) sel = clone.querySelector(`[name="${CSS.escape(name)}"]`);
      if (!sel) return;

      if (orig.tagName.toLowerCase() === "textarea") {
        sel.value = orig.value;
        sel.textContent = orig.value;
      } else if (orig.type === "checkbox") {
        sel.checked = orig.checked;
        if (orig.checked) sel.setAttribute("checked", "checked");
        else sel.removeAttribute("checked");
      } else {
        sel.value = orig.value;
        sel.setAttribute("value", orig.value);
      }
    });

    ["pcSignature","saSignature","clientSignature"].forEach(cid => {
      const origCanvas = document.getElementById(cid);
      const cloneCanvas = clone.querySelector(`#${CSS.escape(cid)}`);
      if (!origCanvas || !cloneCanvas) return;

      const rect = cloneCanvas.getBoundingClientRect();
      cloneCanvas.width = Math.floor((rect.width || 300));
      cloneCanvas.height = Math.floor((rect.height || 80));
      const cctx = cloneCanvas.getContext("2d");
      const img = new Image();
      img.onload = () => {
        cctx.clearRect(0,0,cloneCanvas.width, cloneCanvas.height);
        cctx.drawImage(img, 0, 0, cloneCanvas.width, cloneCanvas.height);
      };
      img.src = origCanvas.toDataURL("image/png");
    });
  }

  function expandTextareasForExport(cloneRoot) {
    cloneRoot.querySelectorAll("textarea").forEach(t => {
      t.style.height = "auto";
      t.style.minHeight = "0";
      t.style.maxHeight = "none";
      t.style.overflow = "visible";
      t.textContent = t.value || t.textContent || "";
      t.style.height = (t.scrollHeight + 2) + "px";
    });
  }

  function createFilteredFormClone() {
    const form = document.getElementById('hazardForm');
    const clone = form.cloneNode(true);

    copyFormValuesToClone(form, clone);

    const commonTableBody = clone.querySelector('#commonHazardsTable tbody');
    if (commonTableBody) {
      Array.from(commonTableBody.rows).forEach(row => {
        const appliesCheckbox = row.querySelector('td:first-child input[type="checkbox"]');
        if (appliesCheckbox && !appliesCheckbox.checked) row.remove();
      });
      if (commonTableBody.rows.length === 0) {
        const tbl = clone.querySelector("#commonHazardsTable");
        if (tbl) tbl.remove();
      }
    }

    const clonedButtonRow = clone.querySelector('#buttonRow');
    if (clonedButtonRow) clonedButtonRow.style.display = 'none';

    const dl = clone.querySelector("#facilityList");
    if (dl) dl.remove();

    const stamp = document.getElementById("versionStamp");
    if (stamp) clone.appendChild(stamp.cloneNode(true));

    expandTextareasForExport(clone);
    return clone;
  }

 async function generatePdf() {
  // jsPDF can be exposed as window.jspdf.jsPDF (UMD) OR window.jsPDF (some builds)
  const jsPDFCtor = window.jspdf?.jsPDF || window.jsPDF;
  const h2c = window.html2canvas;

  const hasJsPDF = (typeof jsPDFCtor === "function");
  const hasH2C = (typeof h2c === "function");

  if (!hasJsPDF || !hasH2C) {
    const missing = [
      !hasJsPDF ? "jsPDF (jspdf.umd.min.js)" : null,
      !hasH2C ? "html2canvas (html2canvas.min.js)" : null
    ].filter(Boolean).join(" and ");

    alert(
      `Missing PDF libraries: ${missing}.\n\n` +
      `Open your browser DevTools → Console/Network to see if the .js files are 404/not loading.\n` +
      `Also confirm filenames are EXACT (GitHub Pages is case-sensitive).`
    );

    console.error("Library check failed:", {
      "window.jspdf": window.jspdf,
      "window.jspdf?.jsPDF": window.jspdf?.jsPDF,
      "window.jsPDF": window.jsPDF,
      "window.html2canvas": window.html2canvas
    });

    throw new Error("Missing libraries: " + missing);
  }

  const pdf = new jsPDFCtor("p", "mm", "legal");

    const clone = createFilteredFormClone();

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.style.width = '1050px';
    tempContainer.style.background = '#ffffff';
    tempContainer.appendChild(clone);
    document.body.appendChild(tempContainer);

    await new Promise(r => setTimeout(r, 180));

    const clonePage1 = clone.querySelector('#page1');
    const clonePage2 = clone.querySelector('#page2');

    async function addPage(div, addNew) {
      if (!div) return;
      if (addNew) pdf.addPage();

      expandTextareasForExport(clone);

      const canvas = await h2c(div, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
        windowWidth: 1050
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 8;

      let imgW = pageWidth - margin * 2;
      let imgH = canvas.height * (imgW / canvas.width);

      if (imgH > pageHeight - margin * 2) {
        imgH = pageHeight - margin * 2;
        imgW = canvas.width * (imgH / canvas.height);
      }

      const x = (pageWidth - imgW) / 2;
      const y = margin;
      pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH);
    }

    await addPage(clonePage1, false);
    await addPage(clonePage2, true);

    document.body.removeChild(tempContainer);
    return pdf;
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        pdf.save(getFinalFileName());
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        const blob = pdf.output('blob');
        const fileName = getFinalFileName();
        const file = new File([blob], fileName, { type: 'application/pdf' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'Worksite Hazard Assessment',
            text: 'VistaGeomatics – Worksite Hazard Assessment PDF'
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
      } catch (e) {
        console.error('Share failed:', e);
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }
</script>
</body>
</html>
