<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VistaGeomatics – Worksite Hazard Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --vista-blue: #165f7d;
      --vista-blue-light: #2a7fa3;
      --vista-blue-dark: #0b3045;
      --bg-body: #eef3f9;
      --bg-card: #ffffff;
      --border-soft: #d6e2f0;
      --text-main: #101827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top, #f4f8fc 0, #e4edf6 40%, #dde6f3 100%);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    .page-wrap {
      max-width: 1050px;
      margin: 0 auto;
    }

    .container {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 14px 30px rgba(5, 41, 66, 0.18), 0 0 0 1px rgba(5, 41, 66, 0.04);
      overflow: hidden;
      position: relative;
      margin-bottom: 18px;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(22,95,125,0.16), transparent 55%);
      opacity: 0.9;
    }

    .header-bar {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: linear-gradient(120deg, var(--vista-blue-light) 0%, var(--vista-blue) 40%, var(--vista-blue-dark) 100%);
      color: #fff;
    }

    .header-left h1 {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .header-left p {
      margin: 2px 0 0;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .header-logo {
      height: 60px;
      filter: drop-shadow(0 5px 14px rgba(0,0,0,0.35));
    }

    .page-title-bar {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 10px 20px 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.78), #f7faff);
    }

    .page-title-main {
      font-family: "Montserrat", sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--vista-blue-dark);
    }

    .page-title-sub {
      margin-top: 3px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .page-title-accent {
      width: 120px;
      height: 3px;
      margin: 8px auto 0;
      border-radius: 999px;
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      box-shadow: 0 0 8px rgba(46,167,224,0.65);
    }

    .page-body {
      position: relative;
      z-index: 1;
      padding: 10px 18px 14px;
      font-size: 0.8rem;
    }

    label {
      font-size: 0.78rem;
      font-weight: 600;
      display: block;
      margin-bottom: 2px;
      color: var(--text-main);
    }

    /* ===== INPUT/TEXT CLIPPING FIX (Safari/iPad + general) ===== */
    input[type="text"],
    input[type="date"],
    input[type="time"],
    textarea,
    .small-input {
      width: 100%;
      font-family: "Inter", sans-serif;
      font-size: 0.74rem;
      line-height: 1.25;
      color: var(--text-main);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      transition: 0.15s;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    .small-input {
      height: 34px;
      padding: 6px 8px;
      vertical-align: middle;
    }

    textarea {
      padding: 6px 8px;
      min-height: 56px;
      resize: vertical;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--vista-blue-light);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(38,132,168,0.18);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .row > div {
      flex: 1;
      min-width: 150px;
    }

    .section-card {
      margin-top: 8px;
      padding: 8px 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, #fbfdff 0%, #f4f8fd 60%, #eff5fb 100%);
      box-shadow: 0 6px 16px rgba(5, 41, 66, 0.05);
      position: relative;
    }

    .section-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      border-radius: 12px 12px 0 0;
      background: linear-gradient(90deg, var(--vista-blue-light), var(--vista-blue-dark));
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 4px;
    }

    .section-title {
      font-weight: 600;
      font-size: 0.86rem;
      color: var(--vista-blue-dark);
      font-family: "Montserrat", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .section-note {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .inline-checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.76rem;
      align-items: center;
    }

    .inline-checkbox-group label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      margin-bottom: 0;
    }

    input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--vista-blue);
      margin: 0;
    }

    .small-text {
      font-size: 0.74rem;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    th, td {
      border: 1px solid var(--border-soft);
      padding: 3px 4px;
      vertical-align: top;
    }

    th {
      background: #e8f0fb;
      font-weight: 600;
      color: var(--vista-blue-dark);
    }

    td {
      background: #f9fbff;
    }

    .center { text-align: center; }

    .signature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .signature-box {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      padding: 6px;
      font-size: 0.78rem;
    }

    .signature-label {
      font-size: 0.74rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .signature-canvas {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      display: block;
      cursor: crosshair;
    }

    .signature-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .signature-actions button {
      padding: 3px 10px;
      font-size: 0.7rem;
      letter-spacing: 0.05em;
    }

    .signature-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .signature-row > div { flex: 1; }

    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      color: #fff;
      box-shadow: 0 8px 20px rgba(5, 41, 66, 0.35);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: var(--text-main);
      border: 1px solid #d6d7dd;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 9px 22px rgba(15, 23, 42, 0.18);
    }

    .control-text {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      padding: 6px 8px;
      line-height: 1.25;
      font-size: 0.74rem;
      white-space: pre-wrap; /* helps exported rendering */
    }

    .risk-input,
    .risk-output {
      height: 32px !important;
      padding: 5px 6px !important;
      line-height: 1.2 !important;
      font-size: 0.74rem !important;
      text-align: center;
    }

    /* Version stamp (prints + exports well) */
    .version-stamp{
      position: fixed;
      right: 14px;
      bottom: 10px;
      z-index: 50;
      font-family: "Inter", sans-serif;
      font-size: 0.68rem;
      letter-spacing: 0.06em;
      color: rgba(16,24,39,0.75);
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(214,226,240,0.9);
      padding: 4px 10px;
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(5,41,66,0.08);
      backdrop-filter: blur(4px);
    }

    @media (max-width: 700px) {
      .header-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .page-title-main {
        font-size: 1.05rem;
        letter-spacing: 0.12em;
      }
    }
  </style>
</head>

<body>
<div class="page-wrap">
  <form id="hazardForm">
    <!-- PAGE 1 -->
    <div class="container" id="page1">
      <div class="header-bar">
        <div class="header-left">
          <h1>VISTAGEOMATICS</h1>
          <p>Worksite Hazard Assessment &amp; Tailgate Report</p>
        </div>
        <img src="vista-geomatics.png" alt="VistaGeomatics Logo" class="header-logo">
      </div>

      <div class="page-title-bar">
        <div class="page-title-main">Worksite Hazard Assessment</div>
        <div class="page-title-sub">Identify hazards and controls prior to commencing work.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <!-- General information -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">General Information</div>
          </div>
          <div class="row">
            <div>
              <label for="developed_by">Developed By</label>
              <input type="text" id="developed_by" name="developed_by">
            </div>
            <div>
              <label for="location">Location</label>
              <input type="text" id="location" name="location">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="date">Date</label>
              <input type="date" id="date" name="date">
            </div>
            <div>
              <label for="start_time">Start Time</label>
              <input type="time" id="start_time" name="start_time">
            </div>
            <div>
              <label for="completion_time">Form Completion Time</label>
              <input type="time" id="completion_time" name="completion_time">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="job_number">Job Number</label>
              <input type="text" id="job_number" name="job_number">
            </div>
            <div>
              <label for="description">Description of Work</label>
              <input type="text" id="description" name="description">
            </div>
          </div>
        </div>

        <!-- Tailgate meeting -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Tailgate Meeting Report</div>
            <div class="section-note">
              Complete daily prior to starting work and when procedures change or new hazards are present.
            </div>
          </div>
          <div style="margin-bottom:4px;">
            <label for="tailgate_minutes">Tailgate Minutes</label>
            <textarea id="tailgate_minutes" name="tailgate_minutes"></textarea>
          </div>

          <div class="row">
            <div style="flex:1;">
              <label>Site Sidewalk and Fencing Condition Report</label>
              <div class="inline-checkbox-group">
                <span>Did you drive on the sidewalk?</span>
                <label><input type="checkbox" name="sidewalk_yes"> Yes</label>
                <label><input type="checkbox" name="sidewalk_no"> No</label>
                <span>Fences Installed?</span>
                <label><input type="checkbox" name="fences_yes"> Yes</label>
                <label><input type="checkbox" name="fences_no"> No</label>
              </div>
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="sidewalk_comments">Comments</label>
            <textarea id="sidewalk_comments" name="sidewalk_comments"></textarea>
          </div>

          <div style="margin-top:4px;">
            <label>Pictures Taken:</label>
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="pic_site"> Site</label>
              <label><input type="checkbox" name="pic_sidewalk"> Sidewalk</label>
              <label><input type="checkbox" name="pic_fences"> Fences</label>
              <label><input type="checkbox" name="pic_hazards"> Hazards</label>
              <label>
                <input type="checkbox" name="pic_other"> Other (Describe):
                <input type="text" name="pic_other_desc" style="width:160px;">
              </label>
            </div>
          </div>
        </div>

        <!-- Working Alone -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Working Alone &amp; Check-in</div>
          </div>

          <div class="row">
            <div style="flex:1 1 35%;">
              <label>Working Alone</label>
              <div class="inline-checkbox-group">
                <label><input type="checkbox" name="working_alone_yes"> Yes</label>
                <label><input type="checkbox" name="working_alone_no"> No</label>
              </div>
            </div>
            <div style="flex:1 1 30%;">
              <label for="check_in_interval">Check-in Interval</label>
              <input type="text" id="check_in_interval" name="check_in_interval" placeholder="e.g., Hourly, Every 2 hours">
            </div>
            <div style="flex:1 1 30%;">
              <label for="communication_method">Communication Method</label>
              <input type="text" id="communication_method" name="communication_method" placeholder="e.g., Phone, Radio">
            </div>
          </div>

          <div class="row">
            <div style="flex:1 1 40%;">
              <label for="working_supervisor_name">Contact Procedures – Call Supervisor: Name</label>
              <input type="text" id="working_supervisor_name" name="working_supervisor_name">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_in_time">Check-in Time</label>
              <input type="time" id="check_in_time" name="check_in_time">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_out_time">Check-out Time</label>
              <input type="time" id="check_out_time" name="check_out_time">
            </div>
          </div>

          <div class="small-text" style="margin-top:4px;">
            <strong>Note:</strong> Check-in intervals are based on risk level,
            High risk: hourly, Medium risk: every 2 hours, Low risk: start and end of shift.
          </div>
        </div>

        <!-- Daily Equipment Inspection -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Daily Equipment Inspection</div>
            <div class="section-note">Check your vehicle, ATV, snowmobile, generator, trailer, and/or chainsaw and report any deficiencies.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Equipment</th>
              <th>Inspection Items</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>Vehicle</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="veh_tires"> Tires</label>
                  <label><input type="checkbox" name="veh_oil"> Oil</label>
                  <label><input type="checkbox" name="veh_fuel"> Fuel</label>
                  <label><input type="checkbox" name="veh_washer"> Washer fluid</label>
                  <label><input type="checkbox" name="veh_lights"> Lights</label>
                  <label><input type="checkbox" name="veh_tiedowns"> Tie-Down Straps</label>
                  <label>Other: <input type="text" name="veh_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>ATV / Snowmobile</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="atv_tires"> Tires/Track</label>
                  <label><input type="checkbox" name="atv_oil_fuel"> Oil/Fuel</label>
                  <label><input type="checkbox" name="atv_lights"> Lights</label>
                  <label><input type="checkbox" name="atv_brakes"> Brakes</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Generator</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="gen_oil"> Oil</label>
                  <label><input type="checkbox" name="gen_fuel"> Fuel</label>
                  <label><input type="checkbox" name="gen_cord"> Extension Cord</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Chainsaw (if used)</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="saw_oil"> Oil</label>
                  <label><input type="checkbox" name="saw_fuel"> Fuel</label>
                  <label><input type="checkbox" name="saw_chain"> Chain</label>
                  <label><input type="checkbox" name="saw_guard"> Guard</label>
                  <label>Other: <input type="text" name="saw_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Trailer</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="trl_tires"> Tires</label>
                  <label><input type="checkbox" name="trl_lights"> Lights</label>
                  <label><input type="checkbox" name="trl_chains"> Safety Chains</label>
                  <label><input type="checkbox" name="trl_deck"> Deck</label>
                  <label><input type="checkbox" name="trl_plate"> Licence Plate</label>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- PPE -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Personal Protective Equipment</div>
            <div class="section-note">Check off required PPE; report missing or worn items as needed.</div>
          </div>

          <div class="inline-checkbox-group">
            <label><input type="checkbox" name="ppe_hardhat"> Hardhat</label>
            <label><input type="checkbox" name="ppe_atv_helmet"> ATV Helmets</label>
            <label><input type="checkbox" name="ppe_signs"> Signs</label>
            <label><input type="checkbox" name="ppe_eye"> Eye Protection</label>
            <label><input type="checkbox" name="ppe_gloves"> Gloves</label>
            <label><input type="checkbox" name="ppe_csa_footwear"> CSA Approved Footwear</label>
            <label><input type="checkbox" name="ppe_winter"> Winter Clothing</label>
            <label><input type="checkbox" name="ppe_reflective"> Reflective Clothing</label>
            <label><input type="checkbox" name="ppe_frc"> Fire Retardant Coveralls</label>
            <label><input type="checkbox" name="ppe_hearing"> Hearing Protection</label>
            <label><input type="checkbox" name="ppe_chaps"> Chainsaw Pants/Chaps</label>
            <label><input type="checkbox" name="ppe_first_aid"> Personal First Aid Kit</label>
            <label><input type="checkbox" name="ppe_gas_monitor"> H2S, Methane, Oxygen, CO Monitor</label>
            <label>Other: <input type="text" name="ppe_other" style="width:160px;"></label>
          </div>
        </div>
      </div>
    </div>

    <!-- PAGE 2 -->
    <div class="container" id="page2">
      <div class="page-title-bar">
        <div class="page-title-main">Job Tasks, Hazards &amp; Controls</div>
        <div class="page-title-sub">Use F, S and P ratings to calculate risk for each task. Controls and ratings auto-suggest from an embedded ruleset.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <!-- Common Occurring Hazards -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Common Occurring Hazards</div>
            <div class="section-note">Check all hazards that apply. Unchecked rows will be removed from the PDF.</div>
          </div>

          <table id="commonHazardsTable">
            <thead>
            <tr>
              <th class="center">Applies</th>
              <th>Hazard</th>
              <th>Controls (from Worksite Hazard Assessment)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td class="center"><input type="checkbox" name="haz_buried_overhead"></td>
              <td>Buried or Overhead Facilities</td>
              <td>Use caution near facilities. Maintain safe approach limits. Report damage immediately. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_hunting"></td>
              <td>Hunting Season</td>
              <td>Know season and areas, stay together, make noise. If hunters seen, advise presence. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_housekeeping"></td>
              <td>Site Housekeeping</td>
              <td>Keep areas clean and clear of obstructions. Remove trip hazards promptly. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_h2s"></td>
              <td>H2S Concerns</td>
              <td>Only work where trained. Use gas monitor, follow SWP, and use respiratory protection if required.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_open_excavation"></td>
              <td>Open Excavation</td>
              <td>Stay back from edges. Cross only at safe points. Never jump trenches. Wear hard hat and boots.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_fences"></td>
              <td>
                Construction Fences – Installed
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="fence_installed_yes"> Yes
                </label>
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="fence_installed_no"> No
                </label>
              </td>
              <td>Use crossings, avoid fence bases, and adjust panels slowly. Keep clear in wind and when moving panels.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wild_animals"></td>
              <td>Wild Animals</td>
              <td>Stay alert, do not approach wildlife. Carry bear spray where applicable. Secure food and garbage.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_river"></td>
              <td>River: High/Low Spring Flood</td>
              <td>Keep distance from banks. Use safe crossing points or alternate routes. Stop if conditions worsen.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_traffic"></td>
              <td>On and Off Traffic or Construction</td>
              <td>Stay visible and alert. Use spotter and eye contact. Keep setups away from travel paths. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_icy"></td>
              <td>Icy Conditions</td>
              <td>Slow down and use slip-resistant footwear. Keep hands free. Reduce driving speed and increase distance.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_noise"></td>
              <td>Excessive Noise Levels</td>
              <td>Limit exposure, use hearing protection, and set clear communication methods. Stay aware of surroundings.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wildfire"></td>
              <td>
                Wild Fire Hazard – Fire Ban in Effect
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="fireban_yes"> Yes
                </label>
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="fireban_no"> No
                </label>
              </td>
              <td>Follow fire-ban rules. Avoid ignition sources near dry grass. Keep extinguisher ready and inspected.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_farming"></td>
              <td>Farming Operations (cattle or other animals)</td>
              <td>Make presence known, keep distance from livestock, and avoid flagging in pastures. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_landowner"></td>
              <td>
                Land Owner / Home Owner – Made Contact
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="landowner_yes"> Yes
                </label>
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="landowner_no"> No
                </label>
              </td>
              <td>Stay calm, listen respectfully, explain work, and leave if escalating. Report to supervisor and client.</td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- Job Specific Hazards -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Job Specific Hazards</div>
            <div class="section-note">Controls and ratings auto-suggest on leaving the hazard cell.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Job Tasks</th>
              <th>Hazards</th>
              <th class="center">F</th>
              <th class="center">S</th>
              <th class="center">P</th>
              <th class="center">R</th>
              <th>Control Plan / Barriers / Procedures</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td><input type="text" name="task_1" /></td>
              <td><input type="text" name="hazard_1" placeholder="e.g. dog, traffic, construction fencing, digging, generator" /></td>
              <td class="center"><input type="text" name="f_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_1" class="risk-output" data-row="1" style="width:40px;" readonly></td>
              <td><textarea name="control_1" class="control-text" placeholder="Controls auto-suggest when you leave the hazard cell."></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_2" /></td>
              <td><input type="text" name="hazard_2" /></td>
              <td class="center"><input type="text" name="f_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_2" class="risk-output" data-row="2" style="width:40px;" readonly></td>
              <td><textarea name="control_2" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_3" /></td>
              <td><input type="text" name="hazard_3" /></td>
              <td class="center"><input type="text" name="f_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_3" class="risk-output" data-row="3" style="width:40px;" readonly></td>
              <td><textarea name="control_3" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_4" /></td>
              <td><input type="text" name="hazard_4" /></td>
              <td class="center"><input type="text" name="f_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_4" class="risk-output" data-row="4" style="width:40px;" readonly></td>
              <td><textarea name="control_4" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_5" /></td>
              <td><input type="text" name="hazard_5" /></td>
              <td class="center"><input type="text" name="f_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_5" class="risk-output" data-row="5" style="width:40px;" readonly></td>
              <td><textarea name="control_5" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_6" /></td>
              <td><input type="text" name="hazard_6" /></td>
              <td class="center"><input type="text" name="f_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_6" class="risk-output" data-row="6" style="width:40px;" readonly></td>
              <td><textarea name="control_6" class="control-text"></textarea></td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- Risk Assessment Guide -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Risk Assessment Guide</div>
            <div class="section-note">Use these ratings when completing the Job Specific Hazards table.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Factor</th>
              <th class="center">1</th>
              <th class="center">2</th>
              <th class="center">3</th>
              <th class="center">4</th>
              <th class="center">5</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td><strong>Frequency (F)</strong></td>
              <td>Never</td><td>Yearly</td><td>Monthly</td><td>Weekly</td><td>Daily</td>
            </tr>
            <tr>
              <td><strong>Severity (S)</strong></td>
              <td>No injury</td><td>Minor injury</td><td>Serious / Medical aid</td><td>Lost time</td><td>Fatality</td>
            </tr>
            <tr>
              <td><strong>Probability (P)</strong></td>
              <td>Very unlikely</td><td>Unlikely</td><td>Possible</td><td>Significant</td><td>Certainty</td>
            </tr>
            </tbody>
          </table>

          <table style="margin-top:6px;">
            <thead>
            <tr>
              <th>Risk (Multiply Factors)</th>
              <th>Risk Level</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>0 – 25</td><td>Low risk</td></tr>
            <tr><td>26 – 50</td><td>Moderate risk</td></tr>
            <tr><td>51 – 75</td><td>Moderate / High risk</td></tr>
            <tr><td>76 – 100</td><td>High risk</td></tr>
            <tr><td>101 – 125</td><td>Severe risk</td></tr>
            </tbody>
          </table>

          <div class="small-text" style="margin-top:4px;">
            <strong>Note:</strong> If any task has a <strong>High</strong> or <strong>Severe</strong> risk rating, stop work and contact your supervisor before proceeding.
          </div>
        </div>

        <!-- Emergency Response -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Emergency Response Plan</div>
            <div class="section-note">Type facility name or acronym (e.g., FMC, SHC, CUCC) and select from list.</div>
          </div>

          <div class="row">
            <div>
              <label for="nearest_hospital">Nearest first aid facility or hospital</label>
              <input type="text" id="nearest_hospital" name="nearest_hospital" list="facilityList" placeholder="Start typing facility name or abbreviation">
              <datalist id="facilityList"></datalist>
            </div>
            <div>
              <label for="hospital_phone">Phone #</label>
              <input type="text" id="hospital_phone" name="hospital_phone">
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="emergency_procedures">Emergency Response Procedures</label>
            <textarea id="emergency_procedures" name="emergency_procedures"></textarea>
          </div>

          <div style="margin-top:4px;">
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="first_aid_available"> First Aid Kit Available</label>
              <label><input type="checkbox" name="fire_ext_available"> Fire Extinguisher Available</label>
              <label><input type="checkbox" name="effective_comm"> Effective Method of Communication Available</label>
            </div>
          </div>
        </div>

        <!-- Signatures -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Acknowledgement &amp; Sign-off</div>
          </div>

          <div class="signature-grid">
            <div class="signature-box">
              <div class="signature-label">Party Chief – Signature</div>
              <canvas id="pcSignature" class="signature-canvas"></canvas>
              <div class="signature-actions">
                <button type="button" class="btn-secondary" id="clearPcSig">Clear</button>
              </div>
              <div class="signature-row">
                <div>
                  <div class="signature-label">Name</div>
                  <input type="text" class="small-input" name="pc_name">
                </div>
                <div>
                  <div class="signature-label">Date</div>
                  <input type="date" class="small-input" name="pc_date">
                </div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Rodman – Signature</div>
              <canvas id="saSignature" class="signature-canvas"></canvas>
              <div class="signature-actions">
                <button type="button" class="btn-secondary" id="clearSaSig">Clear</button>
              </div>
              <div class="signature-row">
                <div>
                  <div class="signature-label">Name</div>
                  <input type="text" class="small-input" name="sa_name">
                </div>
                <div>
                  <div class="signature-label">Date</div>
                  <input type="date" class="small-input" name="sa_date">
                </div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Client Representative / Safety Coordinator / Additional Rodman – Signature</div>
              <canvas id="clientSignature" class="signature-canvas"></canvas>
              <div class="signature-actions">
                <button type="button" class="btn-secondary" id="clearClientSig">Clear</button>
              </div>
              <div class="signature-row">
                <div>
                  <div class="signature-label">Name</div>
                  <input type="text" class="small-input" name="client_name">
                </div>
                <div>
                  <div class="signature-label">Date</div>
                  <input type="date" class="small-input" name="client_date">
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:6px;">
            <label for="crew_contact">Crew Contact No.</label>
            <input type="text" id="crew_contact" name="crew_contact">
          </div>

          <div class="btn-row" id="buttonRow">
            <button type="reset" class="btn-secondary" id="resetBtn">Reset</button>
            <button type="button" class="btn-secondary" id="nameBtn">Name File</button>
            <button type="button" class="btn-primary" id="downloadBtn">Download PDF</button>
            <button type="button" class="btn-secondary" id="shareBtn">Share PDF</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="version-stamp" id="versionStamp">v3.1</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  const downloadBtn = document.getElementById('downloadBtn');
  const shareBtn    = document.getElementById('shareBtn');
  const nameBtn     = document.getElementById('nameBtn');
  const buttonRow   = document.getElementById('buttonRow');

  // ==========================
  // FILE NAME (user can override)
  // Default: JobNumber_DevelopedBy_YYYY-MM-DD
  // ==========================
  let userChosenFileName = "";

  function safeFilePart(s) {
    return (s || "")
      .toString()
      .trim()
      .replace(/[\\/:*?"<>|]+/g, "")
      .replace(/\s+/g, "_")
      .slice(0, 60);
  }

  function yyyyMmDd(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function getDefaultFileName() {
    const job = safeFilePart(document.getElementById("job_number")?.value);
    const dev = safeFilePart(document.getElementById("developed_by")?.value);
    const today = yyyyMmDd(new Date());
    const parts = [job || "Job", dev || "DevelopedBy", today];
    return parts.filter(Boolean).join("_") + ".pdf";
  }

  function getFinalFileName() {
    const base = (userChosenFileName || "").trim();
    if (base) {
      const cleaned = safeFilePart(base).replace(/\.pdf$/i, "");
      return (cleaned || "WorksiteHazardAssessment") + ".pdf";
    }
    return getDefaultFileName();
  }

  if (nameBtn) {
    nameBtn.addEventListener("click", () => {
      const suggested = getDefaultFileName().replace(/\.pdf$/i, "");
      const input = prompt("Name the PDF file (without .pdf):", userChosenFileName || suggested);
      if (input === null) return;
      userChosenFileName = input.trim();
    });
  }

  // ==========================
  // RISK CALC (R = F × S × P)
  // ==========================
  function updateRiskForRow(row) {
    const fInput = document.querySelector('input[name="f_' + row + '"]');
    const sInput = document.querySelector('input[name="s_' + row + '"]');
    const pInput = document.querySelector('input[name="p_' + row + '"]');
    const rInput = document.querySelector('input[name="r_' + row + '"]');
    if (!fInput || !sInput || !pInput || !rInput) return;

    const f = parseInt(fInput.value, 10);
    const s = parseInt(sInput.value, 10);
    const p = parseInt(pInput.value, 10);

    if (Number.isInteger(f) && Number.isInteger(s) && Number.isInteger(p)) {
      rInput.value = f * s * p;
    } else {
      rInput.value = "";
    }
  }

  document.querySelectorAll('.risk-input').forEach(input => {
    input.addEventListener('input', () => {
      const row = input.getAttribute('data-row');
      if (row) updateRiskForRow(row);
    });
  });

  // ==========================
  // SIGNATURE PADS
  // ==========================
  function initSignaturePad(canvasId, clearButtonId) {
    const canvas = document.getElementById(canvasId);
    const clearBtn = document.getElementById(clearButtonId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let drawing = false;
    let lastX = 0, lastY = 0;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111827';
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      const isTouch = evt.touches && evt.touches[0];
      const clientX = isTouch ? evt.touches[0].clientX : evt.clientX;
      const clientY = isTouch ? evt.touches[0].clientY : evt.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(evt) {
      drawing = true;
      const p = getPos(evt);
      lastX = p.x;
      lastY = p.y;
    }

    function drawLine(evt) {
      if (!drawing) return;
      const p = getPos(evt);
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      lastX = p.x;
      lastY = p.y;
    }

    function endDraw() { drawing = false; }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', drawLine);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e); }, { passive: false });
    canvas.addEventListener('touchmove', e => { e.preventDefault(); drawLine(e); }, { passive: false });
    canvas.addEventListener('touchend',  e => { e.preventDefault(); endDraw(); }, { passive: false });

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
    }
  }

  initSignaturePad('pcSignature', 'clearPcSig');
  initSignaturePad('saSignature', 'clearSaSig');
  initSignaturePad('clientSignature', 'clearClientSig');

  const resetBtn = document.getElementById('resetBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      ['pcSignature','saSignature','clientSignature'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      });
      document.querySelectorAll('.risk-output').forEach(o => o.value = "");
      userChosenFileName = "";
    });
  }

  // ==========================
  // SELF-CONTAINED EMERGENCY FACILITIES (FULL LIST)
  // ==========================
  const MEDICAL_FACILITIES = [
    { name:"Foothills Medical Centre", abbr:"FMC", type:"Hospital", address:"1403 29 St NW, Calgary, AB, T2N 2T9" },
    { name:"Alberta Children's Hospital", abbr:"ACH", type:"Hospital", address:"28 Oki Dr NW, Calgary, AB, T3B 6A8" },
    { name:"Peter Lougheed Centre", abbr:"PLC", type:"Hospital", address:"3500 26 Ave NE, Calgary, AB, T1Y 6J4" },
    { name:"Rockyview General Hospital", abbr:"RGH", type:"Hospital", address:"7007 14 St SW, Calgary, AB, T2V 1P9" },
    { name:"South Health Campus", abbr:"SHC", type:"Hospital", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },

    { name:"Royal Alexandra Hospital", abbr:"RAH", type:"Hospital", address:"10240 Kingsway NW, Edmonton, AB, T5H 3V9" },
    { name:"University of Alberta Hospital", abbr:"UAH", type:"Hospital", address:"8440 112 St NW, Edmonton, AB, T6G 2B7" },
    { name:"Misericordia Community Hospital", abbr:"MCH", type:"Hospital", address:"16940 87 Ave NW, Edmonton, AB, T5R 4H5" },
    { name:"Grey Nuns Community Hospital", abbr:"GNH", type:"Hospital", address:"1100 Youville Dr W, Edmonton, AB, T6L 5X8" },

    { name:"Red Deer Regional Hospital Centre", abbr:"RDRHC", type:"Hospital", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Chinook Regional Hospital", abbr:"CRH", type:"Hospital", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Medicine Hat Regional Hospital", abbr:"MHRH", type:"Hospital", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Northern Lights Regional Health Centre", abbr:"NLRHC", type:"Hospital", address:"7 Hospital St, Fort McMurray, AB, T9H 1P2" },
    { name:"Grande Prairie Regional Hospital", abbr:"GPRH", type:"Hospital", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },

    { name:"Airdrie Community Health Centre", abbr:"ACHC", type:"Community Health Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"Drumheller Health Centre", abbr:"DHC", type:"Community Health Centre", address:"351 9 St NW, Drumheller, AB, T0J 0Y1" },
    { name:"Brooks Health Centre", abbr:"BHC", type:"Community Health Centre", address:"440 3 St E, Brooks, AB, T1R 0G8" },
    { name:"Strathmore District Health Services", abbr:"SDHS", type:"Community Health Centre", address:"200 Brent Blvd, Strathmore, AB, T1P 1J9" },

    { name:"Banff Mineral Springs Hospital", abbr:"BMSH", type:"Hospital", address:"305 Lynx St, Banff, AB, T1L 1C1" },
    { name:"Canmore General Hospital", abbr:"CGH", type:"Hospital", address:"1100 Hospital Pl, Canmore, AB, T1W 1N2" },

    { name:"Airdrie Urgent Care Centre", abbr:"AUCC", type:"Urgent Care Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"South Calgary Urgent Care Centre", abbr:"SCUC", type:"Urgent Care Centre", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },
    { name:"North Edmonton Urgent Care Centre", abbr:"NEDUCC", type:"Urgent Care Centre", address:"13403 97 St NW, Edmonton, AB, T5E 4L8" },
    { name:"West Edmonton Urgent Care Centre", abbr:"WEUCC", type:"Urgent Care Centre", address:"1815 102 St NW, Edmonton, AB, T6J 4S5" },
    { name:"Northeast Edmonton Urgent Care Centre", abbr:"NEEUCC", type:"Urgent Care Centre", address:"7911 137 Ave NW, Edmonton, AB, T5C 0K9" },
    { name:"Red Deer Urgent Care Centre", abbr:"RDUCC", type:"Urgent Care Centre", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Medicine Hat Urgent Care Centre", abbr:"MHUCC", type:"Urgent Care Centre", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Grande Prairie Urgent Care Centre", abbr:"GPUCC", type:"Urgent Care Centre", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },
    { name:"Lethbridge Urgent Care Centre", abbr:"LHUCC", type:"Urgent Care Centre", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Cochrane Urgent Care Centre", abbr:"CUCC", type:"Urgent Care Centre", address:"60 Grande Blvd, Cochrane, AB, T4C 0S4" }
  ];

  const facilityInput = document.getElementById("nearest_hospital");
  const facilityList  = document.getElementById("facilityList");
  const phoneInput    = document.getElementById("hospital_phone");
  const erTextarea    = document.getElementById("emergency_procedures");

  function fillFacilityDatalist() {
    if (!facilityList) return;
    facilityList.innerHTML = "";
    MEDICAL_FACILITIES.forEach(f => {
      const opt1 = document.createElement("option");
      opt1.value = f.name;
      opt1.label = `${f.abbr} – ${f.type}`;
      facilityList.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = f.abbr;
      opt2.label = f.name;
      facilityList.appendChild(opt2);
    });
  }
  fillFacilityDatalist();

  function normalizeFacilityKey(s) {
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ");
  }

  function findFacility(query) {
    const q = normalizeFacilityKey(query);
    if (!q) return null;

    // exact abbreviation match
    const byAbbr = MEDICAL_FACILITIES.find(f => normalizeFacilityKey(f.abbr) === q);
    if (byAbbr) return byAbbr;

    // exact name match
    const byName = MEDICAL_FACILITIES.find(f => normalizeFacilityKey(f.name) === q);
    if (byName) return byName;

    // strong prefix match (name)
    const prefix = MEDICAL_FACILITIES.find(f => normalizeFacilityKey(f.name).startsWith(q));
    if (prefix) return prefix;

    // contains match (name)
    const contains = MEDICAL_FACILITIES.find(f => normalizeFacilityKey(f.name).includes(q));
    if (contains) return contains;

    return null;
  }

  function setEmergencyAutofill(facility) {
    if (!facility) return;
    // Set facility full name if user typed acronym
    if (facilityInput && normalizeFacilityKey(facilityInput.value) === normalizeFacilityKey(facility.abbr)) {
      facilityInput.value = facility.name;
    }
    if (phoneInput) phoneInput.value = "911";
    if (erTextarea) {
      erTextarea.value =
        `Ensure your safety and move to a secure area. Call 911 for emergencies and, if needed, go to ${facility.name}, ${facility.address} for medical attention. Report the incident to your supervisor as soon as it’s safe and complete an incident report.`;
    }
  }

  function clearEmergencyAutofill() {
    if (phoneInput) phoneInput.value = "";
    if (erTextarea) erTextarea.value = "";
  }

  if (facilityInput) {
    facilityInput.addEventListener("input", () => {
      const val = facilityInput.value || "";
      if (!val.trim()) {
        clearEmergencyAutofill();
        return;
      }
      // Only auto-fill when there is a confident match (abbr exact, name exact, or strong prefix >= 3 chars)
      const match = findFacility(val);
      const q = normalizeFacilityKey(val);
      const strong = (q.length >= 3) || (q === normalizeFacilityKey(match?.abbr));
      if (match && strong) setEmergencyAutofill(match);
    });

    facilityInput.addEventListener("blur", () => {
      const val = facilityInput.value || "";
      if (!val.trim()) {
        clearEmergencyAutofill();
        return;
      }
      const match = findFacility(val);
      if (match) setEmergencyAutofill(match);
    });
  }

  // ==========================
  // OFFLINE HAZARD RULE ENGINE (improved matching, plural-handling, better construction rules)
  // Controls are kept short (target < 185 chars)
  // Includes "dog" keyword for dogs
  // Auto-fills F/S/P if empty
  // Clears control + F/S/P/R when hazard cleared
  // ==========================

  // Helper: make controls short and safe
  function clipControl(text, max = 185) {
    const t = (text || "").replace(/\s+/g, " ").trim();
    if (t.length <= max) return t;
    return t.slice(0, max - 1).trimEnd() + "…";
  }

  function normalize(text) {
    return (text || "")
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function stemToken(tok) {
    let t = tok;
    if (t.length <= 3) return t;
    // basic stemming for plural/gerund
    if (t.endsWith("ies") && t.length > 4) t = t.slice(0, -3) + "y";
    else if (t.endsWith("es") && t.length > 4) t = t.slice(0, -2);
    else if (t.endsWith("s") && t.length > 3) t = t.slice(0, -1);
    if (t.endsWith("ing") && t.length > 5) t = t.slice(0, -3);
    return t;
  }

  function tokens(text) {
    const n = normalize(text);
    if (!n) return [];
    return n.split(" ").map(stemToken).filter(Boolean);
  }

  // Rule format:
  // { name, phrases:[], keywords:[], control, f,s,p }
  const hazardRules = [
    {
      name: "Construction traffic / site traffic",
      phrases: ["construction traffic", "haul truck", "dump truck", "site traffic"],
      keywords: ["traffic","vehicle","car","truck","bus","road","highway","lane","shoulder","intersection","backing","reversing","haul","delivery","construction"],
      control: clipControl("Stay visible and out of travel paths. Use cones/signs as needed, make eye contact, and use a spotter for backing or tight areas. Wear hi-vis."),
      f: 4, s: 3, p: 3
    },
    {
      name: "Construction fencing",
      phrases: ["construction fencing", "temporary fencing", "temp fence", "crowd control fence"],
      keywords: ["fence","fencing","panel","gate","base","sandbag","perimeter"],
      control: clipControl("Use designated gates and watch for fence bases and trip hazards. Do not lean on panels. Keep clear when panels move and in high winds."),
      f: 3, s: 2, p: 3
    },
    {
      name: "Portable generator",
      phrases: ["portable generator", "gen set", "genset"],
      keywords: ["generator","genny","exhaust","carbon","monoxide","fuel","refuel","cord","extension"],
      control: clipControl("Run generators outdoors away from doors and intakes. Manage cords to prevent trips. Refuel only when off, cooled, and in a ventilated area."),
      f: 2, s: 3, p: 2
    },
    {
      name: "Dogs",
      phrases: ["aggressive dog", "loose dog", "guard dog"],
      keywords: ["dog","dogs","barking","bite","aggressive","loose"],
      control: clipControl("Do not approach unknown or aggressive dogs. Ask the owner to secure the dog and avoid the area until it is under control."),
      f: 3, s: 2, p: 3
    },
    {
      name: "Slips / trips / falls (terrain)",
      phrases: ["uneven ground","trip hazard","slip hazard","hidden hole"],
      keywords: ["uneven","slope","ditch","rut","mud","gravel","wet","snow","ice","slippery","curb","stairs","steps","hole"],
      control: clipControl("Walk the area first and avoid unstable footing. Keep walk paths clear, set tripods on firm ground, and slow down on ice or wet surfaces."),
      f: 4, s: 2, p: 3
    },
    {
      name: "Utilities (overhead / underground)",
      phrases: ["power line","overhead line","underground utility","gas line"],
      keywords: ["utility","utilities","power","line","wire","cable","gas","pipeline","water","sewer","fibre","telecom","transformer","pedestal","vault","manhole"],
      control: clipControl("Confirm locates before digging or staking. Maintain limits of approach to power lines and keep poles/rods clear. Stop if utilities are uncertain."),
      f: 3, s: 4, p: 2
    },
    {
      name: "Digging / excavation",
      phrases: ["digging pin","open excavation","trench"],
      keywords: ["digging","dig","excavation","trench","hole","auger","pin","posthole"],
      control: clipControl("Confirm locates before digging. Hand-dig near marks, keep people back from edges, and stop if ground conditions or locates are unclear."),
      f: 3, s: 3, p: 3
    },
    {
      name: "Working alone / no signal",
      phrases: ["working alone","no service","poor reception"],
      keywords: ["alone","solo","remote","no signal","no service","dead phone","dead radio","lost contact"],
      control: clipControl("Use a check-in plan with set times and backups. Confirm phones/radios are charged and working before starting lone-worker tasks."),
      f: 3, s: 3, p: 2
    },
    {
      name: "Wildlife",
      phrases: ["bear","moose","cougar"],
      keywords: ["wildlife","bear","moose","coyote","wolf","deer","elk","cougar","goose","geese"],
      control: clipControl("Stay alert for wildlife and avoid close approach. Back away calmly, keep food secured, and relocate or leave if wildlife is near or unpredictable."),
      f: 2, s: 4, p: 2
    },
    {
      name: "Cold / windchill",
      phrases: ["frostbite","hypothermia","wind chill"],
      keywords: ["cold","freezing","winter","windchill","frostbite","hypothermia","below","minus","blizzard"],
      control: clipControl("Dress in layers and warm up often. Cover skin in windchill and shorten tasks in extreme cold. Watch for cold-stress signs."),
      f: 3, s: 3, p: 2
    },
    {
      name: "Heat / sun",
      phrases: ["heat stress","heat stroke"],
      keywords: ["heat","hot","sun","uv","sunburn","temperature"],
      control: clipControl("Drink water often and take shade breaks. Plan heavy tasks for cooler times and use sunscreen and breathable clothing. Stop if heat illness signs appear."),
      f: 3, s: 3, p: 2
    },
    {
      name: "Rain / wet surfaces",
      phrases: ["slippery when wet"],
      keywords: ["rain","wet","drizzle","downpour","puddle","slick"],
      control: clipControl("Wear waterproof layers and slip-resistant footwear. Slow down on wet surfaces and avoid climbing on wet metal or steep areas."),
      f: 3, s: 2, p: 3
    },
    {
      name: "Noise",
      phrases: ["excessive noise"],
      keywords: ["noise","loud","jackhammer","breaker","demo hammer","hearing"],
      control: clipControl("Use hearing protection and limit exposure. Maintain clear communication and stay aware of surrounding equipment and traffic."),
      f: 2, s: 2, p: 3
    },
    {
      name: "General hazard control",
      phrases: ["unsafe","dangerous"],
      keywords: ["hazard","risk","unsafe","danger","concern","issue"],
      control: clipControl("Walk the site before starting and adjust the plan, PPE, or setup to control hazards. Stop and reassess if conditions change."),
      f: 3, s: 3, p: 2
    }
  ];

  // scoring: phrases weigh high and reduce wrong matches
  function scoreRule(rule, hazardTextNorm, hazardTokens) {
    let score = 0;

    // phrase match (strong)
    (rule.phrases || []).forEach(ph => {
      const p = normalize(ph);
      if (!p) return;
      if (hazardTextNorm.includes(p)) score += 20;
    });

    // keyword token matches
    const kwTokens = []
      .concat(rule.keywords || [])
      .map(k => tokens(k))
      .flat()
      .filter(Boolean);

    const hazardSet = new Set(hazardTokens);
    kwTokens.forEach(t => {
      if (hazardSet.has(t)) score += 2;
    });

    // extra boost: if rule name keyword appears
    const nameTokens = tokens(rule.name);
    nameTokens.forEach(t => {
      if (hazardSet.has(t)) score += 2;
    });

    return score;
  }

  function bestRuleForHazard(hazardText) {
    const norm = normalize(hazardText);
    if (!norm) return null;
    const htoks = tokens(hazardText);

    let best = null;
    let bestScore = 0;

    hazardRules.forEach(rule => {
      const s = scoreRule(rule, norm, htoks);
      if (s > bestScore) {
        bestScore = s;
        best = rule;
      }
    });

    // require minimum confidence to avoid wrong matches like "construction" -> generator
    // If the user typed "construction", this will prefer traffic/fencing because of rule keywords/phrases.
    if (!best || bestScore < 6) return null;
    return best;
  }

  function clearRow(row) {
    const f = document.querySelector(`input[name="f_${row}"]`);
    const s = document.querySelector(`input[name="s_${row}"]`);
    const p = document.querySelector(`input[name="p_${row}"]`);
    const r = document.querySelector(`input[name="r_${row}"]`);
    const c = document.querySelector(`textarea[name="control_${row}"]`);
    if (f) f.value = "";
    if (s) s.value = "";
    if (p) p.value = "";
    if (r) r.value = "";
    if (c) c.value = "";
  }

  function applyRuleToRow(rule, row) {
    const controlField = document.querySelector(`textarea[name="control_${row}"]`);
    const fField = document.querySelector(`input[name="f_${row}"]`);
    const sField = document.querySelector(`input[name="s_${row}"]`);
    const pField = document.querySelector(`input[name="p_${row}"]`);

    if (controlField) {
      // only overwrite if blank or very short
      if (!controlField.value || controlField.value.trim().length < 15) {
        controlField.value = rule.control || "";
      }
    }

    // auto-fill F/S/P only if empty
    if (fField && !fField.value && rule.f) fField.value = String(rule.f);
    if (sField && !sField.value && rule.s) sField.value = String(rule.s);
    if (pField && !pField.value && rule.p) pField.value = String(rule.p);

    updateRiskForRow(row);
  }

  function initHazardAutoSuggest() {
    document.querySelectorAll('input[name^="hazard_"]').forEach(input => {
      input.addEventListener('blur', e => {
        const hazardText = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];

        if (!hazardText) {
          clearRow(row);
          return;
        }

        const rule = bestRuleForHazard(hazardText);
        if (!rule) {
          // If there is no confident match, do not overwrite user entries; still compute risk if they typed F/S/P
          updateRiskForRow(row);
          return;
        }
        applyRuleToRow(rule, row);
      });

      input.addEventListener('input', e => {
        const value = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];
        if (!value) {
          clearRow(row);
        }
      });
    });
  }
  initHazardAutoSuggest();

  // ==========================
  // PDF GENERATION (LEGAL SIZE)
  // Fix: ensure inputs + textareas are copied into clone so exports show:
  // - job tasks, hazards, F/S/P/R, control plans
  // - also copy signature canvases
  // Also removes unchecked common hazards rows to reduce PDF size
  // ==========================

  function copyFormValuesToClone(original, clone) {
    // inputs & textareas
    const origFields = original.querySelectorAll("input, textarea, select");
    origFields.forEach(orig => {
      const name = orig.getAttribute("name");
      const id = orig.getAttribute("id");

      let sel = null;
      if (id) sel = clone.querySelector(`#${CSS.escape(id)}`);
      if (!sel && name) sel = clone.querySelector(`[name="${CSS.escape(name)}"]`);
      if (!sel) return;

      if (orig.tagName.toLowerCase() === "textarea") {
        sel.value = orig.value;
        sel.textContent = orig.value; // important for html2canvas
      } else if (orig.type === "checkbox") {
        sel.checked = orig.checked;
        if (orig.checked) sel.setAttribute("checked", "checked");
        else sel.removeAttribute("checked");
      } else if (orig.type === "radio") {
        sel.checked = orig.checked;
        if (orig.checked) sel.setAttribute("checked", "checked");
        else sel.removeAttribute("checked");
      } else {
        sel.value = orig.value;
        sel.setAttribute("value", orig.value); // helps clone rendering
      }
    });

    // signature canvases
    ["pcSignature","saSignature","clientSignature"].forEach(cid => {
      const origCanvas = document.getElementById(cid);
      const cloneCanvas = clone.querySelector(`#${CSS.escape(cid)}`);
      if (origCanvas && cloneCanvas) {
        // size clone canvas to match display size
        const rect = cloneCanvas.getBoundingClientRect();
        const ratio = 1;
        cloneCanvas.width = Math.floor((rect.width || 300) * ratio);
        cloneCanvas.height = Math.floor((rect.height || 80) * ratio);
        const cctx = cloneCanvas.getContext("2d");
        const dataUrl = origCanvas.toDataURL("image/png");
        const img = new Image();
        img.onload = () => {
          cctx.clearRect(0,0,cloneCanvas.width, cloneCanvas.height);
          cctx.drawImage(img, 0, 0, cloneCanvas.width, cloneCanvas.height);
        };
        img.src = dataUrl;
      }
    });
  }

  function expandTextareasForExport(cloneRoot) {
    cloneRoot.querySelectorAll("textarea").forEach(t => {
      t.style.height = "auto";
      t.style.minHeight = "0";
      t.style.maxHeight = "none";
      t.style.overflow = "visible";
      // ensure value is present in textContent too
      t.textContent = t.value || t.textContent || "";
      t.style.height = (t.scrollHeight + 2) + "px";
    });
  }

  function createFilteredFormClone() {
    const form = document.getElementById('hazardForm');
    const clone = form.cloneNode(true);

    // Copy values (CRITICAL fix for exported job tasks/hazards/controls)
    copyFormValuesToClone(form, clone);

    // Remove unchecked common hazard rows
    const commonTableBody = clone.querySelector('#commonHazardsTable tbody');
    if (commonTableBody) {
      Array.from(commonTableBody.rows).forEach(row => {
        const appliesCheckbox = row.querySelector('td:first-child input[type="checkbox"]');
        if (appliesCheckbox && !appliesCheckbox.checked) {
          row.remove();
        }
      });
      // If none selected, remove table entirely to reduce blank space
      if (commonTableBody.rows.length === 0) {
        const tbl = clone.querySelector("#commonHazardsTable");
        if (tbl) tbl.remove();
      }
    }

    // Remove buttons in export
    const clonedButtonRow = clone.querySelector('#buttonRow');
    if (clonedButtonRow) clonedButtonRow.style.display = 'none';

    // Make sure datalist doesn't show as field content
    const dl = clone.querySelector("#facilityList");
    if (dl) dl.remove();

    // Add version stamp to clone
    const stamp = document.getElementById("versionStamp");
    if (stamp) clone.appendChild(stamp.cloneNode(true));

    // Expand textareas to show full text in export
    expandTextareasForExport(clone);

    return clone;
  }

  async function generatePdf() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'legal');

    const clone = createFilteredFormClone();

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.style.width = '1050px';
    tempContainer.style.background = '#ffffff';
    tempContainer.appendChild(clone);
    document.body.appendChild(tempContainer);

    // Let async canvas copies (signature images) paint
    await new Promise(r => setTimeout(r, 150));

    const clonePage1 = clone.querySelector('#page1');
    const clonePage2 = clone.querySelector('#page2');

    async function addPage(div, addNew) {
      if (!div) return;
      if (addNew) pdf.addPage();

      // Ensure textarea expansion just before capture
      expandTextareasForExport(clone);

      const canvas = await html2canvas(div, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
        windowWidth: 1050
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 8;

      let imgW = pageWidth - margin * 2;
      let imgH = canvas.height * (imgW / canvas.width);

      if (imgH > pageHeight - margin * 2) {
        imgH = pageHeight - margin * 2;
        imgW = canvas.width * (imgH / canvas.height);
      }

      const x = (pageWidth - imgW) / 2;
      const y = margin;

      pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH);
    }

    await addPage(clonePage1, false);
    await addPage(clonePage2, true);

    document.body.removeChild(tempContainer);
    return pdf;
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        pdf.save(getFinalFileName());
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        const blob = pdf.output('blob');
        const fileName = getFinalFileName();
        const file = new File([blob], fileName, { type: 'application/pdf' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'Worksite Hazard Assessment',
            text: 'VistaGeomatics – Worksite Hazard Assessment PDF'
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
      } catch (e) {
        console.error('Share failed:', e);
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }
</script>
</body>
</html>
