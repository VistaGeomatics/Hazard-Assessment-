<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VistaGeomatics – Worksite Hazard Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --vista-blue: #165f7d;
      --vista-blue-light: #2a7fa3;
      --vista-blue-dark: #0b3045;
      --bg-body: #eef3f9;
      --bg-card: #ffffff;
      --border-soft: #d6e2f0;
      --text-main: #101827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top, #f4f8fc 0, #e4edf6 40%, #dde6f3 100%);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    .page-wrap {
      max-width: 1050px;
      margin: 0 auto;
    }

    .container {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 14px 30px rgba(5, 41, 66, 0.18), 0 0 0 1px rgba(5, 41, 66, 0.04);
      overflow: hidden;
      position: relative;
      margin-bottom: 18px;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(22,95,125,0.16), transparent 55%);
      opacity: 0.9;
    }

    .header-bar {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: linear-gradient(120deg, var(--vista-blue-light) 0%, var(--vista-blue) 40%, var(--vista-blue-dark) 100%);
      color: #fff;
    }

    .header-left h1 {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .header-left p {
      margin: 2px 0 0;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .header-logo {
      height: 60px;
      filter: drop-shadow(0 5px 14px rgba(0,0,0,0.35));
    }

    .page-title-bar {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 10px 20px 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.78), #f7faff);
    }

    .page-title-main {
      font-family: "Montserrat", sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--vista-blue-dark);
    }

    .page-title-sub {
      margin-top: 3px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .page-title-accent {
      width: 120px;
      height: 3px;
      margin: 8px auto 0;
      border-radius: 999px;
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      box-shadow: 0 0 8px rgba(46,167,224,0.65);
    }

    .page-body {
      position: relative;
      z-index: 1;
      padding: 10px 18px 14px;
      font-size: 0.8rem;
    }

    label {
      font-size: 0.78rem;
      font-weight: 600;
      display: block;
      margin-bottom: 2px;
      color: var(--text-main);
    }

    /* ===== INPUT/TEXT CLIPPING FIX (Safari/iPad + general) ===== */
    input[type="text"],
    input[type="date"],
    input[type="time"],
    textarea,
    .small-input {
      width: 100%;
      font-family: "Inter", sans-serif;
      font-size: 0.74rem;
      line-height: 1.25;
      color: var(--text-main);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      transition: 0.15s;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    .small-input {
      height: 34px;
      padding: 6px 8px;
      vertical-align: middle;
    }

    textarea {
      padding: 6px 8px;
      min-height: 56px;
      resize: vertical;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--vista-blue-light);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(38,132,168,0.18);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .row > div {
      flex: 1;
      min-width: 150px;
    }

    .section-card {
      margin-top: 8px;
      padding: 8px 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, #fbfdff 0%, #f4f8fd 60%, #eff5fb 100%);
      box-shadow: 0 6px 16px rgba(5, 41, 66, 0.05);
      position: relative;
    }

    .section-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      border-radius: 12px 12px 0 0;
      background: linear-gradient(90deg, var(--vista-blue-light), var(--vista-blue-dark));
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 4px;
    }

    .section-title {
      font-weight: 600;
      font-size: 0.86rem;
      color: var(--vista-blue-dark);
      font-family: "Montserrat", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .section-note {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .inline-checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.76rem;
      align-items: center;
    }

    .inline-checkbox-group label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      margin-bottom: 0;
    }

    input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--vista-blue);
      margin: 0;
    }

    .small-text {
      font-size: 0.74rem;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    th, td {
      border: 1px solid var(--border-soft);
      padding: 3px 4px;
      vertical-align: top;
    }

    th {
      background: #e8f0fb;
      font-weight: 600;
      color: var(--vista-blue-dark);
    }

    td {
      background: #f9fbff;
    }

    .center { text-align: center; }

    .signature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .signature-box {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      padding: 6px;
      font-size: 0.78rem;
    }

    .signature-label {
      font-size: 0.74rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .signature-canvas {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      display: block;
      cursor: crosshair;
    }

    .signature-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .signature-actions button {
      padding: 3px 10px;
      font-size: 0.7rem;
      letter-spacing: 0.05em;
    }

    .signature-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .signature-row > div { flex: 1; }

    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      color: #fff;
      box-shadow: 0 8px 20px rgba(5, 41, 66, 0.35);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: var(--text-main);
      border: 1px solid #d6d7dd;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 9px 22px rgba(15, 23, 42, 0.18);
    }

    .control-text {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      padding: 6px 8px;
      line-height: 1.25;
      font-size: 0.74rem;
      white-space: pre-wrap; /* helps exported rendering */
    }

    .risk-input,
    .risk-output {
      height: 32px !important;
      padding: 5px 6px !important;
      line-height: 1.2 !important;
      font-size: 0.74rem !important;
      text-align: center;
    }

    /* Version stamp (prints + exports well) */
    .version-stamp{
      position: fixed;
      right: 14px;
      bottom: 10px;
      z-index: 50;
      font-family: "Inter", sans-serif;
      font-size: 0.68rem;
      letter-spacing: 0.06em;
      color: rgba(16,24,39,0.75);
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(214,226,240,0.9);
      padding: 4px 10px;
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(5,41,66,0.08);
      backdrop-filter: blur(4px);
    }

    @media (max-width: 700px) {
      .header-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .page-title-main {
        font-size: 1.05rem;
        letter-spacing: 0.12em;
      }
    }
  </style>
</head>

<body>
<div class="page-wrap">
  <form id="hazardForm">
    <!-- PAGE 1 -->
    <div class="container" id="page1">
      <div class="header-bar">
        <div class="header-left">
          <h1>VISTAGEOMATICS</h1>
          <p>Worksite Hazard Assessment &amp; Tailgate Report</p>
        </div>
        <img src="vista-geomatics.png" alt="VistaGeomatics Logo" class="header-logo">
      </div>

      <div class="page-title-bar">
        <div class="page-title-main">Worksite Hazard Assessment</div>
        <div class="page-title-sub">Identify hazards and controls prior to commencing work.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <!-- General information -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">General Information</div>
          </div>
          <div class="row">
            <div>
              <label for="developed_by">Developed By</label>
              <input type="text" id="developed_by" name="developed_by">
            </div>
            <div>
              <label for="location">Location</label>
              <input type="text" id="location" name="location">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="date">Date</label>
              <input type="date" id="date" name="date">
            </div>
            <div>
              <label for="start_time">Start Time</label>
              <input type="time" id="start_time" name="start_time">
            </div>
            <div>
              <label for="completion_time">Form Completion Time</label>
              <input type="time" id="completion_time" name="completion_time">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="job_number">Job Number</label>
              <input type="text" id="job_number" name="job_number">
            </div>
            <div>
              <label for="description">Description of Work</label>
              <input type="text" id="description" name="description">
            </div>
          </div>
        </div>

        <!-- Tailgate meeting -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Tailgate Meeting Report</div>
            <div class="section-note">
              Complete daily prior to starting work and when procedures change or new hazards are present.
            </div>
          </div>
          <div style="margin-bottom:4px;">
            <label for="tailgate_minutes">Tailgate Minutes</label>
            <textarea id="tailgate_minutes" name="tailgate_minutes"></textarea>
          </div>

          <div class="row">
            <div style="flex:1;">
              <label>Site Sidewalk and Fencing Condition Report</label>
              <div class="inline-checkbox-group">
                <span>Did you drive on the sidewalk?</span>
                <label><input type="checkbox" name="sidewalk_yes"> Yes</label>
                <label><input type="checkbox" name="sidewalk_no"> No</label>
                <span>Fences Installed?</span>
                <label><input type="checkbox" name="fences_yes"> Yes</label>
                <label><input type="checkbox" name="fences_no"> No</label>
              </div>
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="sidewalk_comments">Comments</label>
            <textarea id="sidewalk_comments" name="sidewalk_comments"></textarea>
          </div>

          <div style="margin-top:4px;">
            <label>Pictures Taken:</label>
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="pic_site"> Site</label>
              <label><input type="checkbox" name="pic_sidewalk"> Sidewalk</label>
              <label><input type="checkbox" name="pic_fences"> Fences</label>
              <label><input type="checkbox" name="pic_hazards"> Hazards</label>
              <label>
                <input type="checkbox" name="pic_other"> Other (Describe):
                <input type="text" name="pic_other_desc" style="width:160px;">
              </label>
            </div>
          </div>
        </div>

        <!-- Working Alone -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Working Alone &amp; Check-in</div>
          </div>

          <div class="row">
            <div style="flex:1 1 35%;">
              <label>Working Alone</label>
              <div class="inline-checkbox-group">
                <label><input type="checkbox" name="working_alone_yes"> Yes</label>
                <label><input type="checkbox" name="working_alone_no"> No</label>
              </div>
            </div>
            <div style="flex:1 1 30%;">
              <label for="check_in_interval">Check-in Interval</label>
              <input type="text" id="check_in_interval" name="check_in_interval" placeholder="e.g., Hourly, Every 2 hours">
            </div>
            <div style="flex:1 1 30%;">
              <label for="communication_method">Communication Method</label>
              <input type="text" id="communication_method" name="communication_method" placeholder="e.g., Phone, Radio">
            </div>
          </div>

          <div class="row">
            <div style="flex:1 1 40%;">
              <label for="working_supervisor_name">Contact Procedures – Call Supervisor: Name</label>
              <input type="text" id="working_supervisor_name" name="working_supervisor_name">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_in_time">Check-in Time</label>
              <input type="time" id="check_in_time" name="check_in_time">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_out_time">Check-out Time</label>
              <input type="time" id="check_out_time" name="check_out_time">
            </div>
          </div>

          <div class="small-text" style="margin-top:4px;">
            <strong>Note:</strong> Check-in intervals are based on risk level,
            High risk: hourly, Medium risk: every 2 hours, Low risk: start and end of shift.
          </div>
        </div>

        <!-- Daily Equipment Inspection -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Daily Equipment Inspection</div>
            <div class="section-note">Check your vehicle, ATV, snowmobile, generator, trailer, and/or chainsaw and report any deficiencies.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Equipment</th>
              <th>Inspection Items</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>Vehicle</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="veh_tires"> Tires</label>
                  <label><input type="checkbox" name="veh_oil"> Oil</label>
                  <label><input type="checkbox" name="veh_fuel"> Fuel</label>
                  <label><input type="checkbox" name="veh_washer"> Washer fluid</label>
                  <label><input type="checkbox" name="veh_lights"> Lights</label>
                  <label><input type="checkbox" name="veh_tiedowns"> Tie-Down Straps</label>
                  <label>Other: <input type="text" name="veh_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>ATV / Snowmobile</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="atv_tires"> Tires/Track</label>
                  <label><input type="checkbox" name="atv_oil_fuel"> Oil/Fuel</label>
                  <label><input type="checkbox" name="atv_lights"> Lights</label>
                  <label><input type="checkbox" name="atv_brakes"> Brakes</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Generator</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="gen_oil"> Oil</label>
                  <label><input type="checkbox" name="gen_fuel"> Fuel</label>
                  <label><input type="checkbox" name="gen_cord"> Extension Cord</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Chainsaw (if used)</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="saw_oil"> Oil</label>
                  <label><input type="checkbox" name="saw_fuel"> Fuel</label>
                  <label><input type="checkbox" name="saw_chain"> Chain</label>
                  <label><input type="checkbox" name="saw_guard"> Guard</label>
                  <label>Other: <input type="text" name="saw_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Trailer</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="trl_tires"> Tires</label>
                  <label><input type="checkbox" name="trl_lights"> Lights</label>
                  <label><input type="checkbox" name="trl_chains"> Safety Chains</label>
                  <label><input type="checkbox" name="trl_deck"> Deck</label>
                  <label><input type="checkbox" name="trl_plate"> Licence Plate</label>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- PPE -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Personal Protective Equipment</div>
            <div class="section-note">Check off required PPE; report missing or worn items as needed.</div>
          </div>

          <div class="inline-checkbox-group">
            <label><input type="checkbox" name="ppe_hardhat"> Hardhat</label>
            <label><input type="checkbox" name="ppe_atv_helmet"> ATV Helmets</label>
            <label><input type="checkbox" name="ppe_signs"> Signs</label>
            <label><input type="checkbox" name="ppe_eye"> Eye Protection</label>
            <label><input type="checkbox" name="ppe_gloves"> Gloves</label>
            <label><input type="checkbox" name="ppe_csa_footwear"> CSA Approved Footwear</label>
            <label><input type="checkbox" name="ppe_winter"> Winter Clothing</label>
            <label><input type="checkbox" name="ppe_reflective"> Reflective Clothing</label>
            <label><input type="checkbox" name="ppe_frc"> Fire Retardant Coveralls</label>
            <label><input type="checkbox" name="ppe_hearing"> Hearing Protection</label>
            <label><input type="checkbox" name="ppe_chaps"> Chainsaw Pants/Chaps</label>
            <label><input type="checkbox" name="ppe_first_aid"> Personal First Aid Kit</label>
            <label><input type="checkbox" name="ppe_gas_monitor"> H2S, Methane, Oxygen, CO Monitor</label>
            <label>Other: <input type="text" name="ppe_other" style="width:160px;"></label>
          </div>
        </div>
      </div>
    </div>

    <!-- PAGE 2 -->
    <div class="container" id="page2">
      <div class="page-title-bar">
        <div class="page-title-main">Job Tasks, Hazards &amp; Controls</div>
        <div class="page-title-sub">Use F, S and P ratings to calculate risk for each task. Controls and ratings auto-suggest from an embedded ruleset.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <!-- Common Occurring Hazards -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Common Occurring Hazards</div>
            <div class="section-note">Check all hazards that apply. Unchecked rows will be removed from the PDF.</div>
          </div>

          <table id="commonHazardsTable">
            <thead>
            <tr>
              <th class="center">Applies</th>
              <th>Hazard</th>
              <th>Controls (from Worksite Hazard Assessment)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td class="center"><input type="checkbox" name="haz_buried_overhead"></td>
              <td>Buried or Overhead Facilities</td>
              <td>Use caution near facilities. Maintain safe approach limits. Report damage immediately. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_hunting"></td>
              <td>Hunting Season</td>
              <td>Know season and areas, stay together, make noise. If hunters seen, advise presence. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_housekeeping"></td>
              <td>Site Housekeeping</td>
              <td>Keep areas clean and clear of obstructions. Remove trip hazards promptly. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_h2s"></td>
              <td>H2S Concerns</td>
              <td>Only work where trained. Use gas monitor, follow SWP, and use respiratory protection if required.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_open_excavation"></td>
              <td>Open Excavation</td>
              <td>Stay back from edges. Cross only at safe points. Never jump trenches. Wear hard hat and boots.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_fences"></td>
              <td>
                Construction Fences – Installed
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="fence_installed_yes"> Yes
                </label>
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="fence_installed_no"> No
                </label>
              </td>
              <td>Use crossings, avoid fence bases, and adjust panels slowly. Keep clear in wind and when moving panels.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wild_animals"></td>
              <td>Wild Animals</td>
              <td>Stay alert, do not approach wildlife. Carry bear spray where applicable. Secure food and garbage.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_river"></td>
              <td>River: High/Low Spring Flood</td>
              <td>Keep distance from banks. Use safe crossing points or alternate routes. Stop if conditions worsen.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_traffic"></td>
              <td>On and Off Traffic or Construction</td>
              <td>Stay visible and alert. Use spotter and eye contact. Keep setups away from travel paths. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_icy"></td>
              <td>Icy Conditions</td>
              <td>Slow down and use slip-resistant footwear. Keep hands free. Reduce driving speed and increase distance.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_noise"></td>
              <td>Excessive Noise Levels</td>
              <td>Limit exposure, use hearing protection, and set clear communication methods. Stay aware of surroundings.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wildfire"></td>
              <td>
                Wild Fire Hazard – Fire Ban in Effect
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="fireban_yes"> Yes
                </label>
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="fireban_no"> No
                </label>
              </td>
              <td>Follow fire-ban rules. Avoid ignition sources near dry grass. Keep extinguisher ready and inspected.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_farming"></td>
              <td>Farming Operations (cattle or other animals)</td>
              <td>Make presence known, keep distance from livestock, and avoid flagging in pastures. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_landowner"></td>
              <td>
                Land Owner / Home Owner – Made Contact
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="landowner_yes"> Yes
                </label>
                <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                  <input type="checkbox" name="landowner_no"> No
                </label>
              </td>
              <td>Stay calm, listen respectfully, explain work, and leave if escalating. Report to supervisor and client.</td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- Job Specific Hazards -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Job Specific Hazards</div>
            <div class="section-note">Controls and ratings auto-suggest on leaving the hazard cell.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Job Tasks</th>
              <th>Hazards</th>
              <th class="center">F</th>
              <th class="center">S</th>
              <th class="center">P</th>
              <th class="center">R</th>
              <th>Control Plan / Barriers / Procedures</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td><input type="text" name="task_1" /></td>
              <td><input type="text" name="hazard_1" placeholder="e.g. dog, traffic, construction fencing, digging, generator" /></td>
              <td class="center"><input type="text" name="f_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_1" class="risk-output" data-row="1" style="width:40px;" readonly></td>
              <td><textarea name="control_1" class="control-text" placeholder="Controls auto-suggest when you leave the hazard cell."></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_2" /></td>
              <td><input type="text" name="hazard_2" /></td>
              <td class="center"><input type="text" name="f_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_2" class="risk-output" data-row="2" style="width:40px;" readonly></td>
              <td><textarea name="control_2" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_3" /></td>
              <td><input type="text" name="hazard_3" /></td>
              <td class="center"><input type="text" name="f_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_3" class="risk-output" data-row="3" style="width:40px;" readonly></td>
              <td><textarea name="control_3" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_4" /></td>
              <td><input type="text" name="hazard_4" /></td>
              <td class="center"><input type="text" name="f_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_4" class="risk-output" data-row="4" style="width:40px;" readonly></td>
              <td><textarea name="control_4" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_5" /></td>
              <td><input type="text" name="hazard_5" /></td>
              <td class="center"><input type="text" name="f_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_5" class="risk-output" data-row="5" style="width:40px;" readonly></td>
              <td><textarea name="control_5" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_6" /></td>
              <td><input type="text" name="hazard_6" /></td>
              <td class="center"><input type="text" name="f_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_6" class="risk-output" data-row="6" style="width:40px;" readonly></td>
              <td><textarea name="control_6" class="control-text"></textarea></td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- Risk Assessment Guide -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Risk Assessment Guide</div>
            <div class="section-note">Use these ratings when completing the Job Specific Hazards table.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Factor</th>
              <th class="center">1</th>
              <th class="center">2</th>
              <th class="center">3</th>
              <th class="center">4</th>
              <th class="center">5</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td><strong>Frequency (F)</strong></td>
              <td>Never</td><td>Yearly</td><td>Monthly</td><td>Weekly</td><td>Daily</td>
            </tr>
            <tr>
              <td><strong>Severity (S)</strong></td>
              <td>No injury</td><td>Minor injury</td><td>Serious / Medical aid</td><td>Lost time</td><td>Fatality</td>
            </tr>
            <tr>
              <td><strong>Probability (P)</strong></td>
              <td>Very unlikely</td><td>Unlikely</td><td>Possible</td><td>Significant</td><td>Certainty</td>
            </tr>
            </tbody>
          </table>

          <table style="margin-top:6px;">
            <thead>
            <tr>
              <th>Risk (Multiply Factors)</th>
              <th>Risk Level</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>0 – 25</td><td>Low risk</td></tr>
            <tr><td>26 – 50</td><td>Moderate risk</td></tr>
            <tr><td>51 – 75</td><td>Moderate / High risk</td></tr>
            <tr><td>76 – 100</td><td>High risk</td></tr>
            <tr><td>101 – 125</td><td>Severe risk</td></tr>
            </tbody>
          </table>

          <div class="small-text" style="margin-top:4px;">
            <strong>Note:</strong> If any task has a <strong>High</strong> or <strong>Severe</strong> risk rating, stop work and contact your supervisor before proceeding.
          </div>
        </div>

        <!-- Emergency Response -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Emergency Response Plan</div>
            <div class="section-note">Type facility name or acronym (e.g., FMC, SHC, CUCC) and select from list.</div>
          </div>

          <div class="row">
            <div>
              <label for="nearest_hospital">Nearest first aid facility or hospital</label>
              <input type="text" id="nearest_hospital" name="nearest_hospital" list="facilityList" placeholder="Start typing facility name or abbreviation">
              <datalist id="facilityList"></datalist>
            </div>
            <div>
              <label for="hospital_phone">Phone #</label>
              <input type="text" id="hospital_phone" name="hospital_phone">
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="emergency_procedures">Emergency Response Procedures</label>
            <textarea id="emergency_procedures" name="emergency_procedures"></textarea>
          </div>

          <div style="margin-top:4px;">
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="first_aid_available"> First Aid Kit Available</label>
              <label><input type="checkbox" name="fire_ext_available"> Fire Extinguisher Available</label>
              <label><input type="checkbox" name="effective_comm"> Effective Method of Communication Available</label>
            </div>
          </div>
        </div>

        <!-- Signatures -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Acknowledgement &amp; Sign-off</div>
          </div>

          <div class="signature-grid">
            <div class="signature-box">
              <div class="signature-label">Party Chief – Signature</div>
              <canvas id="pcSignature" class="signature-canvas"></canvas>
              <div class="signature-actions">
                <button type="button" class="btn-secondary" id="clearPcSig">Clear</button>
              </div>
              <div class="signature-row">
                <div>
                  <div class="signature-label">Name</div>
                  <input type="text" class="small-input" name="pc_name">
                </div>
                <div>
                  <div class="signature-label">Date</div>
                  <input type="date" class="small-input" name="pc_date">
                </div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Rodman – Signature</div>
              <canvas id="saSignature" class="signature-canvas"></canvas>
              <div class="signature-actions">
                <button type="button" class="btn-secondary" id="clearSaSig">Clear</button>
              </div>
              <div class="signature-row">
                <div>
                  <div class="signature-label">Name</div>
                  <input type="text" class="small-input" name="sa_name">
                </div>
                <div>
                  <div class="signature-label">Date</div>
                  <input type="date" class="small-input" name="sa_date">
                </div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Client Representative / Safety Coordinator / Additional Rodman – Signature</div>
              <canvas id="clientSignature" class="signature-canvas"></canvas>
              <div class="signature-actions">
                <button type="button" class="btn-secondary" id="clearClientSig">Clear</button>
              </div>
              <div class="signature-row">
                <div>
                  <div class="signature-label">Name</div>
                  <input type="text" class="small-input" name="client_name">
                </div>
                <div>
                  <div class="signature-label">Date</div>
                  <input type="date" class="small-input" name="client_date">
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:6px;">
            <label for="crew_contact">Crew Contact No.</label>
            <input type="text" id="crew_contact" name="crew_contact">
          </div>

          <div class="btn-row" id="buttonRow">
            <button type="reset" class="btn-secondary" id="resetBtn">Reset</button>
            <button type="button" class="btn-secondary" id="nameBtn">Name File</button>
            <button type="button" class="btn-primary" id="downloadBtn">Download PDF</button>
            <button type="button" class="btn-secondary" id="shareBtn">Share PDF</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="version-stamp" id="versionStamp">v3.1</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  const downloadBtn = document.getElementById('downloadBtn');
  const shareBtn    = document.getElementById('shareBtn');
  const nameBtn     = document.getElementById('nameBtn');
  const buttonRow   = document.getElementById('buttonRow');

  // ==========================
  // FILE NAME (user can override)
  // Default: JobNumber_DevelopedBy_YYYY-MM-DD
  // ==========================
  let userChosenFileName = "";
	const HAZARD_LIBRARY = [
  {
    name: "Employees not fit for duty",
    keywords: "duties,duty,employee,employees,employees not fit for duty,fit,fitness,not",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "All personnel must comply with Vista Geomatics Ltd. drug and alcohol policy and Fatigue Management Program.",
      "Review hazards before starting, use required PPE and safe work practices, communicate with the crew, and stop work to reassess if conditions change."
    ]
  },
  {
    name: "Fatigue, time pressure & human factors",
    keywords: "factor,factors,fatigue,fatigues,human,humans,pressure,pressures,time,times",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "All personnel must comply with Vista Geomatics Ltd. drug and alcohol policy and Fatigue Management Program.",
      "Plan tasks with realistic timelines, avoid rushing or shortcuts, take short breaks to manage fatigue, and stop work to clarify instructions when unsure."
    ]
  },
  {
    name: "Inadequate training or competency",
    keywords: "competencies,competency,inadequate,inadequates,skill,skills,training,trainings",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Ensure workers are trained and competent to complete assigned work. Ask questions, use mentorship, and stop work if you are unsure how to complete a task safely.",
      "Confirm worker competency before tasks begin, provide supervision for new workers, review safe work practices, and stop work if conditions exceed training or ability."
    ]
  },
  {
    name: "Lone worker, check-in failure or poor communication",
    keywords: "check,check in,check-ins,checkin,checkins,communication,communications,failure,failures,lone,lone worker,poors,worker,workers",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Use a defined working alone check-in schedule and confirm communication devices are charged and functional. Escalate missed check-ins per procedure.",
      "Establish check-in times, confirm backup contacts, carry charged phone or radio, and stop lone work if communication coverage is unreliable."
    ]
  },
  {
    name: "Slips, trips, falls (uneven ground, ice, mud, debris)",
    keywords: "debris,fall,falls,ground,grounds,ice,ices,mud,muds,slip,slips,slips trips falls (uneven ground, ice, mud, debris),trip,trips,uneven",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Walk the area first and avoid unstable, icy, or uneven ground. Keep walk paths clear of holes, debris, cords, and loose material.",
      "Use slip-resistant footwear, slow down on ice or mud, maintain good housekeeping around setups, and relocate work if footing cannot be made safe."
    ]
  },
  {
    name: "Working near traffic (roads, highways, site traffic)",
    keywords: "highway,highways,lane,lanes,road,roads,shoulder,shoulders,site,sites,traffic,vehicle,vehicles,working,working near traffic (roads, highways, site traffic)",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Wear high-visibility PPE, set up away from live lanes, use cones or signage as required, and maintain eye contact with drivers and operators.",
      "Position crew and equipment clear of traffic paths, use a spotter for backing, follow traffic control plans, and stop work if conditions become unsafe."
    ]
  },
  {
    name: "Construction traffic (haul trucks, equipment movement)",
    keywords: "backing,construction traffic (haul trucks, equipment movement),equipment,haul,highway,lane,loader,road,roads,shoulder,traffic,truck,trucks,vehicle,vehicles",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Set crews and equipment well clear of travel routes and swing radii. Wear hi-vis, make eye contact with operators, and use a spotter for backing or reversing vehicles.",
      "Identify equipment travel routes during the tailgate, stay out of blind spots, communicate with operators, and stop work if traffic control is inadequate."
    ]
  },
  {
    name: "Working near heavy equipment (excavators, loaders, cranes)",
    keywords: "boom,booms,crane,cranes,excavator,excavators,heavy,heavies,loader,loaders,working,working near heavy equipment (excavators, loaders, cranes)",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Stay out of swing radii, lifting zones, and blind spots. Confirm with site supervisor where equipment will travel and relocate setups if activity comes too close.",
      "Maintain safe distance from operating equipment, use spotters where needed, wear hi-vis, and stop work if equipment movement creates uncontrolled risk."
    ]
  },
  {
    name: "Overhead hazards (falling objects, overhead work)",
    keywords: "falling,object,objects,overhead,overheads,work,works",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Do not work under suspended loads or active overhead work. Wear hard hats where required and maintain exclusion zones around overhead hazards.",
      "Identify overhead work areas, stay out of drop zones, communicate with site supervisor, and stop work if falling-object risks cannot be controlled."
    ]
  },
  {
    name: "Overhead power lines / electrical contact",
    keywords: "cable,cables,electrical,electricals,electricity,line,lines,overhead,overheads,power,power line,power lines,wire,wires",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Maintain limits of approach to overhead lines, keep poles and tripods away from conductors, and look up before raising equipment.",
      "Identify overhead utilities during tailgate, set up outside approach limits, use a spotter when moving long equipment, and stop work if clearance is uncertain."
    ]
  },
  {
    name: "Underground utilities (digging, probing, excavation)",
    keywords: "dig,digging,excavation,excavations,manhole,manholes,pipeline,pipelines,probe,probes,probing,telecom,telecoms,trench,trenches,underground,underground utilities (digging, probing, excavation),utility,utilities",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Confirm and review utility locates before digging or probing. Hand-dig near marked lines and stop work if utilities are uncertain or unmarked.",
      "Mark locates clearly, use non-conductive tools where applicable, maintain safe distances from marked lines, and contact the utility owner if conflicts are found."
    ]
  },
  {
    name: "Open excavations, trenches, holes",
    keywords: "ditch,ditches,excavation,excavations,hole,holes,open,opens,open excavations, trenches, holes,trenches",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Keep a safe distance from edges, cross only at approved points, never jump trenches, and keep people and equipment back from unstable edges.",
      "Identify open excavations during tailgate, use barriers where needed, watch footing near edges, and stop work if excavation stability is uncertain."
    ]
  },
  {
    name: "Confined spaces (manholes, vaults, pits)",
    keywords: "confined,confines,manhole,manholes,pit,pits,space,spaces,tank,tanks,vault,vaults",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Do not enter confined spaces without a formal confined space procedure, testing, monitoring, rescue plan, and required training.",
      "Treat manholes and vaults as confined spaces, do not enter without authorization and controls, and stop work if atmospheric hazards are possible."
    ]
  },
  {
    name: "Hazardous atmospheres (H2S, methane, low oxygen)",
    keywords: "atmosphere,atmospheres,h2s,hazardous,hazardouses,methane,oxygen",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Use calibrated gas monitors where required, follow site procedures, leave the area if alarms activate, and do not enter affected spaces without controls.",
      "Confirm training and monitoring requirements before work, wear required PPE, maintain ventilation where applicable, and stop work if gas hazards are suspected."
    ]
  },
  {
    name: "Extreme cold, frostbite, hypothermia",
    keywords: "cold,colds,extreme,extremes,frostbite,hypothermia,winter,winters",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Dress in layers, cover exposed skin, take warm-up breaks, and monitor for signs of cold stress. Shorten tasks in extreme windchill.",
      "Plan for cold exposure, rotate tasks, keep spare dry clothing available, and stop work if workers show signs of hypothermia or frostbite."
    ]
  },
  {
    name: "Heat stress, dehydration, sun exposure",
    keywords: "dehydration,heat,heats,stress,stresses,sun,suns,uv",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Drink water regularly, take shade breaks, wear sun protection, and adjust pace or schedule heavy work to cooler times of day.",
      "Watch for heat illness signs, use buddy checks, increase rest breaks in high heat, and stop work if workers feel unwell."
    ]
  },
  {
    name: "High winds, flying debris, unstable equipment",
    keywords: "debris,debrises,equipment,equipments,flying,high,high winds, flying debris, unstable equipment,unstable,wind,winds,windy",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Step in tripods fully, use lower, wider setups, weigh down legs, secure loose materials, and stop work if winds make conditions unsafe.",
      "Secure fencing and equipment, avoid working under overhead hazards in strong gusts, and relocate or pause work until wind conditions improve."
    ]
  },
  {
    name: "Reduced visibility (fog, smoke, dust, low light)",
    keywords: "dust,dusts,fog,fogs,light,lights,low,low light,reduced,reduced visibility (fog, smoke, dust, low light),smoke,smokes,visibility",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Use extra lighting or high-visibility PPE, increase spacing from traffic and equipment, and delay work if visibility is too poor to work safely.",
      "Adjust driving and walking speed, use clear communication, relocate to safer positions, and stop work if visibility prevents hazard recognition."
    ]
  },
  {
    name: "Rain, wet surfaces, slippery footing",
    keywords: "footing,footings,rain,rains,slippery,slipperies,surface,surfaces,wet,wets",
    risk: {
      F: 1,
      S: 3,
      P: 1,
      R: 3
    },
    controls: [
      "Wear waterproof layers and slip-resistant footwear, slow down on wet surfaces, and avoid climbing on wet metal or steep surfaces where footing is poor.",
      "Improve housekeeping in wet areas, mark slippery sections, use handrails where available, and stop work if surfaces cannot be made safe."
    ]
  },
  {
    name: "Driving hazards (winter driving, collisions, backing)",
    keywords: "backing,collision,collisions,driving,drivings,hazard,hazards,winter,winter driving, collisions, backing",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Reduce speed, increase following distance, avoid distractions, and use a spotter when backing. Perform a walk-around before moving the vehicle.",
      "Plan routes, drive to conditions, avoid backing when possible, and stop driving if road conditions or visibility become unsafe."
    ]
  },
  {
    name: "Vehicle walk-around not completed (struck-by risk)",
    keywords: "around,completed,completes,not,not completed,struck,struck-by,vehicle,vehicles,walk,walk-around,walkaround",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Complete a full walk-around before moving any vehicle, check blind spots, and ensure pedestrians, children, and obstacles are clear.",
      "Use a spotter in tight areas, back only when necessary, and stop the vehicle immediately if anyone enters the danger zone."
    ]
  },
  {
    name: "Manual handling, lifting strains, awkward loads",
    keywords: "awkward,awkwards,handling,handlings,lift,lifting,loads,manual,manual handling, lifting strains, awkward loads,strain,strains",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Use proper lifting technique, keep loads close, avoid twisting, and use team lifts for heavy or awkward items. Take breaks to prevent overexertion.",
      "Break loads into smaller carries, use carts where possible, and stop work if lifting requirements exceed safe capability."
    ]
  },
  {
    name: "Cuts, punctures, sharp objects (knives, glass, rebar)",
    keywords: "cut,cuts,glass,glasses,knife,knives,puncture,punctures,rebar,sharp,sharps",
    risk: {
      F: 1,
      S: 3,
      P: 1,
      R: 3
    },
    controls: [
      "Wear appropriate gloves, control and store sharp tools safely, and avoid reaching into unseen areas. Dispose of sharps safely and report hazards.",
      "Keep hands clear of cutting paths, use correct tools for the task, and stop work if sharp-object hazards cannot be controlled."
    ]
  },
  {
    name: "Needles, sharps, biohazards (urban alleys, encampments)",
    keywords: "alley,alleys,biohazard,biohazards,encampment,encampments,needle,needles,sharps,urban,urbans,waste,wastes",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Avoid contact with needles or bodily fluids. Do not pick up sharps, relocate away from hazards, use gloves if needed, and report to supervisor.",
      "Mark unsafe areas, maintain distance from encampments, secure equipment, and stop work if biohazard risks cannot be controlled."
    ]
  },
  {
    name: "Aggressive public, landowner conflict, harassment",
    keywords: "aggressive,aggressives,conflict,conflicts,harassment,harassments,landowner,landowners,public,publics",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Remain calm and respectful, do not argue, leave the area if threats occur, and report to supervisor. Call police only if immediate danger exists.",
      "Work in pairs where possible, keep exit routes clear, do not escalate confrontations, and stop work if the situation becomes unsafe."
    ]
  },
  {
    name: "Domestic dogs (aggressive or loose dogs)",
    keywords: "aggressive dog,aggressive dogs,barking dog,barking dogs,dog,dogs,domestic,domestic dogs (aggressive or loose dogs),guard dog,guard dogs,loose dog,loose dogs",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Do not approach unknown dogs. Ask the owner to secure the dog, maintain distance, and leave the area if the dog shows aggressive behaviour.",
      "Stop work if a dog is loose or threatening. Use barriers if available and notify the supervisor or homeowner before resuming work."
    ]
  },
  {
    name: "Wildlife (bears, moose, coyotes, etc.)",
    keywords: "bear,bears,coyote,coyotes,cougar,cougars,deer,elk,moose,wildlife,wildlives,wolf,wolves",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Stay alert for wildlife sign, keep food secured, and avoid approaching animals. Back away calmly and leave the area if wildlife is nearby or acting unpredictably.",
      "Carry deterrents where trained, work in pairs when possible, make noise in brushy areas, and stop work if wildlife poses a credible threat."
    ]
  },
  {
    name: "Insects and ticks (bites, stings, allergic reactions)",
    keywords: "allergic,allergies,bee,bees,bite,bites,hornet,hornets,insect,insects,mosquito,mosquitoes,sting,stings,tick,ticks,wasp,wasps",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Use insect repellent, wear long sleeves in brush, check for ticks after work, and avoid nests. Carry allergy medication if prescribed.",
      "Mark and avoid heavy insect areas, wear gloves as needed, and stop work if severe allergic reactions occur, seek medical attention immediately."
    ]
  },
  {
    name: "Water hazards (rivers, flood, drowning, thin ice)",
    keywords: "current,currents,drown,drowning,flood,flooding,ice,ices,river,rivers,thin,thin ice,water,waters",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Keep a safe distance from water edges and undercut banks, avoid unknown or thin ice, and use safe crossings or alternate routes where required.",
      "Stop work if water conditions are unsafe, do not attempt risky crossings, and ensure workers can call for help and reach safe ground quickly."
    ]
  },
  {
    name: "Working at heights (ladders, rooftops, fall risk)",
    keywords: "fall,falls,height,heights,ladder,ladders,roof,roofs,rooftop,rooftops,work,working at heights (ladders, rooftops, fall risk)",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Use ladders on firm level ground at correct angle, maintain three-point contact, and stay back from edges. Use fall protection where required.",
      "Inspect ladders before use, do not work near unprotected edges, and stop work if safe access or fall protection cannot be confirmed."
    ]
  },
  {
    name: "Pinch points, struck-by, caught-between (equipment, tools)",
    keywords: "between,caught,caught-between,equipment,equipments,point,points,pinch,pinches,struck,struck-by,tool,tools",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Keep hands clear of pinch points, maintain safe spacing around moving equipment, and use proper handling when setting tripods, rods, and clamps.",
      "Communicate movements, use spotters where needed, and stop work if the struck-by zone cannot be controlled or people enter unsafe areas."
    ]
  },
  {
    name: "Hand and power tools (injury, vibration, noise)",
    keywords: "noise,noises,power,powers,tool,tools,vibration,vibrations",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Use the correct tool, inspect before use, wear eye and hearing protection as required, and keep stable footing. Take breaks to reduce vibration exposure.",
      "Keep guards in place, maintain safe distances from cutting surfaces, and stop tool use if equipment is damaged or creates uncontrolled risk."
    ]
  },
  {
    name: "Jackhammering / concrete breaking",
    keywords: "break,breaker,breakers,breaking,concrete,concretes,hammer,hammers,jack,jackhammer,jackhammers",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Wear hearing and eye protection, keep stable footing, control flying chips, and take breaks for vibration. Confirm no utilities are below before breaking.",
      "Use both hands on the tool, keep bystanders clear, and stop work if dust, noise, or vibration hazards cannot be controlled."
    ]
  },
  {
    name: "Generators (carbon monoxide, fuel handling, cords)",
    keywords: "carbon,cord,cords,fuel,fuels,generator,generators,monoxide",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Operate generators outdoors on level ground away from doors and intakes, route cords to prevent trips, and refuel only when the unit is off and cooled.",
      "Keep fuel stored safely, do not run generators in enclosed spaces, and stop work if fumes, spills, or electrical hazards are present."
    ]
  },
  {
    name: "Electrical hazards (cords, damaged plugs, wet conditions)",
    keywords: "cord,cords,damaged,electrical,electricals,plug,plugs,wet,wets",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Inspect cords and plugs before use, keep connections dry, use GFCI protection where required, and remove damaged equipment from service.",
      "Route cords to avoid damage and trips, avoid using electrical tools in wet conditions unless rated, and stop work if electrical safety cannot be assured."
    ]
  },
  {
    name: "Chemical exposure (fuels, solvents, fumes, dust)",
    keywords: "chemical,chemicals,dust,dusts,exposure,exposures,fuel,fuels,fume,fumes,solvent,solvents",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Use chemicals in well-ventilated areas, stand upwind of fumes or dust, follow SDS requirements, and wear PPE specified for the product.",
      "Store and transport chemicals safely, clean spills promptly, and stop work if exposure controls or ventilation are not adequate."
    ]
  },
  {
    name: "Fire hazard (fire ban, ignition sources, flammables)",
    keywords: "ban,bans,fire,fire ban,fire hazard (fire ban, ignition sources, flammables),flammable,flammables,ignition,source,sources",
    risk: {
      F: 1,
      S: 5,
      P: 1,
      R: 5
    },
    controls: [
      "Follow fire-ban restrictions, keep ignition sources away from dry vegetation and fuels, store fuels properly, and ensure a suitable extinguisher is available.",
      "Do not park on tall grass, extinguish smoking materials fully, and stop work if fire conditions become extreme or controls cannot be maintained."
    ]
  },
  {
    name: "Noise exposure (equipment, traffic, tools)",
    keywords: "equipment,equipments,exposure,exposures,noise,noises,tool,tools,traffic",
    risk: {
      F: 1,
      S: 3,
      P: 1,
      R: 3
    },
    controls: [
      "Limit exposure where possible, establish clear communication methods, and wear hearing protection as required. Stay alert to surroundings.",
      "Increase distance from noisy sources, rotate tasks, and stop work if communication cannot be maintained safely in high-noise environments."
    ]
  },
  {
    name: "Dust exposure (silica, construction dust)",
    keywords: "construction,construction dust,dust,dusts,exposure,exposures,silica",
    risk: {
      F: 1,
      S: 4,
      P: 1,
      R: 4
    },
    controls: [
      "Stand upwind where possible, reduce dust generation, and wear respiratory protection when required by site rules or SDS. Avoid dry sweeping in dusty areas.",
      "Use water suppression or alternate methods if available, increase separation from dusty work, and stop work if dust levels cannot be controlled."
    ]
  },
  {
    name: "Working around construction fencing (panels, bases, gates)",
    keywords: "base,bases,construction fence,construction fences,fence,fences,fencing,gate,gates,panels,temporary fence,temp fence",
    risk: {
      F: 1,
      S: 3,
      P: 1,
      R: 3
    },
    controls: [
      "Use designated gates and avoid climbing or leaning on fencing. Watch for fence bases that create trip hazards and keep clear when panels are moved.",
      "Do not move fencing alone. Secure loose panels in wind and stop work if fencing is unstable or blocks safe access."
    ]
  },

  /* --- SNIP WARNING ---
     The full list contains 109 hazards and is very long.
     If you want the ENTIRE completed list pasted inline in chat, tell me:
     "paste the whole 109 hazard list"
     and I’ll output the full block without truncation.
  --- */
];


  function safeFilePart(s) {
    return (s || "")
      .toString()
      .trim()
      .replace(/[\\/:*?"<>|]+/g, "")
      .replace(/\s+/g, "_")
      .slice(0, 60);
  }

  function yyyyMmDd(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function getDefaultFileName() {
    const job = safeFilePart(document.getElementById("job_number")?.value);
    const dev = safeFilePart(document.getElementById("developed_by")?.value);
    const today = yyyyMmDd(new Date());
    const parts = [job || "Job", dev || "DevelopedBy", today];
    return parts.filter(Boolean).join("_") + ".pdf";
  }

  function getFinalFileName() {
    const base = (userChosenFileName || "").trim();
    if (base) {
      const cleaned = safeFilePart(base).replace(/\.pdf$/i, "");
      return (cleaned || "WorksiteHazardAssessment") + ".pdf";
    }
    return getDefaultFileName();
  }

  if (nameBtn) {
    nameBtn.addEventListener("click", () => {
      const suggested = getDefaultFileName().replace(/\.pdf$/i, "");
      const input = prompt("Name the PDF file (without .pdf):", userChosenFileName || suggested);
      if (input === null) return;
      userChosenFileName = input.trim();
    });
  }

  // ==========================
  // RISK CALC (R = F × S × P)
  // ==========================
  function updateRiskForRow(row) {
    const fInput = document.querySelector('input[name="f_' + row + '"]');
    const sInput = document.querySelector('input[name="s_' + row + '"]');
    const pInput = document.querySelector('input[name="p_' + row + '"]');
    const rInput = document.querySelector('input[name="r_' + row + '"]');
    if (!fInput || !sInput || !pInput || !rInput) return;

    const f = parseInt(fInput.value, 10);
    const s = parseInt(sInput.value, 10);
    const p = parseInt(pInput.value, 10);

    if (Number.isInteger(f) && Number.isInteger(s) && Number.isInteger(p)) {
      rInput.value = f * s * p;
    } else {
      rInput.value = "";
    }
  }

  document.querySelectorAll('.risk-input').forEach(input => {
    input.addEventListener('input', () => {
      const row = input.getAttribute('data-row');
      if (row) updateRiskForRow(row);
    });
  });

  // ==========================
  // SIGNATURE PADS
  // ==========================
  function initSignaturePad(canvasId, clearButtonId) {
    const canvas = document.getElementById(canvasId);
    const clearBtn = document.getElementById(clearButtonId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let drawing = false;
    let lastX = 0, lastY = 0;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111827';
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      const isTouch = evt.touches && evt.touches[0];
      const clientX = isTouch ? evt.touches[0].clientX : evt.clientX;
      const clientY = isTouch ? evt.touches[0].clientY : evt.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(evt) {
      drawing = true;
      const p = getPos(evt);
      lastX = p.x;
      lastY = p.y;
    }

    function drawLine(evt) {
      if (!drawing) return;
      const p = getPos(evt);
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      lastX = p.x;
      lastY = p.y;
    }

    function endDraw() { drawing = false; }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', drawLine);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e); }, { passive: false });
    canvas.addEventListener('touchmove', e => { e.preventDefault(); drawLine(e); }, { passive: false });
    canvas.addEventListener('touchend',  e => { e.preventDefault(); endDraw(); }, { passive: false });

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
    }
  }

  initSignaturePad('pcSignature', 'clearPcSig');
  initSignaturePad('saSignature', 'clearSaSig');
  initSignaturePad('clientSignature', 'clearClientSig');

  const resetBtn = document.getElementById('resetBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      ['pcSignature','saSignature','clientSignature'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      });
      document.querySelectorAll('.risk-output').forEach(o => o.value = "");
      userChosenFileName = "";
    });
  }

  // ==========================
  // SELF-CONTAINED EMERGENCY FACILITIES (FULL LIST)
  // ==========================
  const MEDICAL_FACILITIES = [
    { name:"Foothills Medical Centre", abbr:"FMC", type:"Hospital", address:"1403 29 St NW, Calgary, AB, T2N 2T9" },
    { name:"Alberta Children's Hospital", abbr:"ACH", type:"Hospital", address:"28 Oki Dr NW, Calgary, AB, T3B 6A8" },
    { name:"Peter Lougheed Centre", abbr:"PLC", type:"Hospital", address:"3500 26 Ave NE, Calgary, AB, T1Y 6J4" },
    { name:"Rockyview General Hospital", abbr:"RGH", type:"Hospital", address:"7007 14 St SW, Calgary, AB, T2V 1P9" },
    { name:"South Health Campus", abbr:"SHC", type:"Hospital", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },

    { name:"Royal Alexandra Hospital", abbr:"RAH", type:"Hospital", address:"10240 Kingsway NW, Edmonton, AB, T5H 3V9" },
    { name:"University of Alberta Hospital", abbr:"UAH", type:"Hospital", address:"8440 112 St NW, Edmonton, AB, T6G 2B7" },
    { name:"Misericordia Community Hospital", abbr:"MCH", type:"Hospital", address:"16940 87 Ave NW, Edmonton, AB, T5R 4H5" },
    { name:"Grey Nuns Community Hospital", abbr:"GNH", type:"Hospital", address:"1100 Youville Dr W, Edmonton, AB, T6L 5X8" },

    { name:"Red Deer Regional Hospital Centre", abbr:"RDRHC", type:"Hospital", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Chinook Regional Hospital", abbr:"CRH", type:"Hospital", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Medicine Hat Regional Hospital", abbr:"MHRH", type:"Hospital", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Northern Lights Regional Health Centre", abbr:"NLRHC", type:"Hospital", address:"7 Hospital St, Fort McMurray, AB, T9H 1P2" },
    { name:"Grande Prairie Regional Hospital", abbr:"GPRH", type:"Hospital", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },

    { name:"Airdrie Community Health Centre", abbr:"ACHC", type:"Community Health Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"Drumheller Health Centre", abbr:"DHC", type:"Community Health Centre", address:"351 9 St NW, Drumheller, AB, T0J 0Y1" },
    { name:"Brooks Health Centre", abbr:"BHC", type:"Community Health Centre", address:"440 3 St E, Brooks, AB, T1R 0G8" },
    { name:"Strathmore District Health Services", abbr:"SDHS", type:"Community Health Centre", address:"200 Brent Blvd, Strathmore, AB, T1P 1J9" },

    { name:"Banff Mineral Springs Hospital", abbr:"BMSH", type:"Hospital", address:"305 Lynx St, Banff, AB, T1L 1C1" },
    { name:"Canmore General Hospital", abbr:"CGH", type:"Hospital", address:"1100 Hospital Pl, Canmore, AB, T1W 1N2" },

    { name:"Airdrie Urgent Care Centre", abbr:"AUCC", type:"Urgent Care Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"South Calgary Urgent Care Centre", abbr:"SCUC", type:"Urgent Care Centre", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },
    { name:"North Edmonton Urgent Care Centre", abbr:"NEDUCC", type:"Urgent Care Centre", address:"13403 97 St NW, Edmonton, AB, T5E 4L8" },
    { name:"West Edmonton Urgent Care Centre", abbr:"WEUCC", type:"Urgent Care Centre", address:"1815 102 St NW, Edmonton, AB, T6J 4S5" },
    { name:"Northeast Edmonton Urgent Care Centre", abbr:"NEEUCC", type:"Urgent Care Centre", address:"7911 137 Ave NW, Edmonton, AB, T5C 0K9" },
    { name:"Red Deer Urgent Care Centre", abbr:"RDUCC", type:"Urgent Care Centre", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Medicine Hat Urgent Care Centre", abbr:"MHUCC", type:"Urgent Care Centre", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Grande Prairie Urgent Care Centre", abbr:"GPUCC", type:"Urgent Care Centre", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },
    { name:"Lethbridge Urgent Care Centre", abbr:"LHUCC", type:"Urgent Care Centre", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Cochrane Urgent Care Centre", abbr:"CUCC", type:"Urgent Care Centre", address:"60 Grande Blvd, Cochrane, AB, T4C 0S4" }
  ];

  const facilityInput = document.getElementById("nearest_hospital");
  const facilityList  = document.getElementById("facilityList");
  const phoneInput    = document.getElementById("hospital_phone");
  const erTextarea    = document.getElementById("emergency_procedures");

  function fillFacilityDatalist() {
    if (!facilityList) return;
    facilityList.innerHTML = "";
    MEDICAL_FACILITIES.forEach(f => {
      const opt1 = document.createElement("option");
      opt1.value = f.name;
      opt1.label = `${f.abbr} – ${f.type}`;
      facilityList.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = f.abbr;
      opt2.label = f.name;
      facilityList.appendChild(opt2);
    });
  }
  fillFacilityDatalist();

  function normalizeFacilityKey(s) {
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ");
  }

  function findFacility(query) {
    const q = normalizeFacilityKey(query);
    if (!q) return null;

    // exact abbreviation match
    const byAbbr = MEDICAL_FACILITIES.find(f => normalizeFacilityKey(f.abbr) === q);
    if (byAbbr) return byAbbr;

    // exact name match
    const byName = MEDICAL_FACILITIES.find(f => normalizeFacilityKey(f.name) === q);
    if (byName) return byName;

    // strong prefix match (name)
    const prefix = MEDICAL_FACILITIES.find(f => normalizeFacilityKey(f.name).startsWith(q));
    if (prefix) return prefix;

    // contains match (name)
    const contains = MEDICAL_FACILITIES.find(f => normalizeFacilityKey(f.name).includes(q));
    if (contains) return contains;

    return null;
  }

  function setEmergencyAutofill(facility) {
    if (!facility) return;
    // Set facility full name if user typed acronym
    if (facilityInput && normalizeFacilityKey(facilityInput.value) === normalizeFacilityKey(facility.abbr)) {
      facilityInput.value = facility.name;
    }
    if (phoneInput) phoneInput.value = "911";
    if (erTextarea) {
      erTextarea.value =
        `Ensure your safety and move to a secure area. Call 911 for emergencies and, if needed, go to ${facility.name}, ${facility.address} for medical attention. Report the incident to your supervisor as soon as it’s safe and complete an incident report.`;
    }
  }

  function clearEmergencyAutofill() {
    if (phoneInput) phoneInput.value = "";
    if (erTextarea) erTextarea.value = "";
  }

  if (facilityInput) {
    facilityInput.addEventListener("input", () => {
      const val = facilityInput.value || "";
      if (!val.trim()) {
        clearEmergencyAutofill();
        return;
      }
      // Only auto-fill when there is a confident match (abbr exact, name exact, or strong prefix >= 3 chars)
      const match = findFacility(val);
      const q = normalizeFacilityKey(val);
      const strong = (q.length >= 3) || (q === normalizeFacilityKey(match?.abbr));
      if (match && strong) setEmergencyAutofill(match);
    });

    facilityInput.addEventListener("blur", () => {
      const val = facilityInput.value || "";
      if (!val.trim()) {
        clearEmergencyAutofill();
        return;
      }
      const match = findFacility(val);
      if (match) setEmergencyAutofill(match);
    });
  }

  // ==========================
  // OFFLINE HAZARD RULE ENGINE (improved matching, plural-handling, better construction rules)
  // Controls are kept short (target < 185 chars)
  // Includes "dog" keyword for dogs
  // Auto-fills F/S/P if empty
  // Clears control + F/S/P/R when hazard cleared
  // ==========================
// --- helpers ---
  function clipControl(text, max = 185) {
    const t = (text || "").replace(/\s+/g, " ").trim();
    if (t.length <= max) return t;
    return t.slice(0, max - 1).trimEnd() + "…";
  }

  function normalize(text) {
    return (text || "")
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function stemToken(tok) {
    let t = tok || "";
    if (t.length <= 3) return t;

    // plural handling
    if (t.endsWith("ies") && t.length > 4) t = t.slice(0, -3) + "y";
    else if (t.endsWith("es") && t.length > 4) t = t.slice(0, -2);
    else if (t.endsWith("s") && t.length > 3) t = t.slice(0, -1);

    // gerund
    if (t.endsWith("ing") && t.length > 5) t = t.slice(0, -3);

    return t;
  }

  function tokens(text) {
    const n = normalize(text);
    if (!n) return [];
    return n.split(" ").map(stemToken).filter(Boolean);
  }

  function toKeywordSet(keywordCsv) {
    // keywords field is a comma-separated list
    return new Set(
      (keywordCsv || "")
        .split(",")
        .map(s => stemToken(normalize(s)))
        .filter(Boolean)
    );
  }

  // Build an indexed version once (fast + consistent)
  const HAZARD_INDEX = (HAZARD_LIBRARY || []).map(h => {
    const nameNorm = normalize(h.name);
    const nameTokens = new Set(tokens(h.name));
    const kwSet = toKeywordSet(h.keywords);

    // also include name tokens in kwSet for stronger matching
    nameTokens.forEach(t => kwSet.add(t));

    // controls (force <=185)
    const c1 = clipControl((h.controls && h.controls[0]) || "");
    const c2 = clipControl((h.controls && h.controls[1]) || c1);

    // risk safe defaults
    const F = Number(h?.risk?.F) || "";
    const S = Number(h?.risk?.S) || "";
    const P = Number(h?.risk?.P) || "";
    const R = Number(h?.risk?.R) || ((Number(F) && Number(S) && Number(P)) ? (F * S * P) : "");

    return {
      name: h.name,
      nameNorm,
      kwSet,
      risk: { F, S, P, R },
      controls: [c1, c2]
    };
  });

  // Strong “anti-wrong-match” boosts so "construction" doesn't match generator
  function rulePriorityBoost(hTextNorm, hTokSet) {
    const hasConstruction = hTokSet.has("construction");
    const hasFence = hTokSet.has("fence") || hTokSet.has("fencing") || hTokSet.has("panel") || hTokSet.has("gate");
    const hasTraffic = hTokSet.has("traffic") || hTokSet.has("truck") || hTokSet.has("vehicle") || hTokSet.has("road") || hTokSet.has("lane");
    const hasGenerator = hTokSet.has("generator") || hTokSet.has("genset") || hTokSet.has("genny");

    return { hasConstruction, hasFence, hasTraffic, hasGenerator };
  }

  function scoreHazardIndexItem(item, hTextNorm, hTokSet, boosts) {
    let score = 0;

    // exact name contains
    if (hTextNorm === item.nameNorm) score += 30;
    if (item.nameNorm && hTextNorm.includes(item.nameNorm)) score += 18;

    // token overlap
    item.kwSet.forEach(k => {
      if (hTokSet.has(k)) score += 2;
    });

    // targeted boosts to stop wrong matches
    if (boosts.hasConstruction) {
      if (item.nameNorm.includes("construction") || item.kwSet.has("construction")) score += 4;
      // if the user says construction + fence -> strongly prefer fencing
      if (boosts.hasFence && (item.kwSet.has("fence") || item.nameNorm.includes("fenc"))) score += 12;
      // construction + traffic -> strongly prefer traffic
      if (boosts.hasTraffic && (item.kwSet.has("traffic") || item.nameNorm.includes("traffic"))) score += 12;
      // construction ALONE should not prefer generator unless generator keyword present
      if (!boosts.hasGenerator && item.nameNorm.includes("generator")) score -= 10;
    }

    // if user explicitly typed generator, allow it
    if (boosts.hasGenerator && item.nameNorm.includes("generator")) score += 10;

    // if user explicitly typed fence-ish, penalize generator
    if (boosts.hasFence && item.nameNorm.includes("generator")) score -= 12;

    return score;
  }

  function pickBestHazard(hazardText) {
    const hTextNorm = normalize(hazardText);
    if (!hTextNorm) return null;

    const hTokSet = new Set(tokens(hazardText));
    const boosts = rulePriorityBoost(hTextNorm, hTokSet);

    let best = null;
    let bestScore = -Infinity;

    for (const item of HAZARD_INDEX) {
      const s = scoreHazardIndexItem(item, hTextNorm, hTokSet, boosts);
      if (s > bestScore) {
        bestScore = s;
        best = item;
      }
    }

    // minimum confidence threshold
    if (!best || bestScore < 8) return null;
    return best;
  }

  // ==========================
  // RISK CALC (R = F × S × P)
  // (your existing function stays)
  // ==========================
  function updateRiskForRow(row) {
    const fInput = document.querySelector('input[name="f_' + row + '"]');
    const sInput = document.querySelector('input[name="s_' + row + '"]');
    const pInput = document.querySelector('input[name="p_' + row + '"]');
    const rInput = document.querySelector('input[name="r_' + row + '"]');
    if (!fInput || !sInput || !pInput || !rInput) return;

    const f = parseInt(fInput.value, 10);
    const s = parseInt(sInput.value, 10);
    const p = parseInt(pInput.value, 10);

    if (Number.isInteger(f) && Number.isInteger(s) && Number.isInteger(p)) {
      rInput.value = f * s * p;
    } else {
      rInput.value = "";
    }
  }

  function clearRow(row) {
    const f = document.querySelector(`input[name="f_${row}"]`);
    const s = document.querySelector(`input[name="s_${row}"]`);
    const p = document.querySelector(`input[name="p_${row}"]`);
    const r = document.querySelector(`input[name="r_${row}"]`);
    const c = document.querySelector(`textarea[name="control_${row}"]`);
    if (f) f.value = "";
    if (s) s.value = "";
    if (p) p.value = "";
    if (r) r.value = "";
    if (c) c.value = "";
  }

  function applyHazardToRow(hItem, row) {
    const controlField = document.querySelector(`textarea[name="control_${row}"]`);
    const fField = document.querySelector(`input[name="f_${row}"]`);
    const sField = document.querySelector(`input[name="s_${row}"]`);
    const pField = document.querySelector(`input[name="p_${row}"]`);

    // 2 controls, randomly choose for less uniformity
    const choices = (hItem.controls || []).filter(Boolean);
    const picked = choices.length ? choices[Math.floor(Math.random() * choices.length)] : "";

    if (controlField) {
      // overwrite only if blank/short
      if (!controlField.value || controlField.value.trim().length < 15) {
        controlField.value = clipControl(picked, 185);
      }
    }

    // auto-fill ratings only if empty
    if (fField && !fField.value && hItem.risk?.F) fField.value = String(hItem.risk.F);
    if (sField && !sField.value && hItem.risk?.S) sField.value = String(hItem.risk.S);
    if (pField && !pField.value && hItem.risk?.P) pField.value = String(hItem.risk.P);

    updateRiskForRow(row);
  }

  function initHazardAutoSuggest() {
    document.querySelectorAll('input[name^="hazard_"]').forEach(input => {

      // When hazard cleared, clear control + ratings + risk
      input.addEventListener('input', e => {
        const value = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];
        if (!value) clearRow(row);
      });

      // On blur, try to match and fill
      input.addEventListener('blur', e => {
        const hazardText = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];

        if (!hazardText) {
          clearRow(row);
          return;
        }

        const best = pickBestHazard(hazardText);
        if (!best) {
          // no confident match; still compute risk if user entered values
          updateRiskForRow(row);
          return;
        }

        applyHazardToRow(best, row);
      });
    });
  }
  initHazardAutoSuggest();

  // keep your existing listeners for manual F/S/P edits
  document.querySelectorAll('.risk-input').forEach(input => {
    input.addEventListener('input', () => {
      const row = input.getAttribute('data-row');
      if (row) updateRiskForRow(row);
    });
  });
  
  }

  function initHazardAutoSuggest() {
    document.querySelectorAll('input[name^="hazard_"]').forEach(input => {
      input.addEventListener('blur', e => {
        const hazardText = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];

        if (!hazardText) {
          clearRow(row);
          return;
        }

        const rule = bestRuleForHazard(hazardText);
        if (!rule) {
          // If there is no confident match, do not overwrite user entries; still compute risk if they typed F/S/P
          updateRiskForRow(row);
          return;
        }
        applyRuleToRow(rule, row);
      });

      input.addEventListener('input', e => {
        const value = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];
        if (!value) {
          clearRow(row);
        }
      });
    });
  }
  initHazardAutoSuggest();

  // ==========================
  // PDF GENERATION (LEGAL SIZE)
  // Fix: ensure inputs + textareas are copied into clone so exports show:
  // - job tasks, hazards, F/S/P/R, control plans
  // - also copy signature canvases
  // Also removes unchecked common hazards rows to reduce PDF size
  // ==========================

  function copyFormValuesToClone(original, clone) {
    // inputs & textareas
    const origFields = original.querySelectorAll("input, textarea, select");
    origFields.forEach(orig => {
      const name = orig.getAttribute("name");
      const id = orig.getAttribute("id");

      let sel = null;
      if (id) sel = clone.querySelector(`#${CSS.escape(id)}`);
      if (!sel && name) sel = clone.querySelector(`[name="${CSS.escape(name)}"]`);
      if (!sel) return;

      if (orig.tagName.toLowerCase() === "textarea") {
        sel.value = orig.value;
        sel.textContent = orig.value; // important for html2canvas
      } else if (orig.type === "checkbox") {
        sel.checked = orig.checked;
        if (orig.checked) sel.setAttribute("checked", "checked");
        else sel.removeAttribute("checked");
      } else if (orig.type === "radio") {
        sel.checked = orig.checked;
        if (orig.checked) sel.setAttribute("checked", "checked");
        else sel.removeAttribute("checked");
      } else {
        sel.value = orig.value;
        sel.setAttribute("value", orig.value); // helps clone rendering
      }
    });

    // signature canvases
    ["pcSignature","saSignature","clientSignature"].forEach(cid => {
      const origCanvas = document.getElementById(cid);
      const cloneCanvas = clone.querySelector(`#${CSS.escape(cid)}`);
      if (origCanvas && cloneCanvas) {
        // size clone canvas to match display size
        const rect = cloneCanvas.getBoundingClientRect();
        const ratio = 1;
        cloneCanvas.width = Math.floor((rect.width || 300) * ratio);
        cloneCanvas.height = Math.floor((rect.height || 80) * ratio);
        const cctx = cloneCanvas.getContext("2d");
        const dataUrl = origCanvas.toDataURL("image/png");
        const img = new Image();
        img.onload = () => {
          cctx.clearRect(0,0,cloneCanvas.width, cloneCanvas.height);
          cctx.drawImage(img, 0, 0, cloneCanvas.width, cloneCanvas.height);
        };
        img.src = dataUrl;
      }
    });
  }

  function expandTextareasForExport(cloneRoot) {
    cloneRoot.querySelectorAll("textarea").forEach(t => {
      t.style.height = "auto";
      t.style.minHeight = "0";
      t.style.maxHeight = "none";
      t.style.overflow = "visible";
      // ensure value is present in textContent too
      t.textContent = t.value || t.textContent || "";
      t.style.height = (t.scrollHeight + 2) + "px";
    });
  }

  function createFilteredFormClone() {
    const form = document.getElementById('hazardForm');
    const clone = form.cloneNode(true);

    // Copy values (CRITICAL fix for exported job tasks/hazards/controls)
    copyFormValuesToClone(form, clone);

    // Remove unchecked common hazard rows
    const commonTableBody = clone.querySelector('#commonHazardsTable tbody');
    if (commonTableBody) {
      Array.from(commonTableBody.rows).forEach(row => {
        const appliesCheckbox = row.querySelector('td:first-child input[type="checkbox"]');
        if (appliesCheckbox && !appliesCheckbox.checked) {
          row.remove();
        }
      });
      // If none selected, remove table entirely to reduce blank space
      if (commonTableBody.rows.length === 0) {
        const tbl = clone.querySelector("#commonHazardsTable");
        if (tbl) tbl.remove();
      }
    }

    // Remove buttons in export
    const clonedButtonRow = clone.querySelector('#buttonRow');
    if (clonedButtonRow) clonedButtonRow.style.display = 'none';

    // Make sure datalist doesn't show as field content
    const dl = clone.querySelector("#facilityList");
    if (dl) dl.remove();

    // Add version stamp to clone
    const stamp = document.getElementById("versionStamp");
    if (stamp) clone.appendChild(stamp.cloneNode(true));

    // Expand textareas to show full text in export
    expandTextareasForExport(clone);

    return clone;
  }

  async function generatePdf() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'legal');

    const clone = createFilteredFormClone();

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.style.width = '1050px';
    tempContainer.style.background = '#ffffff';
    tempContainer.appendChild(clone);
    document.body.appendChild(tempContainer);

    // Let async canvas copies (signature images) paint
    await new Promise(r => setTimeout(r, 150));

    const clonePage1 = clone.querySelector('#page1');
    const clonePage2 = clone.querySelector('#page2');

    async function addPage(div, addNew) {
      if (!div) return;
      if (addNew) pdf.addPage();

      // Ensure textarea expansion just before capture
      expandTextareasForExport(clone);

      const canvas = await html2canvas(div, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
        windowWidth: 1050
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 8;

      let imgW = pageWidth - margin * 2;
      let imgH = canvas.height * (imgW / canvas.width);

      if (imgH > pageHeight - margin * 2) {
        imgH = pageHeight - margin * 2;
        imgW = canvas.width * (imgH / canvas.height);
      }

      const x = (pageWidth - imgW) / 2;
      const y = margin;

      pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH);
    }

    await addPage(clonePage1, false);
    await addPage(clonePage2, true);

    document.body.removeChild(tempContainer);
    return pdf;
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        pdf.save(getFinalFileName());
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        const blob = pdf.output('blob');
        const fileName = getFinalFileName();
        const file = new File([blob], fileName, { type: 'application/pdf' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'Worksite Hazard Assessment',
            text: 'VistaGeomatics – Worksite Hazard Assessment PDF'
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
      } catch (e) {
        console.error('Share failed:', e);
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }
</script>
</body>
</html>
