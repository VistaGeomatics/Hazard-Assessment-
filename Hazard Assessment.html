<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VistaGeomatics – Worksite Hazard Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --vista-blue: #165f7d;
      --vista-blue-light: #2a7fa3;
      --vista-blue-dark: #0b3045;
      --bg-body: #eef3f9;
      --bg-card: #ffffff;
      --border-soft: #d6e2f0;
      --text-main: #101827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top, #f4f8fc 0, #e4edf6 40%, #dde6f3 100%);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    .page-wrap { max-width: 1050px; margin: 0 auto; }

    .container {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 14px 30px rgba(5, 41, 66, 0.18), 0 0 0 1px rgba(5, 41, 66, 0.04);
      overflow: hidden;
      position: relative;
      margin-bottom: 18px;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(22,95,125,0.16), transparent 55%);
      opacity: 0.9;
    }

    .header-bar {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: linear-gradient(120deg, var(--vista-blue-light) 0%, var(--vista-blue) 40%, var(--vista-blue-dark) 100%);
      color: #fff;
    }

    .header-left h1 {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .header-left p { margin: 2px 0 0; font-size: 0.8rem; opacity: 0.9; }

    .header-logo { height: 60px; filter: drop-shadow(0 5px 14px rgba(0,0,0,0.35)); }

    .page-title-bar {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 10px 20px 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.78), #f7faff);
    }

    .page-title-main {
      font-family: "Montserrat", sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--vista-blue-dark);
    }

    .page-title-sub { margin-top: 3px; font-size: 0.78rem; color: var(--text-muted); }

    .page-title-accent {
      width: 120px;
      height: 3px;
      margin: 8px auto 0;
      border-radius: 999px;
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      box-shadow: 0 0 8px rgba(46,167,224,0.65);
    }

    .page-body { position: relative; z-index: 1; padding: 10px 18px 14px; font-size: 0.8rem; }

    label { font-size: 0.78rem; font-weight: 600; display: block; margin-bottom: 2px; color: var(--text-main); }

    input[type="text"], input[type="date"], input[type="time"], textarea, .small-input {
      width: 100%;
      font-family: "Inter", sans-serif;
      font-size: 0.74rem;
      line-height: 1.25;
      color: var(--text-main);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      transition: 0.15s;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="text"], input[type="date"], input[type="time"], .small-input {
      height: 34px;
      padding: 6px 8px;
      vertical-align: middle;
    }

    textarea { padding: 6px 8px; min-height: 56px; resize: vertical; }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--vista-blue-light);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(38,132,168,0.18);
    }

    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 4px; }
    .row > div { flex: 1; min-width: 150px; }

    .section-card {
      margin-top: 8px;
      padding: 8px 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, #fbfdff 0%, #f4f8fd 60%, #eff5fb 100%);
      box-shadow: 0 6px 16px rgba(5, 41, 66, 0.05);
      position: relative;
    }

    .section-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      border-radius: 12px 12px 0 0;
      background: linear-gradient(90deg, var(--vista-blue-light), var(--vista-blue-dark));
    }

    .section-header { display: flex; justify-content: space-between; align-items: baseline; gap: 6px; margin-bottom: 4px; }

    .section-title {
      font-weight: 600;
      font-size: 0.86rem;
      color: var(--vista-blue-dark);
      font-family: "Montserrat", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .section-note { font-size: 0.72rem; color: var(--text-muted); }

    .inline-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.76rem; align-items: center; }
    .inline-checkbox-group label { display: inline-flex; align-items: center; gap: 4px; font-weight: 500; margin-bottom: 0; }

    input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--vista-blue); margin: 0; }

    .small-text { font-size: 0.74rem; color: var(--text-muted); }

    table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 4px; }
    th, td { border: 1px solid var(--border-soft); padding: 3px 4px; vertical-align: top; }
    th { background: #e8f0fb; font-weight: 600; color: var(--vista-blue-dark); }
    td { background: #f9fbff; }
    .center { text-align: center; }

    .signature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; margin-top: 4px; }
    .signature-box { border-radius: 10px; border: 1px solid var(--border-soft); background: #f9fbff; padding: 6px; font-size: 0.78rem; }
    .signature-label { font-size: 0.74rem; font-weight: 600; color: var(--text-muted); margin-bottom: 2px; }

    .signature-canvas {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      display: block;
      cursor: crosshair;
    }

    .signature-actions { display: flex; justify-content: flex-end; margin-top: 4px; }
    .signature-actions button { padding: 3px 10px; font-size: 0.7rem; letter-spacing: 0.05em; }
    .signature-row { display: flex; gap: 6px; margin-top: 4px; }
    .signature-row > div { flex: 1; }

    .btn-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; margin-bottom: 4px; flex-wrap: wrap; }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      color: #fff;
      box-shadow: 0 8px 20px rgba(5, 41, 66, 0.35);
    }

    .btn-secondary { background: #f3f4f6; color: var(--text-main); border: 1px solid #d6d7dd; }

    button:hover { transform: translateY(-1px); box-shadow: 0 9px 22px rgba(15, 23, 42, 0.18); }

    .control-text {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      padding: 6px 8px;
      line-height: 1.25;
      font-size: 0.74rem;
      white-space: pre-wrap;
    }

    .risk-input, .risk-output {
      height: 32px !important;
      padding: 5px 6px !important;
      line-height: 1.2 !important;

      font-size: 0.74rem !important;
      text-align: center;
    }

    .version-stamp{
      position: fixed;
      right: 14px;
      bottom: 10px;
      z-index: 50;
      font-family: "Inter", sans-serif;
      font-size: 0.68rem;
      letter-spacing: 0.06em;
      color: rgba(16,24,39,0.75);
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(214,226,240,0.9);
      padding: 4px 10px;
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(5,41,66,0.08);
      backdrop-filter: blur(4px);
    }

    @media (max-width: 700px) {
      .header-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
      .page-title-main { font-size: 1.05rem; letter-spacing: 0.12em; }
    }
  </style>
</head>

<body>
<div class="page-wrap">
  <form id="hazardForm">
    <!-- PAGE 1 -->
    <div class="container" id="page1">
      <div class="header-bar">
        <div class="header-left">
          <h1>VISTAGEOMATICS</h1>
          <p>Worksite Hazard Assessment &amp; Tailgate Report</p>
        </div>
        <img src="vista-geomatics.png" alt="VistaGeomatics Logo" class="header-logo">
      </div>

      <div class="page-title-bar">
        <div class="page-title-main">Worksite Hazard Assessment</div>
        <div class="page-title-sub">Identify hazards and controls prior to commencing work.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">General Information</div>
          </div>
          <div class="row">
            <div>
              <label for="developed_by">Developed By</label>
              <input type="text" id="developed_by" name="developed_by">
            </div>
            <div>
              <label for="location">Location</label>
              <input type="text" id="location" name="location">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="date">Date</label>
              <input type="date" id="date" name="date">
            </div>
            <div>
              <label for="start_time">Start Time</label>
              <input type="time" id="start_time" name="start_time">
            </div>
            <div>
              <label for="completion_time">Form Completion Time</label>
              <input type="time" id="completion_time" name="completion_time">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="job_number">Job Number</label>
              <input type="text" id="job_number" name="job_number">
            </div>
            <div>
              <label for="description">Description of Work</label>
              <input type="text" id="description" name="description">
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Tailgate Meeting Report</div>
            <div class="section-note">Complete daily prior to starting work and when procedures change or new hazards are present.</div>
          </div>
          <div style="margin-bottom:4px;">
            <label for="tailgate_minutes">Tailgate Minutes</label>
            <textarea id="tailgate_minutes" name="tailgate_minutes"></textarea>
          </div>

          <div class="row">
            <div style="flex:1;">
              <label>Site Sidewalk and Fencing Condition Report</label>
              <div class="inline-checkbox-group">
                <span>Did you drive on the sidewalk?</span>
                <label><input type="checkbox" name="sidewalk_yes"> Yes</label>
                <label><input type="checkbox" name="sidewalk_no"> No</label>
                <span>Fences Installed?</span>
                <label><input type="checkbox" name="fences_yes"> Yes</label>
                <label><input type="checkbox" name="fences_no"> No</label>
              </div>
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="sidewalk_comments">Comments</label>
            <textarea id="sidewalk_comments" name="sidewalk_comments"></textarea>
          </div>

          <div style="margin-top:4px;">
            <label>Pictures Taken:</label>
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="pic_site"> Site</label>
              <label><input type="checkbox" name="pic_sidewalk"> Sidewalk</label>
              <label><input type="checkbox" name="pic_fences"> Fences</label>
              <label><input type="checkbox" name="pic_hazards"> Hazards</label>
              <label>
                <input type="checkbox" name="pic_other"> Other (Describe):
                <input type="text" name="pic_other_desc" style="width:160px;">
              </label>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Working Alone &amp; Check-in</div>
          </div>

          <div class="row">
            <div style="flex:1 1 35%;">
              <label>Working Alone</label>
              <div class="inline-checkbox-group">
                <label><input type="checkbox" name="working_alone_yes"> Yes</label>
                <label><input type="checkbox" name="working_alone_no"> No</label>
              </div>
            </div>
            <div style="flex:1 1 30%;">
              <label for="check_in_interval">Check-in Interval</label>
              <input type="text" id="check_in_interval" name="check_in_interval" placeholder="e.g., Hourly, Every 2 hours">
            </div>
            <div style="flex:1 1 30%;">
              <label for="communication_method">Communication Method</label>
              <input type="text" id="communication_method" name="communication_method" placeholder="e.g., Phone, Radio">
            </div>
          </div>

          <div class="row">
            <div style="flex:1 1 40%;">
              <label for="working_supervisor_name">Contact Procedures – Call Supervisor: Name</label>
              <input type="text" id="working_supervisor_name" name="working_supervisor_name">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_in_time">Check-in Time</label>
              <input type="time" id="check_in_time" name="check_in_time">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_out_time">Check-out Time</label>
              <input type="time" id="check_out_time" name="check_out_time">
            </div>
          </div>

          <div class="small-text" style="margin-top:4px;">
            <strong>Note:</strong> Check-in intervals are based on risk level,
            High risk: hourly, Medium risk: every 2 hours, Low risk: start and end of shift.
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Daily Equipment Inspection</div>
            <div class="section-note">Check your vehicle, ATV, snowmobile, generator, trailer, and/or chainsaw and report any deficiencies.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Equipment</th>
              <th>Inspection Items</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>Vehicle</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="veh_tires"> Tires</label>
                  <label><input type="checkbox" name="veh_oil"> Oil</label>
                  <label><input type="checkbox" name="veh_fuel"> Fuel</label>
                  <label><input type="checkbox" name="veh_washer"> Washer fluid</label>
                  <label><input type="checkbox" name="veh_lights"> Lights</label>
                  <label><input type="checkbox" name="veh_tiedowns"> Tie-Down Straps</label>
                  <label>Other: <input type="text" name="veh_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>ATV / Snowmobile</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="atv_tires"> Tires/Track</label>
                  <label><input type="checkbox" name="atv_oil_fuel"> Oil/Fuel</label>
                  <label><input type="checkbox" name="atv_lights"> Lights</label>
                  <label><input type="checkbox" name="atv_brakes"> Brakes</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Generator</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="gen_oil"> Oil</label>
                  <label><input type="checkbox" name="gen_fuel"> Fuel</label>
                  <label><input type="checkbox" name="gen_cord"> Extension Cord</label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Chainsaw (if used)</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="saw_oil"> Oil</label>
                  <label><input type="checkbox" name="saw_fuel"> Fuel</label>
                  <label><input type="checkbox" name="saw_chain"> Chain</label>
                  <label><input type="checkbox" name="saw_guard"> Guard</label>
                  <label>Other: <input type="text" name="saw_other" style="width:120px;"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td>Trailer</td>
              <td>
                <div class="inline-checkbox-group">
                  <label><input type="checkbox" name="trl_tires"> Tires</label>
                  <label><input type="checkbox" name="trl_lights"> Lights</label>
                  <label><input type="checkbox" name="trl_chains"> Safety Chains</label>
                  <label><input type="checkbox" name="trl_deck"> Deck</label>
                  <label><input type="checkbox" name="trl_plate"> Licence Plate</label>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Personal Protective Equipment</div>
            <div class="section-note">Check off required PPE; report missing or worn items as needed.</div>
          </div>

          <div class="inline-checkbox-group">
            <label><input type="checkbox" name="ppe_hardhat"> Hardhat</label>
            <label><input type="checkbox" name="ppe_atv_helmet"> ATV Helmets</label>
            <label><input type="checkbox" name="ppe_signs"> Signs</label>
            <label><input type="checkbox" name="ppe_eye"> Eye Protection</label>
            <label><input type="checkbox" name="ppe_gloves"> Gloves</label>
            <label><input type="checkbox" name="ppe_csa_footwear"> CSA Approved Footwear</label>
            <label><input type="checkbox" name="ppe_winter"> Winter Clothing</label>
            <label><input type="checkbox" name="ppe_reflective"> Reflective Clothing</label>
            <label><input type="checkbox" name="ppe_frc"> Fire Retardant Coveralls</label>
            <label><input type="checkbox" name="ppe_hearing"> Hearing Protection</label>
            <label><input type="checkbox" name="ppe_chaps"> Chainsaw Pants/Chaps</label>
            <label><input type="checkbox" name="ppe_first_aid"> Personal First Aid Kit</label>
            <label><input type="checkbox" name="ppe_gas_monitor"> H2S, Methane, Oxygen, CO Monitor</label>
            <label>Other: <input type="text" name="ppe_other" style="width:160px;"></label>
          </div>


        </div>
      </div>
    </div>

    <!-- PAGE 2 -->
    <div class="container" id="page2">
      <div class="page-title-bar">
        <div class="page-title-main">Job Tasks, Hazards &amp; Controls</div>
        <div class="page-title-sub">Controls and ratings auto-suggest from an embedded offline ruleset.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Common Occurring Hazards</div>
            <div class="section-note">Unchecked rows will be removed from the PDF.</div>
          </div>

          <table id="commonHazardsTable">
            <thead>
            <tr>
              <th class="center">Applies</th>
              <th>Hazard</th>
              <th>Controls (from Worksite Hazard Assessment)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td class="center"><input type="checkbox" name="haz_buried_overhead"></td>
              <td>Buried or Overhead Facilities</td>
              <td>Use caution near facilities. Maintain safe approach limits. Report damage immediately. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_hunting"></td>
              <td>Hunting Season</td>
              <td>Know season and areas, stay together, make noise. If hunters seen, advise presence. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_housekeeping"></td>
              <td>Site Housekeeping</td>
              <td>Keep areas clean and clear of obstructions. Remove trip hazards promptly. Review SWP.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_h2s"></td>
              <td>H2S Concerns</td>
              <td>Only work where trained. Use gas monitor, follow SWP, and use respiratory protection if required.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_open_excavation"></td>
              <td>Open Excavation</td>
              <td>Stay back from edges. Cross only at safe points. Never jump trenches. Wear hard hat and boots.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_fences"></td>
              <td>Construction Fences – Installed</td>
              <td>Use crossings, avoid fence bases, and adjust panels slowly. Keep clear in wind and when moving panels.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wild_animals"></td>
              <td>Wild Animals</td>
              <td>Stay alert, do not approach wildlife. Carry bear spray where applicable. Secure food and garbage.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_river"></td>
              <td>River: High/Low Spring Flood</td>
              <td>Keep distance from banks. Use safe crossing points or alternate routes. Stop if conditions worsen.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_traffic"></td>
              <td>On and Off Traffic or Construction</td>
              <td>Stay visible and alert. Use spotter and eye contact. Keep setups away from travel paths. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_icy"></td>
              <td>Icy Conditions</td>
              <td>Slow down and use slip-resistant footwear. Keep hands free. Reduce driving speed and increase distance.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_noise"></td>
              <td>Excessive Noise Levels</td>
              <td>Limit exposure, use hearing protection, and set clear communication methods. Stay aware of surroundings.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_wildfire"></td>
              <td>Wild Fire Hazard – Fire Ban in Effect</td>
              <td>Follow fire-ban rules. Avoid ignition sources near dry grass. Keep extinguisher ready and inspected.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_farming"></td>
              <td>Farming Operations (cattle or other animals)</td>
              <td>Make presence known, keep distance from livestock, and avoid flagging in pastures. Wear hi-vis.</td>
            </tr>
            <tr>
              <td class="center"><input type="checkbox" name="haz_landowner"></td>
              <td>Land Owner / Home Owner – Made Contact</td>
              <td>Stay calm, listen respectfully, explain work, and leave if escalating. Report to supervisor and client.</td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Job Specific Hazards</div>
            <div class="section-note">Controls and ratings auto-suggest when you leave the hazard cell.</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Job Tasks</th>
              <th>Hazards</th>
              <th class="center">F</th>
              <th class="center">S</th>
              <th class="center">P</th>
              <th class="center">R</th>
              <th>Control Plan / Barriers / Procedures</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td><input type="text" name="task_1" /></td>
              <td><input type="text" name="hazard_1" placeholder="e.g. dog, traffic, construction fencing, digging, generator" /></td>
              <td class="center"><input type="text" name="f_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_1" class="risk-input" data-row="1" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_1" class="risk-output" data-row="1" style="width:40px;" readonly></td>
              <td><textarea name="control_1" class="control-text" placeholder="Controls auto-suggest when you leave the hazard cell."></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_2" /></td>
              <td><input type="text" name="hazard_2" /></td>
              <td class="center"><input type="text" name="f_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_2" class="risk-input" data-row="2" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_2" class="risk-output" data-row="2" style="width:40px;" readonly></td>
              <td><textarea name="control_2" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_3" /></td>
              <td><input type="text" name="hazard_3" /></td>
              <td class="center"><input type="text" name="f_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_3" class="risk-input" data-row="3" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_3" class="risk-output" data-row="3" style="width:40px;" readonly></td>
              <td><textarea name="control_3" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_4" /></td>
              <td><input type="text" name="hazard_4" /></td>
              <td class="center"><input type="text" name="f_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_4" class="risk-input" data-row="4" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_4" class="risk-output" data-row="4" style="width:40px;" readonly></td>
              <td><textarea name="control_4" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_5" /></td>
              <td><input type="text" name="hazard_5" /></td>
              <td class="center"><input type="text" name="f_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_5" class="risk-input" data-row="5" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_5" class="risk-output" data-row="5" style="width:40px;" readonly></td>
              <td><textarea name="control_5" class="control-text"></textarea></td>
            </tr>
            <tr>
              <td><input type="text" name="task_6" /></td>
              <td><input type="text" name="hazard_6" /></td>
              <td class="center"><input type="text" name="f_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="s_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="p_6" class="risk-input" data-row="6" style="width:32px;"></td>
              <td class="center"><input type="text" name="r_6" class="risk-output" data-row="6" style="width:40px;" readonly></td>
              <td><textarea name="control_6" class="control-text"></textarea></td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Emergency Response Plan</div>
            <div class="section-note">Type facility name or acronym (e.g., FMC, SHC, CUCC) and select from list.</div>
          </div>

          <div class="row">
            <div>
              <label for="nearest_hospital">Nearest first aid facility or hospital</label>
              <input type="text" id="nearest_hospital" name="nearest_hospital" list="facilityList" placeholder="Start typing facility name or abbreviation">
              <datalist id="facilityList"></datalist>
            </div>
            <div>
              <label for="hospital_phone">Phone #</label>
              <input type="text" id="hospital_phone" name="hospital_phone">
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="emergency_procedures">Emergency Response Procedures</label>
            <textarea id="emergency_procedures" name="emergency_procedures"></textarea>
          </div>

          <div style="margin-top:4px;">
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="first_aid_available"> First Aid Kit Available</label>
              <label><input type="checkbox" name="fire_ext_available"> Fire Extinguisher Available</label>
              <label><input type="checkbox" name="effective_comm"> Effective Method of Communication Available</label>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Acknowledgement &amp; Sign-off</div>
          </div>

          <div class="signature-grid">
            <div class="signature-box">
              <div class="signature-label">Party Chief – Signature</div>
              <canvas id="pcSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearPcSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="pc_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="pc_date"></div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Rodman – Signature</div>
              <canvas id="saSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearSaSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="sa_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="sa_date"></div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Client Rep / Safety Coordinator / Additional Rodman – Signature</div>
              <canvas id="clientSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearClientSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="client_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="client_date"></div>
              </div>
            </div>
          </div>

          <div style="margin-top:6px;">
            <label for="crew_contact">Crew Contact No.</label>
            <input type="text" id="crew_contact" name="crew_contact">
          </div>

          <div class="btn-row" id="buttonRow">
            <button type="reset" class="btn-secondary" id="resetBtn">Reset</button>
            <button type="button" class="btn-secondary" id="nameBtn">Name File</button>
            <button type="button" class="btn-primary" id="downloadBtn">Download PDF</button>
            <button type="button" class="btn-secondary" id="shareBtn">Share PDF</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="version-stamp" id="versionStamp">v3.4</div>

<!-- OFFLINE NOTE:
     Put these files beside this HTML for offline use:
     ./jspdf.umd.min.js
     ./html2canvas.min.js
-->
<script src="./jspdf.umd.min.js"></script>
<script src="./html2canvas.min.js"></script>

<script>
  // ============================================================
  // BASIC UTIL
  // ============================================================
  const downloadBtn = document.getElementById('downloadBtn');
  const shareBtn    = document.getElementById('shareBtn');
  const nameBtn     = document.getElementById('nameBtn');
  const buttonRow   = document.getElementById('buttonRow');

  let userChosenFileName = "";

  function safeFilePart(s) {
    return (s || "")
      .toString()
      .trim()
      .replace(/[\\/:*?"<>|]+/g, "")
      .replace(/\s+/g, "_")
      .slice(0, 60);
  }

  function yyyyMmDd(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function getDefaultFileName() {
    const job = safeFilePart(document.getElementById("job_number")?.value);
    const dev = safeFilePart(document.getElementById("developed_by")?.value);
    const today = yyyyMmDd(new Date());
    const parts = [job || "Job", dev || "DevelopedBy", today];
    return parts.filter(Boolean).join("_") + ".pdf";
  }

  function getFinalFileName() {
    const base = (userChosenFileName || "").trim();
    if (base) {
      const cleaned = safeFilePart(base).replace(/\.pdf$/i, "");
      return (cleaned || "WorksiteHazardAssessment") + ".pdf";
    }
    return getDefaultFileName();
  }

  if (nameBtn) {
    nameBtn.addEventListener("click", () => {
      const suggested = getDefaultFileName().replace(/\.pdf$/i, "");
      const input = prompt("Name the PDF file (without .pdf):", userChosenFileName || suggested);
      if (input === null) return;
      userChosenFileName = input.trim();
    });
  }

  // ============================================================
  // RISK CALC (R = F × S × P)
  // ============================================================
  function updateRiskForRow(row) {
    const fInput = document.querySelector('input[name="f_' + row + '"]');
    const sInput = document.querySelector('input[name="s_' + row + '"]');
    const pInput = document.querySelector('input[name="p_' + row + '"]');
    const rInput = document.querySelector('input[name="r_' + row + '"]');
    if (!fInput || !sInput || !pInput || !rInput) return;

    const f = parseInt(fInput.value, 10);
    const s = parseInt(sInput.value, 10);
    const p = parseInt(pInput.value, 10);

    if (Number.isInteger(f) && Number.isInteger(s) && Number.isInteger(p)) rInput.value = f * s * p;
    else rInput.value = "";
  }

  document.querySelectorAll('.risk-input').forEach(input => {
    input.addEventListener('input', () => {
      const row = input.getAttribute('data-row');
      if (row) updateRiskForRow(row);
    });
  });

  // ============================================================
  // SIGNATURE PADS
  // ============================================================
  function initSignaturePad(canvasId, clearButtonId) {
    const canvas = document.getElementById(canvasId);
    const clearBtn = document.getElementById(clearButtonId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let drawing = false, lastX = 0, lastY = 0;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111827';
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      const isTouch = evt.touches && evt.touches[0];
      const clientX = isTouch ? evt.touches[0].clientX : evt.clientX;
      const clientY = isTouch ? evt.touches[0].clientY : evt.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(evt) { drawing = true; const p = getPos(evt); lastX = p.x; lastY = p.y; }
    function drawLine(evt) {
      if (!drawing) return;
      const p = getPos(evt);
      ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.stroke();
      lastX = p.x; lastY = p.y;
    }
    function endDraw() { drawing = false; }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', drawLine);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e); }, { passive: false });
    canvas.addEventListener('touchmove',  e => { e.preventDefault(); drawLine(e); }, { passive: false });
    canvas.addEventListener('touchend',   e => { e.preventDefault(); endDraw(); }, { passive: false });

    if (clearBtn) clearBtn.addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
  }

  initSignaturePad('pcSignature', 'clearPcSig');
  initSignaturePad('saSignature', 'clearSaSig');
  initSignaturePad('clientSignature', 'clearClientSig');

  const resetBtn = document.getElementById('resetBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      ['pcSignature','saSignature','clientSignature'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
      });
      document.querySelectorAll('.risk-output').forEach(o => o.value = "");
      userChosenFileName = "";
      clearEmergencyAutofill();
    });
  }

  // ============================================================
  // MEDICAL FACILITIES (FULL LIST)
  // ============================================================
  const MEDICAL_FACILITIES = [
    { name:"Foothills Medical Centre", abbr:"FMC", type:"Hospital", address:"1403 29 St NW, Calgary, AB, T2N 2T9" },
    { name:"Alberta Children's Hospital", abbr:"ACH", type:"Hospital", address:"28 Oki Dr NW, Calgary, AB, T3B 6A8" },
    { name:"Peter Lougheed Centre", abbr:"PLC", type:"Hospital", address:"3500 26 Ave NE, Calgary, AB, T1Y 6J4" },
    { name:"Rockyview General Hospital", abbr:"RGH", type:"Hospital", address:"7007 14 St SW, Calgary, AB, T2V 1P9" },
    { name:"South Health Campus", abbr:"SHC", type:"Hospital", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },
    { name:"Royal Alexandra Hospital", abbr:"RAH", type:"Hospital", address:"10240 Kingsway NW, Edmonton, AB, T5H 3V9" },
    { name:"University of Alberta Hospital", abbr:"UAH", type:"Hospital", address:"8440 112 St NW, Edmonton, AB, T6G 2B7" },
    { name:"Misericordia Community Hospital", abbr:"MCH", type:"Hospital", address:"16940 87 Ave NW, Edmonton, AB, T5R 4H5" },
    { name:"Grey Nuns Community Hospital", abbr:"GNH", type:"Hospital", address:"1100 Youville Dr W, Edmonton, AB, T6L 5X8" },
    { name:"Red Deer Regional Hospital Centre", abbr:"RDRHC", type:"Hospital", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Chinook Regional Hospital", abbr:"CRH", type:"Hospital", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Medicine Hat Regional Hospital", abbr:"MHRH", type:"Hospital", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Northern Lights Regional Health Centre", abbr:"NLRHC", type:"Hospital", address:"7 Hospital St, Fort McMurray, AB, T9H 1P2" },
    { name:"Grande Prairie Regional Hospital", abbr:"GPRH", type:"Hospital", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },
    { name:"Airdrie Community Health Centre", abbr:"ACHC", type:"Community Health Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"Drumheller Health Centre", abbr:"DHC", type:"Community Health Centre", address:"351 9 St NW, Drumheller, AB, T0J 0Y1" },
    { name:"Brooks Health Centre", abbr:"BHC", type:"Community Health Centre", address:"440 3 St E, Brooks, AB, T1R 0G8" },
    { name:"Strathmore District Health Services", abbr:"SDHS", type:"Community Health Centre", address:"200 Brent Blvd, Strathmore, AB, T1P 1J9" },
    { name:"Banff Mineral Springs Hospital", abbr:"BMSH", type:"Hospital", address:"305 Lynx St, Banff, AB, T1L 1C1" },
    { name:"Canmore General Hospital", abbr:"CGH", type:"Hospital", address:"1100 Hospital Pl, Canmore, AB, T1W 1N2" },
    { name:"Airdrie Urgent Care Centre", abbr:"AUCC", type:"Urgent Care Centre", address:"604 Main St S, Airdrie, AB, T4B 3K7" },
    { name:"South Calgary Urgent Care Centre", abbr:"SCUC", type:"Urgent Care Centre", address:"4448 Front St SE, Calgary, AB, T3M 1M4" },
    { name:"North Edmonton Urgent Care Centre", abbr:"NEDUCC", type:"Urgent Care Centre", address:"13403 97 St NW, Edmonton, AB, T5E 4L8" },
    { name:"West Edmonton Urgent Care Centre", abbr:"WEUCC", type:"Urgent Care Centre", address:"1815 102 St NW, Edmonton, AB, T6J 4S5" },
    { name:"Northeast Edmonton Urgent Care Centre", abbr:"NEEUCC", type:"Urgent Care Centre", address:"7911 137 Ave NW, Edmonton, AB, T5C 0K9" },
    { name:"Red Deer Urgent Care Centre", abbr:"RDUCC", type:"Urgent Care Centre", address:"3942 50A Ave, Red Deer, AB, T4N 4E7" },
    { name:"Medicine Hat Urgent Care Centre", abbr:"MHUCC", type:"Urgent Care Centre", address:"666 5 St SW, Medicine Hat, AB, T1A 4H6" },
    { name:"Grande Prairie Urgent Care Centre", abbr:"GPUCC", type:"Urgent Care Centre", address:"11205 110 St, Grande Prairie, AB, T8V 4B1" },
    { name:"Lethbridge Urgent Care Centre", abbr:"LHUCC", type:"Urgent Care Centre", address:"960 19 St S, Lethbridge, AB, T1J 1W5" },
    { name:"Cochrane Urgent Care Centre", abbr:"CUCC", type:"Urgent Care Centre", address:"60 Grande Blvd, Cochrane, AB, T4C 0S4" }
  ];

  const facilityInput = document.getElementById("nearest_hospital");
  const facilityList  = document.getElementById("facilityList");
  const phoneInput    = document.getElementById("hospital_phone");
  const erTextarea    = document.getElementById("emergency_procedures");

  function normalizeFacilityKey(s) {
    return (s || "").toString().trim().toLowerCase().replace(/\s+/g, " ");
  }

  function fillFacilityDatalist() {
    if (!facilityList) return;
    facilityList.innerHTML = "";
    MEDICAL_FACILITIES.forEach(f => {
      const optName = document.createElement("option");
      optName.value = f.name;
      optName.label = `${f.abbr} – ${f.type}`;
      facilityList.appendChild(optName);

      const optAbbr = document.createElement("option");
      optAbbr.value = f.abbr;
      optAbbr.label = f.name;
      facilityList.appendChild(optAbbr);
    });
  }
  fillFacilityDatalist();

  function findFacility(query) {
    const q = normalizeFacilityKey(query);
    if (!q) return null;

    let f = MEDICAL_FACILITIES.find(x => normalizeFacilityKey(x.abbr) === q);
    if (f) return f;

    f = MEDICAL_FACILITIES.find(x => normalizeFacilityKey(x.name) === q);
    if (f) return f;

    if (q.length >= 3) {
      f = MEDICAL_FACILITIES.find(x => normalizeFacilityKey(x.name).startsWith(q));
      if (f) return f;
    }

    return null;
  }

  function setEmergencyAutofill(facility) {
    if (!facility) return;
    const current = normalizeFacilityKey(facilityInput.value);
    if (current === normalizeFacilityKey(facility.abbr)) facilityInput.value = facility.name;

    phoneInput.value = "911";
    erTextarea.value =
      `Ensure your safety and move to a secure area. Call 911 for emergencies and, if needed, go to ${facility.name}, ${facility.address} for medical attention. Report the incident to your supervisor as soon as it’s safe and complete an incident report.`;
  }

  function clearEmergencyAutofill() {
    if (phoneInput) phoneInput.value = "";
    if (erTextarea) erTextarea.value = "";
  }

  if (facilityInput) {
    const handler = () => {
      const val = (facilityInput.value || "").trim();
      if (!val) { clearEmergencyAutofill(); return; }
      const match = findFacility(val);
      if (match) setEmergencyAutofill(match);
    };

    facilityInput.addEventListener("input", handler);
    facilityInput.addEventListener("change", handler);
    facilityInput.addEventListener("blur", handler);

    facilityInput.addEventListener("input", () => {
      if (!facilityInput.value.trim()) clearEmergencyAutofill();
    });
  }

  // ============================================================
  // HAZARD LIBRARY (OFFLINE, SELF-CONTAINED)
  // - Each entry has: name, keywords (string or array), risk{F,S,P,R}, controls[2]
  // - Controls are clipped to keep export tidy
  // ============================================================

  const HAZARD_LIBRARY = [
    {
     "name": "Vehicle and driving exposure (commuting, moving between sites)",
    "keywords": "H01_commute_collision,H01_site_to_site_driving,H01_fleet_travel,H01_winter_road_risk,H01_intersection_incident,H01_highway_merge,H01_backing_in_parking,H01_distracted_commute",
    "risk": { "F": 4, "S": 5, "P": 3, "R": 60 },
    "controls": [
      "Use a journey management approach: plan route, check road and weather conditions, allow extra time, and stop if conditions deteriorate.",
      "Drive defensively: seatbelts 100%, no phone use while driving, manage fatigue with breaks and rotation, and complete pre trip checks."
    ]
  },
  {
    "name": "Working near moving equipment (excavators, loaders, graders, trucks)",
    "keywords": "H02_heavy_equipment_zone,H02_swing_radius_control,H02_spotter_required,H02_equipment_blindside,H02_backing_alarm_area,H02_haul_route_crossing,H02_exclusion_perimeter,H02_operator_eye_contact",
    "risk": { "F": 4, "S": 4, "P": 3, "R": 48 },
    "controls": [
      "Establish exclusion zones, maintain eye contact with operators, and get acknowledgement before entering equipment areas.",
      "Use high vis, a spotter and clear hand signals when required, stay out of swing radius and haul routes."
    ]
  },
  {
    "name": "Slips, trips, falls (uneven ground, cords, debris, curbs, ice)",
    "keywords": "H03_stf_uneven_grade,H03_ice_patch_trip,H03_curb_edge_fall,H03_debris_littered_path,H03_cord_tripline,H03_mud_slick_surface,H03_gravel_rollankle,H03_hidden_hole_step",
    "risk": { "F": 5, "S": 3, "P": 3, "R": 45 },
    "controls": [
      "Do a quick walk through of travel paths, identify hazards like ice, holes and debris, keep the work area tidy and manage cords.",
      "Use appropriate footwear and traction aids as needed, slow down and maintain stable footing on uneven surfaces."
    ]
  },
  {
    "name": "Weather exposure (heat, cold, wind, rain, snow)",
    "keywords": "H04_cold_stress_exposure,H04_heat_stress_exposure,H04_wind_gust_instability,H04_freezing_rain_risk,H04_blizzard_conditions,H04_wet_clothing_chill,H04_temperature_swing,H04_weather_monitoring",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 36 },
    "controls": [
      "Monitor conditions and follow weather work rest plans, layering, warm up breaks, shade and hydration appropriate to the day.",
      "Secure equipment for wind, use rain and cold gear, and stop work when conditions make safe work impractical."
    ]
  },
  {
    "name": "Thunder and lightning exposure (open areas, metal equipment, high points)",
    "keywords": "H05_thunderstorm_cell,H05_lightning_strike_risk,H05_open_field_exposure,H05_metal_tripod_concern,H05_gnss_pole_conductor,H05_ridge_line_highpoint,H05_shelter_protocol,H05_storm_standdown",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Stop work early for storms, move to a hard top vehicle or building and wait until the storm passes before resuming.",
      "Get off high points and away from isolated trees, metal poles and tripods and open fields when thunder is heard."
    ]
  },
  {
    "name": "Poor visibility (darkness, fog, snow, dust, glare)",
    "keywords": "H06_low_light_work,H06_fog_bank_visibility,H06_whiteout_condition,H06_blowing_dust_plume,H06_sun_glare_angle,H06_headlamp_dependency,H06_reflective_apparel,H06_vehicle_be_seen",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Increase visibility with high vis and reflectives, headlamps or area lighting and position vehicles to improve sightlines.",
      "Slow down, add spotters or traffic controls, and stop work if safe sightlines cannot be maintained."
    ]
  },
  {
    "name": "Fatigue (long days, early starts, repetitive driving)",
    "keywords": "H07_drowsy_operator,H07_long_shift_load,H07_early_start_cycle,H07_microsleep_risk,H07_extended_drive_time,H07_cognitive_lapse,H07_break_schedule,H07_shift_rotation",
    "risk": { "F": 4, "S": 4, "P": 3, "R": 48 },
    "controls": [
      "Plan staffing and breaks to prevent fatigue, rotate drivers on long trips and schedule rest periods.",
      "Use fit for duty checks and Stop Work Authority when fatigue signs appear, do not push through drowsiness."
    ]
  },
  {
    "name": "Manual handling and ergonomic strain (tripods, rods, batteries, cases)",
    "keywords": "H08_tripod_carry_strain,H08_rod_transport_overuse,H08_battery_case_lift,H08_twist_reach_posture,H08_repetitive_setups,H08_long_walk_load,H08_shoulder_overhead,H08_two_person_lift",
    "risk": { "F": 5, "S": 3, "P": 3, "R": 45 },
    "controls": [
      "Use safe lifting techniques and team lifts for heavy or awkward items, keep loads close and avoid twisting while lifting.",
      "Reduce carrying distance and weight by staging equipment, and alternate tasks to limit repetitive strain."
    ]
  },
  {
    "name": "Hand and power tools (hammers, picks, drills, saws when used)",
    "keywords": "H09_hammering_flying_chip,H09_drill_bit_break,H09_grinder_spark_zone,H09_kickback_event,H09_tool_vibration,H09_cutting_edge_contact,H09_handtool_slip,H09_guarding_required",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Inspect tools before use and use the right tool for the job, with guards in place and safe work practices followed.",
      "Wear task appropriate PPE including eye and hand protection, and maintain safe body positioning while operating tools."
    ]
  },
  {
    "name": "Pinch points and sharp edges (equipment cases, stakes, rebar, fencing)",
    "keywords": "H10_pinch_case_lid,H10_rebar_end_puncture,H10_stake_splinter_cut,H10_barbedwire_snag,H10_crush_finger_point,H10_sharp_fence_edge,H10_cut_resistant_glove,H10_safe_hand_placement",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 36 },
    "controls": [
      "Wear gloves suited to the task and keep hands clear of pinch points when handling cases, clamps and tripods.",
      "Control sharp hazards by avoiding climbing fences, maintaining spacing from barbed wire, and flagging or capping exposed rebar when possible."
    ]
  },
  {
    "name": "Noise (construction zones, traffic, equipment)",
    "keywords": "H11_backup_alarm_noise,H11_traffic_roar_exposure,H11_jackhammer_proximity,H11_compactor_vibration_sound,H11_hearing_damage_risk,H11_tinnitus_prevention,H11_noise_zone_posting,H11_hearing_protection_use",
    "risk": { "F": 4, "S": 2, "P": 3, "R": 24 },
    "controls": [
      "Wear hearing protection when noise levels are high and limit time in high noise areas when possible.",
      "Increase distance from the loudest operations and coordinate with the site to reduce exposure."
    ]
  },
  {
    "name": "Dust and airborne particulates (construction dust, road dust, silica risk)",
    "keywords": "H12_respirable_dust_load,H12_silica_exposure_path,H12_road_dust_cloud,H12_construction_particulate,H12_grinding_cutting_dust,H12_smoke_like_haze,H12_respirator_selection,H12_air_monitor_awareness",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Increase distance from dust generating tasks, coordinate timing, and use dust suppression where feasible.",
      "Use appropriate respiratory protection when conditions warrant and practice good hygiene before eating or drinking."
    ]
  },
  {
    "name": "Eye injuries (flying debris, brush, windblown dust)",
    "keywords": "H13_windblown_grit_eye,H13_branch_whip_strike,H13_flying_debris_contact,H13_stake_chip_splash,H13_eye_irritant_dust,H13_goggle_requirement,H13_eye_wash_access,H13_face_shield_task",
    "risk": { "F": 3, "S": 2, "P": 3, "R": 18 },
    "controls": [
      "Wear safety glasses or goggles in brushy, windy or dusty conditions and when hammering or using tools.",
      "Keep eyewash supplies available and flush immediately if debris or irritation occurs, stop work until vision is clear."
    ]
  },
  {
    "name": "Sun/UV exposure (snow glare, summer UV)",
    "keywords": "H14_uv_index_peak,H14_snow_glare_reflect,H14_sunburn_risk_cycle,H14_heat_sun_combo,H14_spf_reapply_plan,H14_brim_hat_use,H14_sunglasses_polarized,H14_skin_protection_shift",
    "risk": { "F": 4, "S": 2, "P": 3, "R": 24 },
    "controls": [
      "Use sun protection including sunscreen, brimmed hat, UV rated eyewear, long sleeves and schedule shade breaks.",
      "Hydrate and monitor for heat illness, adjust duties and take additional breaks during peak UV and heat."
    ]
  },
  {
    "name": "Communication failures (poor cell service, radio issues, missed check-ins)",
    "keywords": "H15_dead_zone_contact,H15_radio_dropout,H15_missed_checkin_timer,H15_no_signal_escalation,H15_sat_messenger_option,H15_emergency_call_plan,H15_contact_tree,H15_location_share_method",
    "risk": { "F": 3, "S": 4, "P": 2, "R": 24 },
    "controls": [
      "Use a check in and check out procedure with set intervals and escalation steps if a check in is missed.",
      "Carry appropriate communications for the area, ensure devices are charged and share exact work location details."
    ]
  },
  {
    "name": "Working alone / limited supervision (lone worker risk)",
    "keywords": "H16_lone_worker_status,H16_isolated_tasking,H16_no_spotter_present,H16_delayed_firstaid,H16_buddy_system_trigger,H16_solo_site_entry,H16_lonework_protocol,H16_emergency_self_rescue",
    "risk": { "F": 3, "S": 4, "P": 2, "R": 24 },
    "controls": [
      "Follow a lone worker plan including scheduled check ins, clear task limits and escalation procedures.",
      "When risk is elevated require a two person crew or spotter and confirm first aid and emergency access before starting."
    ]
  },
  {
    "name": "General public exposure (pedestrians, bystanders, curious onlookers)",
    "keywords": "H17_bystander_intrusion,H17_public_proximity_zone,H17_kids_nearby_awareness,H17_crowd_flow_conflict,H17_public_touch_equipment,H17_unplanned_interactions,H17_site_signage,H17_barrier_setup",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 36 },
    "controls": [
      "Set up a controlled work area using cones, flags or signage and position equipment to reduce public access and interference.",
      "Pause work if the public enters the hazard zone, communicate clearly and move to a safer location if needed."
    ]
  },
  {
    "name": "Landowners / homeowners interactions (access permission, conflict, dogs, private property hazards)",
    "keywords": "H18_landowner_permission,H18_homeowner_access_issue,H18_private_property_entry,H18_gate_lock_encounter,H18_resident_complaint,H18_right_of_entry,H18_property_dispute,H18_yard_hazard_unknown",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Confirm access and permission before entering private property, carry identification and follow right of entry practices.",
      "If conflict arises disengage, move to a safe area, notify supervision and do not escalate on site."
    ]
  },
  {
    "name": "Mental stress, time pressure, difficult interactions",
    "keywords": "H19_deadline_pressure,H19_rushed_decisions,H19_verbal_abuse_stressor,H19_confrontation_stress,H19_cognitive_overload,H19_focus_loss,H19_break_reset,H19_support_chain",
    "risk": { "F": 4, "S": 2, "P": 3, "R": 24 },
    "controls": [
      "Plan realistic timelines, pause when rushed and use brief reset breaks to reduce errors and stress escalation.",
      "Use support channels, call a supervisor when interactions become difficult and document incidents for follow up."
    ]
  },

  {
    "name": "Traffic exposure (high-speed roads, intersections, turning vehicles)",
    "keywords": "H20_intersection_turning_risk,H20_highspeed_corridor,H20_lane_closure_setup,H20_shoulder_workflow,H20_cone_taper_layout,H20_flagging_need,H20_buffer_vehicle_use,H20_escape_route_plan",
    "risk": { "F": 4, "S": 5, "P": 3, "R": 60 },
    "controls": [
      "Use a traffic control approach appropriate to the location including cones, signage, safe positioning and an escape route.",
      "Maximize visibility and separation with high vis, a buffer vehicle where appropriate, and avoid standing in live lanes."
    ]
  },
  {
    "name": "Distracted drivers (phones, construction confusion)",
    "keywords": "H21_texting_driver,H21_rubberneck_slowdown,H21_unexpected_lane_change,H21_confused_detour_route,H21_aggressive_merge,H21_sudden_stop_event,H21_phone_glow_night,H21_driver_inattention",
    "risk": { "F": 4, "S": 5, "P": 3, "R": 60 },
    "controls": [
      "Assume drivers may not see you, increase spacing and use additional warning devices, avoid working at the edge of live traffic.",
      "Use a spotter or traffic watch when needed and stop work if traffic behavior becomes unpredictable or unsafe."
    ]
  },
  {
    "name": "Working near cyclists, e-scooters, pedestrians (active transportation)",
    "keywords": "H22_cycle_lane_conflict,H22_escooter_fast_pass,H22_sidewalk_user_flow,H22_pathway_crossing,H22_schoolzone_active,H22_jogger_surprise,H22_stroller_space,H22_trail_intersection",
    "risk": { "F": 4, "S": 4, "P": 3, "R": 48 },
    "controls": [
      "Keep tripods and rods out of travel paths and set visible boundaries using cones or markers when working near pathways.",
      "Use a spotter or reposition work to lower traffic times and pause work when users pass through the area."
    ]
  },
  {
    "name": "Backing and blind spots (delivery trucks, equipment, alleys)",
    "keywords": "H23_alley_backing_zone,H23_delivery_truck_blind,H23_tight_access_point,H23_backover_nearmiss,H23_mirror_gap_risk,H23_reverse_alarm_limit,H23_spotter_hand_signals,H23_loading_dock_area",
    "risk": { "F": 4, "S": 4, "P": 3, "R": 48 },
    "controls": [
      "Avoid standing behind vehicles, identify backing routes and establish a safe position before work begins.",
      "Use a spotter in tight areas and move immediately if a vehicle begins reversing toward your work zone."
    ]
  },
  {
    "name": "Parkades and confined areas (low clearance, poor lighting, exhaust/CO potential)",
    "keywords": "H24_parkade_lowclear,H24_confined_ramp_turn,H24_poor_lighting_zone,H24_exhaust_buildup,H24_CO_alarm_need,H24_ventilation_limit,H24_echo_noise_confusion,H24_tight_ped_mix",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Confirm clearance and lighting before entry, use additional lighting and proceed slowly in tight spaces.",
      "Limit exhaust exposure by avoiding idling near the work area and leave immediately if ventilation is poor or symptoms occur."
    ]
  },
  {
    "name": "Utilities and excavations (open holes, trench edges, vaults, manholes)",
    "keywords": "H25_open_hole_edge,H25_trench_collapse_margin,H25_vault_lid_shift,H25_manhole_adjacent,H25_underground_services,H25_locate_marks_present,H25_excavation_perimeter,H25_fall_protection_need",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Maintain safe distance from trench edges and open holes, use barriers and never enter excavations without authorization and controls.",
      "Coordinate with site supervision and confirm locates before disturbing ground, follow the prime contractor excavation safety requirements."
    ]
  },
  {
    "name": "Struck-by hazards from construction activity (falling materials, swing radius)",
    "keywords": "H26_overhead_work_zone,H26_dropped_object_risk,H26_suspended_load_path,H26_crane_lift_area,H26_material_stack_fall,H26_tool_drop_exposure,H26_hardhat_mandatory,H26_exclusion_under_load",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Stay out of drop zones and under suspended loads, obey barricades and wear hard hat where required.",
      "Coordinate timing with crews to avoid overhead work areas and maintain a safe buffer zone."
    ]
  },
  {
    "name": "Public conflict / harassment (angry residents, businesses, trespass disputes)",
    "keywords": "H27_aggressive_resident,H27_business_owner_conflict,H27_trespass_accusation,H27_threatening_language,H27_deescalation_required,H27_safe_withdrawal,H27_supervisor_call,H27_incident_documentation",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Use de escalation, remain calm, do not argue, explain purpose briefly and disengage if escalation occurs.",
      "Move to a safe location, contact a supervisor and document the interaction, request support before returning."
    ]
  },
  {
    "name": "Dogs in yards / residential areas",
    "keywords": "H28_dog_bite_risk,H28_offleash_encounter,H28_yard_gate_entry,H28_barking_warning,H28_animal_charge,H28_owner_not_present,H28_safe_retreat,H28_dog_deterrent_plan",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Assess for dogs before entry and do not enter yards with uncontrolled animals, request homeowner to secure pets.",
      "Maintain distance and a clear exit route, retreat to the vehicle if threatened."
    ]
  },
  {
    "name": "Needlestick / sharps exposure (alleys, parks, encampment areas)",
    "keywords": "H29_syringe_on_ground,H29_sharps_in_grass,H29_encampment_debris,H29_alley_cleanup_risk,H29_puncture_injury,H29_tongs_pickup_only,H29_sharps_container_use,H29_report_exposure",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 16 },
    "controls": [
      "Do not handle sharps directly, use tongs and a sharps container or leave in place and report as per procedure.",
      "Wear appropriate PPE and scan the ground before kneeling or reaching, follow exposure response steps immediately if an incident occurs."
    ]
  },
  {
    "name": "Biohazards (human waste, contaminated surfaces, discarded PPE)",
    "keywords": "H30_human_waste_contact,H30_bloodborne_risk,H30_contaminated_surface,H30_discarded_PPE_litter,H30_infection_pathway,H30_hand_hygiene_critical,H30_disinfect_after_work,H30_glove_use_required",
    "risk": { "F": 2, "S": 3, "P": 2, "R": 12 },
    "controls": [
      "Avoid contact, use gloves and hand hygiene, disinfect tools and equipment after exposure risk areas.",
      "Relocate if contamination is significant, do not eat or drink in contaminated zones and follow exposure procedures."
    ]
  },
  {
    "name": "Overhead hazards (powerlines, scaffolding, cranes)",
    "keywords": "H31_overhead_powerline_clear,H31_service_drop_low,H31_scaffold_overhang,H31_crane_boom_sweep,H31_overhead_obstruction,H31_electrocution_clearance,H31_look_up_check,H31_no_raise_pole_near",
    "risk": { "F": 3, "S": 5, "P": 2, "R": 30 },
    "controls": [
      "Identify overhead hazards before raising poles and maintain safe clearance from energized lines and overhead structures.",
      "If clearance is uncertain stop and reposition, contact supervision or the utility owner as required."
    ]
  },
  {
    "name": "Rail/LRT/industrial spur exposure (where applicable)",
    "keywords": "H32_rail_rightofway,H32_crossing_signal_zone,H32_track_trip_hazard,H32_train_approach_risk,H32_lrt_platform_edge,H32_industrial_spur_access,H32_no_trespass_rule,H32_hearing_train_warning",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Follow rail right of way rules and only access with authorization and required controls where applicable.",
      "Stay alert and keep clear of tracks, obey signals and maintain safe distance from moving rail equipment."
    ]
  },
  {
    "name": "Property hazards (barbed wire, broken glass, hidden holes, sprinkler boxes)",
    "keywords": "H33_broken_glass_yard,H33_sprinkler_box_trip,H33_hidden_landscape_hole,H33_fenceline_barbedwire,H33_nails_scrap_metal,H33_culvert_edge_drop,H33_sharp_debris_path,H33_private_yard_obstacles",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 36 },
    "controls": [
      "Scan and choose safe walking routes and avoid debris areas, wear appropriate footwear and gloves.",
      "If hazards are extensive re route the work, notify the team and supervisor, and flag hazards for awareness."
    ]
  },

  {
    "name": "Highway driving and shoulder work (high speeds, narrow shoulders)",
    "keywords": "H34_narrow_shoulder_exposure,H34_highspeed_passby,H34_semi_windblast,H34_gravel_shoulder_slide,H34_pullout_positioning,H34_rumble_strip_edge,H34_roadside_escape,H34_conspicuity_highway",
    "risk": { "F": 4, "S": 5, "P": 3, "R": 60 },
    "controls": [
      "Use a roadside work setup, park safely, keep equipment off the live lane and maintain an escape path.",
      "Increase visibility and separation with high vis and warning devices, avoid roadside work when conditions are unsafe."
    ]
  },
  {
    "name": "Wildlife encounters (moose, deer, bears, cougars, coyotes)",
    "keywords": "H35_moose_encounter,H35_bear_presence,H35_cougar_sign,H35_coyote_pack,H35_wildlife_tracks,H35_dawn_dusk_risk,H35_bear_spray_ready,H35_back_away_protocol",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Stay alert for wildlife signs and carry deterrents where appropriate for the area and task.",
      "If wildlife is observed retreat to the vehicle, do not approach and change the work plan or location."
    ]
  },
  {
    "name": "Livestock and farm hazards (bulls, aggressive animals, electric fences)",
    "keywords": "H36_bull_in_pasture,H36_electric_fence_contact,H36_herd_behavior,H36_gate_handling,H36_trample_risk,H36_ranch_access,H36_animal_aggression,H36_farmyard_movement",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 16 },
    "controls": [
      "Confirm with the landowner where livestock are located and avoid entering active pastures without guidance.",
      "Keep distance, use gates properly and retreat to a safe area if animals approach or become agitated."
    ]
  },
  {
    "name": "Remote work risks (delayed emergency response, no cell service)",
    "keywords": "H37_remote_response_delay,H37_no_service_area,H37_long_distance_help,H37_solo_remote_task,H37_satellite_checkin,H37_emergency_coordinates,H37_vehicle_as_shelter,H37_trip_plan_required",
    "risk": { "F": 3, "S": 4, "P": 2, "R": 24 },
    "controls": [
      "Share route, expected return time and exact location details with scheduled check ins and escalation steps.",
      "Carry emergency supplies and communications appropriate to remoteness, stop work if comms or conditions become unacceptable."
    ]
  },
  {
    "name": "Terrain hazards (steep slopes, loose rock, muskeg, coulees, riverbanks)",
    "keywords": "H38_steep_slope_slide,H38_loose_rock_roll,H38_muskeg_sink,H38_coulee_edge,H38_erosion_bank,H38_washout_crossing,H38_ankle_roll_zone,H38_unstable_ground_probe",
    "risk": { "F": 4, "S": 3, "P": 3, "R": 36 },
    "controls": [
      "Assess terrain before entry, avoid edges and unstable ground and choose safer routes even if longer.",
      "Use appropriate footwear and work in pairs in high risk terrain areas, stop if footing becomes unsafe."
    ]
  },
  {
    "name": "Water hazards (creeks, irrigation canals, ice, fast flow)",
    "keywords": "H39_irrigation_canal_edge,H39_fast_flow_crossing,H39_slippery_bank,H39_thin_ice_breakthrough,H39_cold_water_immersion,H39_wader_risk,H39_drowning_hazard,H39_no_crossing_rule",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Avoid unnecessary crossings and keep a safe distance from water edges, do not travel on unknown ice.",
      "Use a buddy approach near water, plan alternate access points and stop work if conditions are unsafe."
    ]
  },
  {
    "name": "ATVs/UTVs/snowmobiles (if used: rollover, ejection, visibility)",
    "keywords": "H40_ATV_rollover,H40_UTV_ejection,H40_snowmobile_whiteout,H40_trail_obstacle,H40_helmet_required,H40_speed_control,H40_recovery_strap_use,H40_machine_visibility_flag",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 16 },
    "controls": [
      "Operate only if trained and authorized, wear required PPE and follow speed and terrain limits.",
      "Use visibility flags or lights and ride with a buddy when possible, avoid steep slopes and water edges."
    ]
  },
  {
    "name": "Getting stuck / stranded (mud, snow, poor roads)",
    "keywords": "H41_vehicle_stuck_mud,H41_snow_drift_strand,H41_poor_road_access,H41_breakdown_no_help,H41_winch_recovery,H41_tow_plan,H41_winter_kit_ready,H41_fuel_range_check",
    "risk": { "F": 3, "S": 4, "P": 2, "R": 24 },
    "controls": [
      "Check access conditions, avoid questionable roads and carry recovery gear and seasonal emergency supplies.",
      "Maintain fuel and vehicle readiness, communicate location and return time and turn around early if conditions worsen."
    ]
  },
  {
    "name": "Extreme cold exposure (frostbite, hypothermia), wind chill",
    "keywords": "H42_frostbite_warning,H42_hypothermia_risk,H42_windchill_factor,H42_numbness_signs,H42_warmup_breaks,H42_insulated_PPE,H42_wet_clothes_freeze,H42_heater_shelter",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Use layered clothing, dry spares and warm up breaks, monitor for frostbite and hypothermia signs.",
      "Limit exposure time and stop work if cold stress symptoms develop."
    ]
  },
  {
    "name": "Extreme heat exposure (heat stress, dehydration)",
    "keywords": "H43_heat_exhaustion,H43_heat_stroke,H43_dehydration_risk,H43_electrolyte_plan,H43_shade_rotation,H43_midday_peak_heat,H43_cooling_breaks,H43_cramp_warning",
    "risk": { "F": 3, "S": 4, "P": 3, "R": 36 },
    "controls": [
      "Follow a heat plan with hydration and electrolytes, shaded breaks and adjust work during peak heat.",
      "Watch for heat illness symptoms, buddy check and stop work and cool down immediately if symptoms appear."
    ]
  },
  {
    "name": "Wildfire smoke and poor air quality",
    "keywords": "H44_smoke_haze_exposure,H44_AQHI_alert,H44_respiratory_irritation,H44_visibility_smoke,H44_ash_fall,H44_mask_fit_smoke,H44_limit_exertion,H44_relocate_work_area",
    "risk": { "F": 2, "S": 3, "P": 3, "R": 18 },
    "controls": [
      "Monitor AQHI and reduce exposure by limiting exertion and increasing breaks when smoke is present.",
      "Use respiratory protection when appropriate and relocate or stop work if air quality or visibility becomes unsafe."
    ]
  },
  {
    "name": "Hunting areas / firearms presence (seasonal, mistaken identity risk)",
    "keywords": "H45_hunting_season_zone,H45_blaze_orange_need,H45_crown_land_activity,H45_gunshot_nearby,H45_mistaken_identity,H45_high_vis_contrast,H45_avoid_active_area,H45_notify_landowner_hunt",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Plan work with seasonal awareness, wear highly visible colors where appropriate and avoid known active hunting areas.",
      "If hunters or gunfire are present leave the area and notify supervision or the landowner as needed."
    ]
  },
  {
    "name": "Agricultural equipment and chemicals (sprayers, combines, pesticides/fertilizers)",
    "keywords": "H46_combine_movement,H46_sprayer_drift,H46_pesticide_exposure,H46_fertilizer_contact,H46_PTO_entanglement,H46_farmyard_traffic,H46_chemical_label_check,H46_avoid_active_spraying",
    "risk": { "F": 2, "S": 4, "P": 2, "R": 16 },
    "controls": [
      "Stay clear of moving farm machinery and coordinate with operators and landowners before entering active work areas.",
      "Avoid areas being sprayed, watch wind direction and follow basic chemical exposure precautions including hygiene and PPE if required."
    ]
  },
  {
    "name": "Insects and bites (ticks, mosquitoes, wasps), allergic reactions",
    "keywords": "H47_tick_check_protocol,H47_wasp_nest_proximity,H47_mosquito_swarm,H47_bee_sting_anaphylaxis,H47_bug_repellent_use,H47_long_grass_exposure,H47_epipen_access,H47_bite_reporting",
    "risk": { "F": 3, "S": 3, "P": 3, "R": 27 },
    "controls": [
      "Use repellent and protective clothing, avoid nests and do tick checks after work in brush or long grass.",
      "Have a response plan for stings and bites including first aid supplies, allergy awareness and urgent medical response for severe reactions."
    ]
  },
  {
    "name": "Overhead powerlines in open areas (long spans, line-of-sight issues)",
    "keywords": "H48_transmission_span_sag,H48_poleline_over_field,H48_wire_visibility_issue,H48_clearance_estimation,H48_raise_pole_hazard,H48_open_area_lines,H48_stop_before_lift,H48_reposition_away_line",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Identify overhead lines early and maintain safe clearance before raising GNSS poles or tripods in open areas.",
      "If clearance cannot be confirmed relocate the setup and consult the utility or site contact before continuing."
    ]
  },
  {
    "name": "Oilfield/industrial sites (H2S potential, industrial traffic, restricted areas)",
    "keywords": "H49_H2S_potential,H49_lease_road_traffic,H49_industrial_gate_access,H49_muster_point_known,H49_site_orientation_required,H49_PPE_site_rules,H49_restricted_area_entry,H49_stop_work_if_alarm",
    "risk": { "F": 2, "S": 5, "P": 2, "R": 20 },
    "controls": [
      "Follow site requirements including sign in, orientation, PPE rules and knowing alarms and muster points before starting work.",
      "Maintain awareness of industrial traffic and stop work and leave if alarms, abnormal odors or unsafe conditions occur."
      ]
    }
    // Add the rest of your hazards here in the exact same structure.
  ];

  function clipControl(text, max = 185) {
    const t = (text || "").replace(/\s+/g, " ").trim();
    if (t.length <= max) return t;
    return t.slice(0, max - 1).trimEnd() + "…";
  }

  function normalize(text) {
    return (text || "")
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function stemToken(tok) {
    let t = tok;
    if (t.length <= 3) return t;
    if (t.endsWith("ies") && t.length > 4) t = t.slice(0, -3) + "y";
    else if (t.endsWith("es") && t.length > 4) t = t.slice(0, -2);
    else if (t.endsWith("s") && t.length > 3) t = t.slice(0, -1);
    if (t.endsWith("ing") && t.length > 5) t = t.slice(0, -3);
    return t;
  }

  function tokens(text) {
    const n = normalize(text);
    if (!n) return [];
    return n.split(" ").map(stemToken).filter(Boolean);
  }

  function hashString(str) {
    let h = 2166136261;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }

  function getKeywordsArray(entry) {
    if (!entry || entry.keywords == null) return [];
    if (Array.isArray(entry.keywords)) return entry.keywords.map(s => String(s));
    return String(entry.keywords)
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);
  }

  function scoreEntry(entry, hazardNorm, hazardTokens) {
  let score = 0;
  const hs = new Set(hazardTokens);
  const kws = getKeywordsArray(entry);

  let matchedTokens = 0;

  for (const k of kws) {
    const kn = normalize(k);
    if (!kn) continue;

    if (hazardNorm === kn) {
      score += 30;
      matchedTokens += 2;
      continue;
    }

    if (kn.includes(" ") && hazardNorm.includes(kn)) {
      score += 18;
      matchedTokens += 2;
      continue;
    }

    const ktoks = tokens(k);
    for (const t of ktoks) {
      if (hs.has(t)) {
        matchedTokens++;
        score += (ktoks.length === 1 ? 8 : 2);
      }
    }
  }

  for (const t of tokens(entry.name)) {
    if (hs.has(t)) {
      matchedTokens++;
      score += 2;
    }
  }

  if (matchedTokens >= 2) score += 4;
  if (matchedTokens >= 3) score += 6;

  return score;
}

function bestEntryForHazard(hazardText) {
  const hazardNorm = normalize(hazardText);
  if (!hazardNorm) return null;

  const htoks = tokens(hazardText);
  let best = null;
  let bestScore = 0;

  for (const entry of HAZARD_LIBRARY) {
    const s = scoreEntry(entry, hazardNorm, htoks);
    if (s > bestScore) { bestScore = s; best = entry; }
  }

  if (!best || bestScore < 8) return null;
  return best;
}

  function clearRow(row) {
    const f = document.querySelector(`input[name="f_${row}"]`);
    const s = document.querySelector(`input[name="s_${row}"]`);
    const p = document.querySelector(`input[name="p_${row}"]`);
    const r = document.querySelector(`input[name="r_${row}"]`);
    const c = document.querySelector(`textarea[name="control_${row}"]`);
    if (f) f.value = "";
    if (s) s.value = "";
    if (p) p.value = "";
    if (r) r.value = "";
    if (c) c.value = "";
  }

  function applyEntryToRow(entry, row, hazardText) {
    const controlField = document.querySelector(`textarea[name="control_${row}"]`);
    const fField = document.querySelector(`input[name="f_${row}"]`);
    const sField = document.querySelector(`input[name="s_${row}"]`);
    const pField = document.querySelector(`input[name="p_${row}"]`);

    const idx = (hashString(`${row}|${hazardText}|${entry.name}`) % 2);
    const chosen = clipControl((entry.controls && entry.controls[idx]) || "");

    if (controlField) {
      if (!controlField.value || controlField.value.trim().length < 15) controlField.value = chosen;
    }

    const rt = entry.ratings || (entry.risk ? { f: entry.risk.F, s: entry.risk.S, p: entry.risk.P } : null);
    if (rt) {
      if (fField && !fField.value && rt.f) fField.value = String(rt.f);
      if (sField && !sField.value && rt.s) sField.value = String(rt.s);
      if (pField && !pField.value && rt.p) pField.value = String(rt.p);
    }
    updateRiskForRow(row);
  }

  function initHazardAutoSuggest() {
    document.querySelectorAll('input[name^="hazard_"]').forEach(input => {
      input.addEventListener('blur', e => {
        const hazardText = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];

        if (!hazardText) { clearRow(row); return; }

        const entry = bestEntryForHazard(hazardText);
        if (!entry) { updateRiskForRow(row); return; }

        applyEntryToRow(entry, row, hazardText);
      });

      input.addEventListener('input', e => {
        const value = (e.target.value || "").trim();
        const row = e.target.name.split('_')[1];
        if (!value) clearRow(row);
      });
    });
  }

  initHazardAutoSuggest();

  // ============================================================
  // PDF EXPORT (LEGAL, FIXES TEXTAREA RENDERING)
  // ============================================================
  function copyFormValuesToClone(original, clone) {
    const origFields = original.querySelectorAll("input, textarea, select");
    origFields.forEach(orig => {
      const name = orig.getAttribute("name");
      const id = orig.getAttribute("id");

      let sel = null;
      if (id) sel = clone.querySelector(`#${CSS.escape(id)}`);
      if (!sel && name) sel = clone.querySelector(`[name="${CSS.escape(name)}"]`);
      if (!sel) return;

      if (orig.tagName.toLowerCase() === "textarea") {
        sel.value = orig.value;
        sel.textContent = orig.value;
      } else if (orig.type === "checkbox") {
        sel.checked = orig.checked;
        if (orig.checked) sel.setAttribute("checked", "checked");
        else sel.removeAttribute("checked");
      } else {
        sel.value = orig.value;
        sel.setAttribute("value", orig.value);
      }
    });

    ["pcSignature","saSignature","clientSignature"].forEach(cid => {
      const origCanvas = document.getElementById(cid);
      const cloneCanvas = clone.querySelector(`#${CSS.escape(cid)}`);
      if (!origCanvas || !cloneCanvas) return;

      const rect = cloneCanvas.getBoundingClientRect();
      cloneCanvas.width = Math.floor((rect.width || 300));
      cloneCanvas.height = Math.floor((rect.height || 80));
      const cctx = cloneCanvas.getContext("2d");
      const img = new Image();
      img.onload = () => {
        cctx.clearRect(0,0,cloneCanvas.width, cloneCanvas.height);
        cctx.drawImage(img, 0, 0, cloneCanvas.width, cloneCanvas.height);
      };
      img.src = origCanvas.toDataURL("image/png");
    });
  }

  function expandTextareasForExport(cloneRoot) {
    cloneRoot.querySelectorAll("textarea").forEach(t => {
      t.style.height = "auto";
      t.style.minHeight = "0";
      t.style.maxHeight = "none";
      t.style.overflow = "visible";
      t.textContent = t.value || t.textContent || "";
      t.style.height = (t.scrollHeight + 2) + "px";
    });
  }

  function createFilteredFormClone() {
    const form = document.getElementById('hazardForm');
    const clone = form.cloneNode(true);

    copyFormValuesToClone(form, clone);

    const commonTableBody = clone.querySelector('#commonHazardsTable tbody');
    if (commonTableBody) {
      Array.from(commonTableBody.rows).forEach(row => {
        const appliesCheckbox = row.querySelector('td:first-child input[type="checkbox"]');
        if (appliesCheckbox && !appliesCheckbox.checked) row.remove();
      });
      if (commonTableBody.rows.length === 0) {
        const tbl = clone.querySelector("#commonHazardsTable");
        if (tbl) tbl.remove();
      }
    }

    const clonedButtonRow = clone.querySelector('#buttonRow');
    if (clonedButtonRow) clonedButtonRow.style.display = 'none';

    const dl = clone.querySelector("#facilityList");
    if (dl) dl.remove();

    const stamp = document.getElementById("versionStamp");
    if (stamp) clone.appendChild(stamp.cloneNode(true));

    expandTextareasForExport(clone);
    return clone;
  }

  async function generatePdf() {
    if (!window.jspdf || !window.html2canvas) {
      alert("Missing PDF libraries. Ensure jspdf.umd.min.js and html2canvas.min.js are in the same folder as this HTML.");
      throw new Error("Missing libraries");
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'legal');

    const clone = createFilteredFormClone();

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.style.width = '1050px';
    tempContainer.style.background = '#ffffff';
    tempContainer.appendChild(clone);
    document.body.appendChild(tempContainer);

    await new Promise(r => setTimeout(r, 180));

    const clonePage1 = clone.querySelector('#page1');
    const clonePage2 = clone.querySelector('#page2');

    async function addPage(div, addNew) {
      if (!div) return;
      if (addNew) pdf.addPage();

      expandTextareasForExport(clone);

      const canvas = await html2canvas(div, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
        windowWidth: 1050
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 8;

      let imgW = pageWidth - margin * 2;
      let imgH = canvas.height * (imgW / canvas.width);

      if (imgH > pageHeight - margin * 2) {
        imgH = pageHeight - margin * 2;
        imgW = canvas.width * (imgH / canvas.height);
      }

      const x = (pageWidth - imgW) / 2;
      const y = margin;
      pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH);
    }

    await addPage(clonePage1, false);
    await addPage(clonePage2, true);

    document.body.removeChild(tempContainer);
    return pdf;
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        pdf.save(getFinalFileName());
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      try {
        if (buttonRow) buttonRow.style.display = 'none';
        const pdf = await generatePdf();
        const blob = pdf.output('blob');
        const fileName = getFinalFileName();
        const file = new File([blob], fileName, { type: 'application/pdf' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'Worksite Hazard Assessment',
            text: 'VistaGeomatics – Worksite Hazard Assessment PDF'
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
      } catch (e) {
        console.error('Share failed:', e);
      } finally {
        if (buttonRow) buttonRow.style.display = 'flex';
      }
    });
  }
</script>
</body>
</html>
