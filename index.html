<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VistaGeomatics – Worksite Hazard Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --vista-blue: #165f7d;
      --vista-blue-light: #2a7fa3;
      --vista-blue-dark: #0b3045;
      --bg-body: #eef3f9;
      --bg-card: #ffffff;
      --border-soft: #d6e2f0;
      --text-main: #101827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top, #f4f8fc 0, #e4edf6 40%, #dde6f3 100%);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    .page-wrap { max-width: 1050px; margin: 0 auto; }

    .container {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 14px 30px rgba(5, 41, 66, 0.18), 0 0 0 1px rgba(5, 41, 66, 0.04);
      overflow: hidden;
      position: relative;
      margin-bottom: 18px;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(22,95,125,0.16), transparent 55%);
      opacity: 0.9;
    }

    .header-bar {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: linear-gradient(120deg, var(--vista-blue-light) 0%, var(--vista-blue) 40%, var(--vista-blue-dark) 100%);
      color: #fff;
    }

    .header-left h1 {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .header-left p { margin: 2px 0 0; font-size: 0.8rem; opacity: 0.9; }
    .header-logo { height: 60px; filter: drop-shadow(0 5px 14px rgba(0,0,0,0.35)); }

    .page-title-bar {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 10px 20px 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.78), #f7faff);
    }

    .page-title-main {
      font-family: "Montserrat", sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--vista-blue-dark);
    }

    .page-title-sub { margin-top: 3px; font-size: 0.78rem; color: var(--text-muted); }

    .page-title-accent {
      width: 120px;
      height: 3px;
      margin: 8px auto 0;
      border-radius: 999px;
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      box-shadow: 0 0 8px rgba(46,167,224,0.65);
    }

    .page-body { position: relative; z-index: 1; padding: 10px 18px 14px; font-size: 0.8rem; }

    label {
      font-size: 0.78rem;
      font-weight: 600;
      display: block;
      margin-bottom: 2px;
      color: var(--text-main);
    }

    /* INPUT/TEXT CLIPPING FIX */
    input[type="text"],
    input[type="date"],
    input[type="time"],
    textarea,
    .small-input {
      width: 100%;
      font-family: "Inter", sans-serif;
      font-size: 0.74rem;
      line-height: 1.25;
      color: var(--text-main);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      transition: 0.15s;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    .small-input {
      height: 34px;
      padding: 6px 8px;
      vertical-align: middle;
      -webkit-appearance: none;
      appearance: none;
    }

    textarea { padding: 6px 8px; min-height: 56px; resize: vertical; }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--vista-blue-light);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(38,132,168,0.18);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .row > div { flex: 1; min-width: 150px; }

    .section-card {
      margin-top: 8px;
      padding: 8px 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, #fbfdff 0%, #f4f8fd 60%, #eff5fb 100%);
      box-shadow: 0 6px 16px rgba(5, 41, 66, 0.05);
      position: relative;
    }

    .section-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      border-radius: 12px 12px 0 0;
      background: linear-gradient(90deg, var(--vista-blue-light), var(--vista-blue-dark));
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 4px;
    }

    .section-title {
      font-weight: 600;
      font-size: 0.86rem;
      color: var(--vista-blue-dark);
      font-family: "Montserrat", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .section-note { font-size: 0.72rem; color: var(--text-muted); }

    .inline-checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.76rem;
    }

    .inline-checkbox-group label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      margin-bottom: 0;
    }

    input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--vista-blue);
      margin: 0;
    }

    .small-text { font-size: 0.74rem; color: var(--text-muted); }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    th, td {
      border: 1px solid var(--border-soft);
      padding: 3px 4px;
      vertical-align: top;
    }

    th { background: #e8f0fb; font-weight: 600; color: var(--vista-blue-dark); }
    td { background: #f9fbff; }
    .center { text-align: center; }

    .signature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .signature-box {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      padding: 6px;
      font-size: 0.78rem;
    }

    .signature-label {
      font-size: 0.74rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .signature-canvas {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
      display: block;
      cursor: crosshair;
    }

    .signature-actions { display: flex; justify-content: flex-end; margin-top: 4px; }
    .signature-actions button { padding: 3px 10px; font-size: 0.7rem; letter-spacing: 0.05em; }
    .signature-row { display: flex; gap: 6px; margin-top: 4px; }
    .signature-row > div { flex: 1; }

    .btn-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; margin-bottom: 4px; }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--vista-blue-light), var(--vista-blue), var(--vista-blue-dark));
      color: #fff;
      box-shadow: 0 8px 20px rgba(5, 41, 66, 0.35);
    }

    .btn-secondary { background: #f3f4f6; color: var(--text-main); border: 1px solid #d6d7dd; }
    button:hover { transform: translateY(-1px); box-shadow: 0 9px 22px rgba(15, 23, 42, 0.18); }

    .control-text {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      padding: 6px 8px;
      line-height: 1.25;
      font-size: 0.74rem;
    }

    .risk-input,
    .risk-output {
      height: 32px !important;
      padding: 5px 6px !important;
      line-height: 1.2 !important;
      font-size: 0.74rem !important;
      text-align: center;
    }

    /* EXPORT: replace textarea with div so html2canvas always captures content */
    .print-textarea {
      width: 100%;
      min-height: 56px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #f9fbff;
      font-family: "Inter", sans-serif;
      font-size: 0.74rem;
      line-height: 1.25;
      color: var(--text-main);
      white-space: pre-wrap;
      word-break: break-word;
    }

    @media (max-width: 700px) {
      .header-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
      .page-title-main { font-size: 1.05rem; letter-spacing: 0.12em; }
    }
  </style>
</head>

<body>
<div class="page-wrap">
  <form id="hazardForm">

    <!-- PAGE 1 -->
    <div class="container" id="page1">
      <div class="header-bar">
        <div class="header-left">
          <h1>VISTAGEOMATICS</h1>
          <p>Worksite Hazard Assessment &amp; Tailgate Report</p>
        </div>
        <img src="vista-geomatics.png" alt="VistaGeomatics Logo" class="header-logo">
      </div>

      <div class="page-title-bar">
        <div class="page-title-main">Worksite Hazard Assessment</div>
        <div class="page-title-sub">Identify hazards and controls prior to commencing work.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">

        <!-- General information -->
        <div class="section-card">
          <div class="section-header"><div class="section-title">General Information</div></div>
          <div class="row">
            <div><label for="developed_by">Developed By</label><input type="text" id="developed_by" name="developed_by"></div>
            <div><label for="location">Location</label><input type="text" id="location" name="location"></div>
          </div>
          <div class="row">
            <div><label for="date">Date</label><input type="date" id="date" name="date"></div>
            <div><label for="start_time">Start Time</label><input type="time" id="start_time" name="start_time"></div>
            <div><label for="completion_time">Form Completion Time</label><input type="time" id="completion_time" name="completion_time"></div>
          </div>
          <div class="row">
            <div><label for="job_number">Job Number</label><input type="text" id="job_number" name="job_number"></div>
            <div><label for="description">Description of Work</label><input type="text" id="description" name="description"></div>
          </div>
        </div>

        <!-- Tailgate meeting -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Tailgate Meeting Report</div>
            <div class="section-note">Complete daily prior to starting work and when procedures change or new hazards are present.</div>
          </div>
          <div style="margin-bottom:4px;">
            <label for="tailgate_minutes">Tailgate Minutes</label>
            <textarea id="tailgate_minutes" name="tailgate_minutes"></textarea>
          </div>

          <div class="row">
            <div style="flex:1;">
              <label>Site Sidewalk and Fencing Condition Report</label>
              <div class="inline-checkbox-group">
                <span>Did you drive on the sidewalk?</span>
                <label><input type="checkbox" name="sidewalk_yes"> Yes</label>
                <label><input type="checkbox" name="sidewalk_no"> No</label>
                <span>Fences Installed?</span>
                <label><input type="checkbox" name="fences_yes"> Yes</label>
                <label><input type="checkbox" name="fences_no"> No</label>
              </div>
            </div>
          </div>

          <div style="margin-top:4px;">
            <label for="sidewalk_comments">Comments</label>
            <textarea id="sidewalk_comments" name="sidewalk_comments"></textarea>
          </div>

          <div style="margin-top:4px;">
            <label>Pictures Taken:</label>
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="pic_site"> Site</label>
              <label><input type="checkbox" name="pic_sidewalk"> Sidewalk</label>
              <label><input type="checkbox" name="pic_fences"> Fences</label>
              <label><input type="checkbox" name="pic_hazards"> Hazards</label>
              <label>
                <input type="checkbox" name="pic_other"> Other (Describe):
                <input type="text" name="pic_other_desc" style="width:160px;">
              </label>
            </div>
          </div>
        </div>

        <!-- Working Alone -->
        <div class="section-card">
          <div class="section-header"><div class="section-title">Working Alone &amp; Check-in</div></div>

          <div class="row">
            <div style="flex:1 1 35%;">
              <label>Working Alone</label>
              <div class="inline-checkbox-group">
                <label><input type="checkbox" name="working_alone_yes"> Yes</label>
                <label><input type="checkbox" name="working_alone_no"> No</label>
              </div>
            </div>
            <div style="flex:1 1 30%;">
              <label for="check_in_interval">Check-in Interval</label>
              <input type="text" id="check_in_interval" name="check_in_interval" placeholder="e.g., Hourly, Every 2 hours">
            </div>
            <div style="flex:1 1 30%;">
              <label for="communication_method">Communication Method</label>
              <input type="text" id="communication_method" name="communication_method" placeholder="e.g., Phone, Radio">
            </div>
          </div>

          <div class="row">
            <div style="flex:1 1 40%;">
              <label for="working_supervisor_name">Contact Procedures – Call Supervisor: Name</label>
              <input type="text" id="working_supervisor_name" name="working_supervisor_name">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_in_time">Check-in Time</label>
              <input type="time" id="check_in_time" name="check_in_time">
            </div>
            <div style="flex:1 1 25%;">
              <label for="check_out_time">Check-out Time</label>
              <input type="time" id="check_out_time" name="check_out_time">
            </div>
          </div>

          <div class="small-text" style="margin-top:4px;">
            <strong>Note:</strong> High risk: hourly, Medium risk: every 2 hours, Low risk: start and end of shift.
          </div>
        </div>

        <!-- Daily Equipment Inspection -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Daily Equipment Inspection</div>
            <div class="section-note">Check your vehicle, ATV, snowmobile, generator, trailer, and/or chainsaw and report deficiencies.</div>
          </div>

          <table>
            <thead><tr><th>Equipment</th><th>Inspection Items</th></tr></thead>
            <tbody>
              <tr>
                <td>Vehicle</td>
                <td>
                  <div class="inline-checkbox-group">
                    <label><input type="checkbox" name="veh_tires"> Tires</label>
                    <label><input type="checkbox" name="veh_oil"> Oil</label>
                    <label><input type="checkbox" name="veh_fuel"> Fuel</label>
                    <label><input type="checkbox" name="veh_washer"> Washer fluid</label>
                    <label><input type="checkbox" name="veh_lights"> Lights</label>
                    <label><input type="checkbox" name="veh_tiedowns"> Tie-Down Straps</label>
                    <label>Other: <input type="text" name="veh_other" style="width:120px;"></label>
                  </div>
                </td>
              </tr>
              <tr>
                <td>ATV / Snowmobile</td>
                <td>
                  <div class="inline-checkbox-group">
                    <label><input type="checkbox" name="atv_tires"> Tires/Track</label>
                    <label><input type="checkbox" name="atv_oil_fuel"> Oil/Fuel</label>
                    <label><input type="checkbox" name="atv_lights"> Lights</label>
                    <label><input type="checkbox" name="atv_brakes"> Brakes</label>
                  </div>
                </td>
              </tr>
              <tr>
                <td>Generator</td>
                <td>
                  <div class="inline-checkbox-group">
                    <label><input type="checkbox" name="gen_oil"> Oil</label>
                    <label><input type="checkbox" name="gen_fuel"> Fuel</label>
                    <label><input type="checkbox" name="gen_cord"> Extension Cord</label>
                  </div>
                </td>
              </tr>
              <tr>
                <td>Chainsaw (if used)</td>
                <td>
                  <div class="inline-checkbox-group">
                    <label><input type="checkbox" name="saw_oil"> Oil</label>
                    <label><input type="checkbox" name="saw_fuel"> Fuel</label>
                    <label><input type="checkbox" name="saw_chain"> Chain</label>
                    <label><input type="checkbox" name="saw_guard"> Guard</label>
                    <label>Other: <input type="text" name="saw_other" style="width:120px;"></label>
                  </div>
                </td>
              </tr>
              <tr>
                <td>Trailer</td>
                <td>
                  <div class="inline-checkbox-group">
                    <label><input type="checkbox" name="trl_tires"> Tires</label>
                    <label><input type="checkbox" name="trl_lights"> Lights</label>
                    <label><input type="checkbox" name="trl_chains"> Safety Chains</label>
                    <label><input type="checkbox" name="trl_deck"> Deck</label>
                    <label><input type="checkbox" name="trl_plate"> Licence Plate</label>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- PPE -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Personal Protective Equipment</div>
            <div class="section-note">Check off required PPE; report missing or worn items as needed.</div>
          </div>

          <div class="inline-checkbox-group">
            <label><input type="checkbox" name="ppe_hardhat"> Hardhat</label>
            <label><input type="checkbox" name="ppe_atv_helmet"> ATV Helmets</label>
            <label><input type="checkbox" name="ppe_signs"> Signs</label>
            <label><input type="checkbox" name="ppe_eye"> Eye Protection</label>
            <label><input type="checkbox" name="ppe_gloves"> Gloves</label>
            <label><input type="checkbox" name="ppe_csa_footwear"> CSA Approved Footwear</label>
            <label><input type="checkbox" name="ppe_winter"> Winter Clothing</label>
            <label><input type="checkbox" name="ppe_reflective"> Reflective Clothing</label>
            <label><input type="checkbox" name="ppe_frc"> Fire Retardant Coveralls</label>
            <label><input type="checkbox" name="ppe_hearing"> Hearing Protection</label>
            <label><input type="checkbox" name="ppe_chaps"> Chainsaw Pants/Chaps</label>
            <label><input type="checkbox" name="ppe_first_aid"> Personal First Aid Kit</label>
            <label><input type="checkbox" name="ppe_gas_monitor"> H2S, Methane, Oxygen, CO Monitor</label>
            <label>Other: <input type="text" name="ppe_other" style="width:160px;"></label>
          </div>
        </div>

      </div>
    </div>

    <!-- PAGE 2 -->
    <div class="container" id="page2">
      <div class="page-title-bar">
        <div class="page-title-main">Job Tasks, Hazards &amp; Controls</div>
        <div class="page-title-sub">Controls and ratings auto-suggest. R auto-calculates from F × S × P.</div>
        <div class="page-title-accent"></div>
      </div>

      <div class="page-body">

        <!-- Common Occurring Hazards -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Common Occurring Hazards</div>
            <div class="section-note">Unchecked rows are removed from the PDF to eliminate blank space.</div>
          </div>

          <table id="commonHazardsTable">
            <thead>
              <tr>
                <th class="center">Applies</th>
                <th>Hazard</th>
                <th>Controls (from Worksite Hazard Assessment)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="center"><input type="checkbox" name="haz_buried_overhead"></td>
                <td>Buried or Overhead Facilities</td>
                <td>Use caution around utilities, maintain limits of approach, confirm locates before digging or probing, and report damage immediately.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_hunting"></td>
                <td>Hunting Season</td>
                <td>Know season dates, stay together, make noise, wear hi-vis, and avoid active hunting areas.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_housekeeping"></td>
                <td>Site Housekeeping</td>
                <td>Keep work areas clear of debris and obstructions. Maintain safe access/egress and remove trip hazards as you go.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_h2s"></td>
                <td>H2S Concerns</td>
                <td>Do not work in H2S areas without training and a working monitor. Follow emergency procedures and evacuate on alarm.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_open_excavation"></td>
                <td>Open Excavation</td>
                <td>Stay back from edges, use designated crossings, never jump trenches, and keep gear away from edges. PPE: hardhat, CSA boots.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_fences"></td>
                <td>
                  Construction Fences – Installed
                  <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                    <input type="checkbox" name="fence_installed_yes"> Yes
                  </label>
                  <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                    <input type="checkbox" name="fence_installed_no"> No
                  </label>
                </td>
                <td>Use gates/crossings, watch bases and trip hazards, and keep clear when panels move. Use caution in high winds.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_wild_animals"></td>
                <td>Wild Animals</td>
                <td>Stay alert, keep distance, store food/garbage, carry bear spray where required, and leave if wildlife is near.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_river"></td>
                <td>River: High/Low Spring Flood</td>
                <td>Keep back from banks and moving water, avoid undercut edges, use safe crossings, and stop work if unsafe.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_traffic"></td>
                <td>On and Off Traffic or Construction</td>
                <td>Wear hi-vis, keep setups out of travel paths, make eye contact with operators, and use cones/signs as needed.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_icy"></td>
                <td>Icy Conditions</td>
                <td>Use slip-resistant footwear, slow down, keep hands free, and avoid icy slopes and unstable edges.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_noise"></td>
                <td>Excessive Noise Levels</td>
                <td>Limit exposure, use hearing protection, establish clear communication, and stay alert to surroundings.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_wildfire"></td>
                <td>
                  Wild Fire Hazard – Fire Ban in Effect
                  <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                    <input type="checkbox" name="fireban_yes"> Yes
                  </label>
                  <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                    <input type="checkbox" name="fireban_no"> No
                  </label>
                </td>
                <td>Follow fire-ban rules, avoid ignition sources, keep extinguishers available, and report smoke or fire immediately.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_farming"></td>
                <td>Farming Operations (cattle or other animals)</td>
                <td>Make your presence known, give livestock space, and reroute if animals appear stressed or aggressive.</td>
              </tr>
              <tr>
                <td class="center"><input type="checkbox" name="haz_landowner"></td>
                <td>
                  Land Owner / Home Owner – Made Contact
                  <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                    <input type="checkbox" name="landowner_yes"> Yes
                  </label>
                  <label style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;font-weight:500;">
                    <input type="checkbox" name="landowner_no"> No
                  </label>
                </td>
                <td>Stay calm and respectful. Do not argue. If conflict escalates, leave the area and report to supervisor and client contact.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Job Specific Hazards -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">Job Specific Hazards</div>
            <div class="section-note">If hazard is cleared, the control and ratings clear. Controls stay ≤ 185 characters.</div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Job Tasks</th>
                <th>Hazards</th>
                <th class="center">F</th>
                <th class="center">S</th>
                <th class="center">P</th>
                <th class="center">R</th>
                <th>Control Plan / Barriers / Procedures</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="text" name="task_1" /></td>
                <td><input type="text" name="hazard_1" placeholder="e.g. construction traffic, construction fencing, generator, digging pins" /></td>
                <td class="center"><input type="text" name="f_1" class="risk-input" data-row="1" style="width:32px;"></td>
                <td class="center"><input type="text" name="s_1" class="risk-input" data-row="1" style="width:32px;"></td>
                <td class="center"><input type="text" name="p_1" class="risk-input" data-row="1" style="width:32px;"></td>
                <td class="center"><input type="text" name="r_1" class="risk-output" data-row="1" style="width:40px;" readonly></td>
                <td><textarea name="control_1" class="control-text" placeholder="Controls will auto-suggest when you leave the hazard cell."></textarea></td>
              </tr>

              <tr>
                <td><input type="text" name="task_2" /></td>
                <td><input type="text" name="hazard_2" /></td>
                <td class="center"><input type="text" name="f_2" class="risk-input" data-row="2" style="width:32px;"></td>
                <td class="center"><input type="text" name="s_2" class="risk-input" data-row="2" style="width:32px;"></td>
                <td class="center"><input type="text" name="p_2" class="risk-input" data-row="2" style="width:32px;"></td>
                <td class="center"><input type="text" name="r_2" class="risk-output" data-row="2" style="width:40px;" readonly></td>
                <td><textarea name="control_2" class="control-text"></textarea></td>
              </tr>

              <tr>
                <td><input type="text" name="task_3" /></td>
                <td><input type="text" name="hazard_3" /></td>
                <td class="center"><input type="text" name="f_3" class="risk-input" data-row="3" style="width:32px;"></td>
                <td class="center"><input type="text" name="s_3" class="risk-input" data-row="3" style="width:32px;"></td>
                <td class="center"><input type="text" name="p_3" class="risk-input" data-row="3" style="width:32px;"></td>
                <td class="center"><input type="text" name="r_3" class="risk-output" data-row="3" style="width:40px;" readonly></td>
                <td><textarea name="control_3" class="control-text"></textarea></td>
              </tr>

              <tr>
                <td><input type="text" name="task_4" /></td>
                <td><input type="text" name="hazard_4" /></td>
                <td class="center"><input type="text" name="f_4" class="risk-input" data-row="4" style="width:32px;"></td>
                <td class="center"><input type="text" name="s_4" class="risk-input" data-row="4" style="width:32px;"></td>
                <td class="center"><input type="text" name="p_4" class="risk-input" data-row="4" style="width:32px;"></td>
                <td class="center"><input type="text" name="r_4" class="risk-output" data-row="4" style="width:40px;" readonly></td>
                <td><textarea name="control_4" class="control-text"></textarea></td>
              </tr>

              <tr>
                <td><input type="text" name="task_5" /></td>
                <td><input type="text" name="hazard_5" /></td>
                <td class="center"><input type="text" name="f_5" class="risk-input" data-row="5" style="width:32px;"></td>
                <td class="center"><input type="text" name="s_5" class="risk-input" data-row="5" style="width:32px;"></td>
                <td class="center"><input type="text" name="p_5" class="risk-input" data-row="5" style="width:32px;"></td>
                <td class="center"><input type="text" name="r_5" class="risk-output" data-row="5" style="width:40px;" readonly></td>
                <td><textarea name="control_5" class="control-text"></textarea></td>
              </tr>

              <tr>
                <td><input type="text" name="task_6" /></td>
                <td><input type="text" name="hazard_6" /></td>
                <td class="center"><input type="text" name="f_6" class="risk-input" data-row="6" style="width:32px;"></td>
                <td class="center"><input type="text" name="s_6" class="risk-input" data-row="6" style="width:32px;"></td>
                <td class="center"><input type="text" name="p_6" class="risk-input" data-row="6" style="width:32px;"></td>
                <td class="center"><input type="text" name="r_6" class="risk-output" data-row="6" style="width:40px;" readonly></td>
                <td><textarea name="control_6" class="control-text"></textarea></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Emergency Response -->
        <div class="section-card">
          <div class="section-header"><div class="section-title">Emergency Response Plan</div></div>

          <div class="row">
            <div><label for="nearest_hospital">Nearest first aid facility or hospital</label><input type="text" id="nearest_hospital" name="nearest_hospital"></div>
            <div><label for="hospital_phone">Phone #</label><input type="text" id="hospital_phone" name="hospital_phone"></div>
          </div>

          <div style="margin-top:4px;">
            <label for="emergency_procedures">Emergency Response Procedures</label>
            <textarea id="emergency_procedures" name="emergency_procedures"></textarea>
          </div>

          <div style="margin-top:4px;">
            <div class="inline-checkbox-group">
              <label><input type="checkbox" name="first_aid_available"> First Aid Kit Available</label>
              <label><input type="checkbox" name="fire_ext_available"> Fire Extinguisher Available</label>
              <label><input type="checkbox" name="effective_comm"> Effective Method of Communication Available</label>
            </div>
          </div>
        </div>

        <!-- Signatures -->
        <div class="section-card">
          <div class="section-header"><div class="section-title">Acknowledgement &amp; Sign-off</div></div>

          <div class="signature-grid">

            <div class="signature-box">
              <div class="signature-label">Party Chief – Signature</div>
              <canvas id="pcSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearPcSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="pc_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="pc_date"></div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Rodman – Signature</div>
              <canvas id="saSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearSaSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="sa_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="sa_date"></div>
              </div>
            </div>

            <div class="signature-box">
              <div class="signature-label">Client Representative / Safety Coordinator / Additional Rodman – Signature</div>
              <canvas id="clientSignature" class="signature-canvas"></canvas>
              <div class="signature-actions"><button type="button" class="btn-secondary" id="clearClientSig">Clear</button></div>
              <div class="signature-row">
                <div><div class="signature-label">Name</div><input type="text" class="small-input" name="client_name"></div>
                <div><div class="signature-label">Date</div><input type="date" class="small-input" name="client_date"></div>
              </div>
            </div>

          </div>

          <div style="margin-top:6px;">
            <label for="crew_contact">Crew Contact No.</label>
            <input type="text" id="crew_contact" name="crew_contact">
          </div>

          <div class="btn-row" id="buttonRow">
            <button type="reset" class="btn-secondary" id="resetBtn">Reset</button>
            <button type="button" class="btn-primary" id="downloadBtn">Download PDF</button>
            <button type="button" class="btn-secondary" id="shareBtn">Share PDF</button>
          </div>

          <div class="small-text" style="margin-top:6px;text-align:right;">Version 3.4</div>
        </div>

      </div>
    </div>

  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  const downloadBtn = document.getElementById('downloadBtn');
  const shareBtn    = document.getElementById('shareBtn');
  const buttonRow   = document.getElementById('buttonRow');

  /* ===================== FILE NAME (iPad + PC) ===================== */
  function sanitizeFileName(name) {
    const cleaned = String(name || "")
      .trim()
      .replace(/[\\/:*?"<>|]+/g, "_")
      .replace(/\s+/g, " ")
      .slice(0, 80);
    return cleaned || "WorksiteHazardAssessment";
  }

  function defaultFileNameBase() {
    const job = (document.querySelector('input[name="job_number"]')?.value || "").trim();
    const loc = (document.querySelector('input[name="location"]')?.value || "").trim();
    const date = (document.querySelector('input[name="date"]')?.value || "").trim();
    const parts = ["WorksiteHazardAssessment"];
    if (job) parts.push("Job_" + job);
    if (loc) parts.push(loc);
    if (date) parts.push(date);
    return sanitizeFileName(parts.join(" - "));
  }

  function askForFileName() {
    const suggested = defaultFileNameBase();
    const input = window.prompt("File name for the PDF:", suggested);
    return sanitizeFileName(input || suggested) + ".pdf";
  }

  /* ===================== RISK CALC ===================== */
  function updateRiskForRow(row) {
    const fInput = document.querySelector('input[name="f_' + row + '"]');
    const sInput = document.querySelector('input[name="s_' + row + '"]');
    const pInput = document.querySelector('input[name="p_' + row + '"]');
    const rInput = document.querySelector('input[name="r_' + row + '"]');
    if (!fInput || !sInput || !pInput || !rInput) return;

    const f = parseInt(fInput.value, 10);
    const s = parseInt(sInput.value, 10);
    const p = parseInt(pInput.value, 10);

    if (Number.isInteger(f) && Number.isInteger(s) && Number.isInteger(p)) rInput.value = f * s * p;
    else rInput.value = "";
  }

  function clearRowControlsAndRatings(row) {
    const c = document.querySelector(`textarea[name="control_${row}"]`);
    const f = document.querySelector(`input[name="f_${row}"]`);
    const s = document.querySelector(`input[name="s_${row}"]`);
    const p = document.querySelector(`input[name="p_${row}"]`);
    const r = document.querySelector(`input[name="r_${row}"]`);
    if (c) c.value = "";
    if (f) f.value = "";
    if (s) s.value = "";
    if (p) p.value = "";
    if (r) r.value = "";
  }

  document.querySelectorAll('.risk-input').forEach(input => {
    input.addEventListener('input', () => {
      const row = input.getAttribute('data-row');
      if (row) updateRiskForRow(row);
    });
  });

  /* ===================== EXPORT HELPERS ===================== */
  function syncLiveValuesToClone(originalForm, cloneForm) {
    const getKey = (el) => el.name || el.id;

    const origEls = Array.from(originalForm.querySelectorAll("input, textarea, select"));
    const cloneMap = new Map();
    Array.from(cloneForm.querySelectorAll("input, textarea, select")).forEach(el => {
      const key = getKey(el);
      if (key) cloneMap.set(key, el);
    });

    origEls.forEach(orig => {
      const key = getKey(orig);
      if (!key) return;
      const cloneEl = cloneMap.get(key);
      if (!cloneEl) return;

      if (orig.type === "checkbox" || orig.type === "radio") {
        cloneEl.checked = orig.checked;
        if (orig.checked) cloneEl.setAttribute("checked", "checked");
        else cloneEl.removeAttribute("checked");
      } else {
        cloneEl.value = orig.value;
        cloneEl.setAttribute("value", orig.value);
        if (cloneEl.tagName.toLowerCase() === "textarea") cloneEl.textContent = orig.value;
      }
    });
  }

  function copyCanvasToCloneImage(originalCanvasId, cloneRoot) {
    const origCanvas = document.getElementById(originalCanvasId);
    const clonedCanvas = cloneRoot.querySelector('#' + originalCanvasId);
    if (!origCanvas || !clonedCanvas) return;

    try {
      const img = document.createElement('img');
      img.src = origCanvas.toDataURL('image/png');
      img.alt = "signature";
      img.style.width = "100%";
      img.style.height = "80px";
      img.style.borderRadius = "8px";
      img.style.border = "1px solid var(--border-soft)";
      img.style.background = "#fff";
      img.style.display = "block";
      clonedCanvas.replaceWith(img);
    } catch (e) {}
  }

  function replaceTextareasForPrint(cloneRoot) {
    const textareas = Array.from(cloneRoot.querySelectorAll("textarea"));
    textareas.forEach(ta => {
      const div = document.createElement("div");
      div.className = "print-textarea";
      div.textContent = ta.value || ta.textContent || "";
      ta.replaceWith(div);
    });
  }

  function createFilteredFormClone() {
    const form = document.getElementById('hazardForm');
    const clone = form.cloneNode(true);

    // critical: copy live values into clone so export includes tasks/hazards/ratings/controls
    syncLiveValuesToClone(form, clone);

    // signatures -> images
    copyCanvasToCloneImage('pcSignature', clone);
    copyCanvasToCloneImage('saSignature', clone);
    copyCanvasToCloneImage('clientSignature', clone);

    // remove unchecked common hazard rows
    const commonTableBody = clone.querySelector('#commonHazardsTable tbody');
    if (commonTableBody) {
      Array.from(commonTableBody.rows).forEach(row => {
        const appliesCheckbox = row.querySelector('td:first-child input[type="checkbox"]');
        if (appliesCheckbox && !appliesCheckbox.checked) commonTableBody.removeChild(row);
      });
    }

    // hide buttons
    const clonedButtonRow = clone.querySelector('#buttonRow');
    if (clonedButtonRow) clonedButtonRow.style.display = 'none';

    // make textarea content always appear in export
    replaceTextareasForPrint(clone);

    return clone;
  }

  async function generatePdf() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'legal');

    const clone = createFilteredFormClone();

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.style.width = '1050px';
    tempContainer.appendChild(clone);
    document.body.appendChild(tempContainer);

    const clonePage1 = clone.querySelector('#page1');
    const clonePage2 = clone.querySelector('#page2');

    async function addPage(div, addNew) {
      if (!div) return;
      if (addNew) pdf.addPage();

      const canvas = await html2canvas(div, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff"
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 8;

      let imgW = pageWidth - margin * 2;
      let imgH = canvas.height * (imgW / canvas.width);

      if (imgH > pageHeight - margin * 2) {
        imgH = pageHeight - margin * 2;
        imgW = canvas.width * (imgH / canvas.height);
      }

      const x = (pageWidth - imgW) / 2;
      const y = margin;
      pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH);
    }

    await addPage(clonePage1, false);
    await addPage(clonePage2, true);

    document.body.removeChild(tempContainer);
    return pdf;
  }

  downloadBtn.addEventListener('click', async () => {
    const filename = askForFileName();
    try {
      if (buttonRow) buttonRow.style.display = 'none';
      const pdf = await generatePdf();
      pdf.save(filename);
    } finally {
      if (buttonRow) buttonRow.style.display = 'flex';
    }
  });

  shareBtn.addEventListener('click', async () => {
    const filename = askForFileName();
    try {
      if (buttonRow) buttonRow.style.display = 'none';
      const pdf = await generatePdf();
      const blob = pdf.output('blob');
      const file = new File([blob], filename, { type: 'application/pdf' });

      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: 'Worksite Hazard Assessment',
          text: 'VistaGeomatics – Worksite Hazard Assessment PDF'
        });
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
    } catch (e) {
      console.error('Share failed:', e);
    } finally {
      if (buttonRow) buttonRow.style.display = 'flex';
    }
  });

  /* ===================== SIGNATURES ===================== */
  function initSignaturePad(canvasId, clearButtonId) {
    const canvas = document.getElementById(canvasId);
    const clearBtn = document.getElementById(clearButtonId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let drawing = false, lastX = 0, lastY = 0;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111827';
      ctx.clearRect(0, 0, rect.width, rect.height);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function startDraw(x, y){ drawing = true; lastX = x; lastY = y; }
    function drawLine(x, y){
      if (!drawing) return;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x; lastY = y;
    }
    function endDraw(){ drawing = false; }

    canvas.addEventListener('mousedown', e => {
      const rect = canvas.getBoundingClientRect();
      startDraw(e.clientX - rect.left, e.clientY - rect.top);
    });
    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      drawLine(e.clientX - rect.left, e.clientY - rect.top);
    });
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const t = e.touches[0];
      startDraw(t.clientX - rect.left, t.clientY - rect.top);
    }, { passive:false });

    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const t = e.touches[0];
      drawLine(t.clientX - rect.left, t.clientY - rect.top);
    }, { passive:false });

    canvas.addEventListener('touchend', e => { e.preventDefault(); endDraw(); }, { passive:false });

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, rect.width, rect.height);
      });
    }
  }

  initSignaturePad('pcSignature', 'clearPcSig');
  initSignaturePad('saSignature', 'clearSaSig');
  initSignaturePad('clientSignature', 'clearClientSig');

  document.getElementById('resetBtn').addEventListener('click', () => {
    ['pcSignature','saSignature','clientSignature'].forEach(id => {
      const canvas = document.getElementById(id);
      if (canvas) {
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, rect.width, rect.height);
      }
    });
    document.querySelectorAll('.risk-output').forEach(o => o.value = "");
  });

  /* ===================== HAZARD RULE ENGINE (plural-aware) ===================== */
  const ALLOW_SHORT = new Set(["h2s","uv","sds","pfd","gps","gnss","scba","sabe","co"]);

  function normalize(text) {
    return (text || '')
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function clamp185(s) {
    const str = String(s || "").trim();
    if (str.length <= 185) return str;
    return str.slice(0, 182).trimEnd() + "...";
  }

  // Simple plural/singular variants (fast + offline)
  function wordVariants(w) {
    w = (w || "").trim();
    if (!w) return [];
    const out = new Set([w]);

    // singularize common plurals
    if (w.endsWith("ies") && w.length > 4) out.add(w.slice(0, -3) + "y");           // batteries -> battery
    if (w.endsWith("es") && w.length > 3) out.add(w.slice(0, -2));                  // fences -> fence
    if (w.endsWith("s") && !w.endsWith("ss") && w.length > 2) out.add(w.slice(0, -1)); // dogs -> dog

    // pluralize
    if (w.endsWith("y") && w.length > 2) out.add(w.slice(0, -1) + "ies");           // battery -> batteries
    out.add(w + "s");                                                               // dog -> dogs
    out.add(w + "es");                                                              // fence -> fences
    return Array.from(out);
  }

  function tokenize(text) {
    const t = normalize(text);
    if (!t) return [];
    const base = t.split(' ').filter(Boolean);

    const expanded = new Set();
    base.forEach(tok => {
      wordVariants(tok).forEach(v => expanded.add(v));
    });

    return Array.from(expanded);
  }

  const hazardRules = [
    { name:"Construction Traffic", keywords:"construction traffic,site traffic,haul truck,haul trucks,dump truck,dump trucks,delivery truck,delivery trucks,flagger,flagging,traffic control,backing,reversing,blind spot,swing radius,work zone", control:"Stay out of travel paths and swing radii. Wear hi-vis, use cones/signs if needed, use a spotter for backing, and make eye contact with operators.", f:3,s:4,p:3 },
    { name:"Construction Fencing", keywords:"construction fencing,construction fence,temp fence,temporary fence,fence panel,fence panels,fence base,fence bases,site perimeter,gate,gates,barricade,barricades", control:"Use gates and crossings, watch bases and trip hazards, and keep clear when panels move. In wind, keep distance and do not lean on fencing.", f:2,s:3,p:3 },
    { name:"Portable Generators", keywords:"generator,generators,portable generator,genset,genny,exhaust,carbon monoxide,extension cord,extension cords,cord,cords,fueling,refuel,gas can", control:"Run outdoors away from openings. Route cords to prevent trips. Refuel only when off and cooled, and store fuel safely.", f:2,s:5,p:2 },
    { name:"Traffic & Vehicles", keywords:"traffic,road,roads,highway,lane,lanes,shoulder,intersection,crosswalk,parking lot,alley,backing,reversing,vehicle,vehicles,truck,trucks,bus,buses", control:"Work clear of live lanes and vehicle routes. Wear hi-vis, face traffic, use cones/signs if needed, and use a spotter for backing.", f:3,s:4,p:3 },
    { name:"Slips / Trips / Falls", keywords:"slip,slips,trip,trips,fall,falls,uneven ground,slippery,ice,icy,snow,mud,ditch,ditches,embankment,hole,holes,rut,ruts,loose gravel,wet grass,stairs,curb,sidewalk", control:"Walk the area first and avoid unstable footing. Use slip-resistant footwear, keep hands free, set tripods on firm ground, and keep paths clear.", f:3,s:3,p:3 },
    { name:"Cold Weather", keywords:"cold,cold weather,freezing,winter,windchill,frostbite,hypothermia,blizzard,snowstorm,below zero", control:"Dress in layers, cover exposed skin, and take warm-up breaks. Monitor for cold stress and shorten tasks in extreme cold or windchill.", f:3,s:4,p:2 },
    { name:"Rain / Wet Conditions", keywords:"rain,raining,wet,drizzle,downpour,puddles,slippery when wet,wet ladder,wet stairs", control:"Wear waterproof layers and slip-resistant footwear. Slow down on wet surfaces and avoid steep or unstable areas with poor footing.", f:3,s:3,p:3 },
    { name:"Wind / Low Visibility", keywords:"wind,windy,gust,gusts,blowing snow,dust,dust storm,fog,foggy,smoke,wildfire smoke,low visibility", control:"Secure tripods and loose items and use lower, wider setups. Delay work if wind, smoke, or visibility makes conditions unsafe.", f:3,s:3,p:3 },
    { name:"Utilities", keywords:"utilities,utility,overhead,underground,locate,locates,power line,powerlines,gas line,pipeline,telecom,fibre,fiber,manhole,vault,transformer", control:"Confirm locates and mark-outs before work. Maintain limits of approach and do not dig, stake, or probe without verified clearance.", f:2,s:5,p:2 },
    { name:"Digging / Pins", keywords:"digging,dig,excavation,excavations,trench,trenches,auger,post hole,digging pin,digging pins,pin,pins", control:"Confirm locates before digging or using pins. Hand dig near marks, keep people back from edges, and stop if utility locations are uncertain.", f:2,s:5,p:2 },
    { name:"Jackhammer", keywords:"jackhammer,breaker,demolition hammer,concrete,pavement,chipping,vibration,noise", control:"Wear eye and hearing protection and use stable footing. Control flying debris, confirm utilities below, and take breaks to reduce vibration exposure.", f:2,s:4,p:2 },
    { name:"Dogs", keywords:"dog,dogs,aggressive dog,aggressive dogs,loose dog,loose dogs,barking dog,barking dogs,guard dog,guard dogs", control:"Do not approach unknown or aggressive dogs. Ask the owner to secure the dog and do not enter until the area is clearly safe.", f:2,s:3,p:3 },
    { name:"Wildlife", keywords:"wildlife,bear,bears,moose,coyote,coyotes,cougar,cougars,wolf,wolves,elk,deer,goose,geese", control:"Stay alert, keep distance, secure food and garbage, carry bear spray where required, and leave if wildlife is near or unpredictable.", f:2,s:5,p:2 },
    { name:"H2S / Gas", keywords:"h2s,hydrogen sulfide,hydrogen sulphide,methane,toxic gas,gas monitor,alarm,oxygen deficiency,confined space", control:"Do not work in H2S or hazardous atmospheres without training and a working monitor. Follow emergency procedures and evacuate on alarm.", f:2,s:5,p:2 },
    { name:"Housekeeping / Storage", keywords:"housekeeping,access,egress,material storage,stored,stacked,blocking,walkway,walkways,aisle,aisles,debris", control:"Keep access and egress clear. Store materials safely and maintain housekeeping. Remove trip hazards and improve lighting if needed.", f:3,s:3,p:3 }
  ].map(r => ({ ...r, control: clamp185(r.control) }));

  function scoreRule(rule, text, tokens) {
    const kList = (rule.keywords || "")
      .split(',')
      .map(k => normalize(k.trim()))
      .filter(Boolean);

    let score = 0;
    const tokenSet = new Set(tokens);

    for (const kw of kList) {
      if (!kw) continue;
      if (kw.length <= 2) continue;
      if (kw.length === 3 && !ALLOW_SHORT.has(kw)) continue;

      // Phrase keyword
      if (kw.includes(' ')) {
        if (text.includes(kw)) { score += 12; continue; }

        const parts = kw.split(' ').filter(Boolean);
        let allParts = true;

        for (const p of parts) {
          const pv = wordVariants(p);
          const hasAny = pv.some(v => tokenSet.has(v));
          if (!hasAny) { allParts = false; break; }
        }

        if (allParts) score += 7;
        continue;
      }

      // Single word keyword: plural-aware
      const kwVars = wordVariants(kw);
      if (kwVars.some(v => tokenSet.has(v))) {
        score += 6;
        continue;
      }

      if (kw.length >= 5 && text.includes(kw)) score += 2;
    }

    return score;
  }

  function bestRuleMatch(hazardText) {
    const text = normalize(hazardText);
    if (!text) return null;
    const tokens = tokenize(text);

    let best = null;
    let bestScore = 0;

    for (const rule of hazardRules) {
      const s = scoreRule(rule, text, tokens);
      if (s > bestScore) { bestScore = s; best = rule; }
    }

    return bestScore > 0 ? best : null;
  }

  function autofillRiskIfBlank(row, rule) {
    if (!rule) return;

    const fEl = document.querySelector(`input[name="f_${row}"]`);
    const sEl = document.querySelector(`input[name="s_${row}"]`);
    const pEl = document.querySelector(`input[name="p_${row}"]`);
    if (!fEl || !sEl || !pEl) return;

    const isBlank = (el) => !String(el.value || "").trim();

    if (isBlank(fEl) && Number.isFinite(rule.f)) fEl.value = rule.f;
    if (isBlank(sEl) && Number.isFinite(rule.s)) sEl.value = rule.s;
    if (isBlank(pEl) && Number.isFinite(rule.p)) pEl.value = rule.p;

    updateRiskForRow(row);
  }

  function initHazardAutoSuggest() {
    document.querySelectorAll('input[name^="hazard_"]').forEach(input => {

      // Clear controls + ratings when hazard is cleared
      input.addEventListener('input', e => {
        const value = e.target.value.trim();
        const row = e.target.name.split('_')[1];
        if (!value) clearRowControlsAndRatings(row);
      });

      // Suggest control + auto-fill F/S/P (if blank) on blur
      input.addEventListener('blur', e => {
        const hazardText = e.target.value.trim();
        const row = e.target.name.split('_')[1];
        const controlField = document.querySelector(`textarea[name="control_${row}"]`);
        if (!controlField) return;

        if (!hazardText) {
          clearRowControlsAndRatings(row);
          return;
        }

        const rule = bestRuleMatch(hazardText);

        // only overwrite if user hasn't already entered a long custom control
        if (!(controlField.value && controlField.value.trim().length > 40)) {
          if (rule && rule.control) controlField.value = clamp185(rule.control);
        }

        autofillRiskIfBlank(row, rule);
      });
    });
  }
  initHazardAutoSuggest();
</script>
</body>
</html>
